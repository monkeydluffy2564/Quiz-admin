<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator By Kru Amorn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Libraries for Exporting & Charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Libraries for File Reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.18/mammoth.browser.min.js"></script>

    <!-- MathJax for rendering math formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .main-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .generation-tab.active {
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Presentation Mode Styles */
        .presentation-option {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        #presentation-modal:fullscreen {
            background-color: #1f2937; /* bg-gray-800 */
        }
        /* Timer Bar */
        #timer-bar-container {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        #timer-bar {
            height: 100%;
            background-color: #4f46e5;
            transition: width 1s linear;
        }
        [contenteditable="true"] {
            outline: 2px dashed #4f46e5;
            background-color: #eef2ff;
            padding: 2px;
        }
        .details-marker {
            transition: transform 0.2s;
        }
        details[open] .details-marker {
            transform: rotate(90deg);
        }
        .badge-icon {
            animation: popIn 0.5s ease-out forwards;
            transform: scale(0);
        }
        @keyframes popIn {
            0% { transform: scale(0); }
            80% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .delete-svg-btn {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .delete-svg-btn:hover {
            opacity: 1;
        }
        /* Live Game Styles */
        .live-game-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .podium-step {
            transition: transform 0.5s ease-out;
        }
        .podium-step:hover {
            transform: translateY(-10px);
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-6xl relative">
        <!-- Admin Mode Toggle Button -->
        <button id="mode-switcher-btn" class="absolute top-4 right-4 text-gray-500 hover:text-indigo-600 transition-colors duration-300 z-10 p-3 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="สลับไปโหมดผู้ควบคุม">
            <i class="fas fa-user-shield fa-lg"></i>
        </button>

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">
                <i class="fas fa-brain mr-2"></i>AI Quiz Generator
            </h1>
            <p class="text-lg text-gray-600 mt-1">By Kru Amorn</p>
            <p class="text-gray-500 mt-2">สร้างโปรเจค จัดการแบบทดสอบ และติดตามผลนักเรียน</p>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="bg-white p-6 rounded-2xl shadow-lg min-h-[400px]">
            <!-- Admin View -->
            <div id="admin-view" class="hidden fade-in">
                <!-- Project Dashboard (Default Admin View) -->
                <div id="project-dashboard-view">
                    <!-- NEW: Starred Quizzes Section -->
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-indigo-700">โปรเจคทั้งหมด</h2>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                           <input type="text" id="project-search-input" placeholder="ค้นหาโปรเจค..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                           <select id="project-sort-select" class="p-2 border border-gray-300 rounded-lg">
                               <option value="date_desc">ใหม่ล่าสุด</option>
                               <option value="date_asc">เก่าที่สุด</option>
                               <option value="name_asc">ชื่อ (ก-ฮ)</option>
                               <option value="name_desc">ชื่อ (ฮ-ก)</option>
                           </select>
                           <button id="create-project-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300 flex items-center shrink-0">
                               <i class="fas fa-plus-circle mr-2"></i>สร้าง
                           </button>
						   <button id="open-global-live-btn"
  class="bg-purple-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-purple-700 transition-all duration-300 flex items-center shrink-0">
  <i class="fas fa-bolt mr-2"></i>Live Game
</button>
                        </div>
                    </div>
                    <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Project cards will be inserted here -->
                        <p id="no-projects-msg" class="text-gray-500 col-span-full text-center py-8">ยังไม่มีโปรเจค... คลิก 'สร้าง' เพื่อเริ่มต้น</p>
                    </div>
                </div>

                <!-- Project Detail View -->
                <div id="project-detail-view" class="hidden">
                    <button id="back-to-dashboard-btn" class="mb-4 text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>กลับไปหน้า Dashboard</button>
                    <h2 id="project-title" class="text-3xl font-bold text-indigo-700 mb-2"></h2>
                    <p class="text-sm text-gray-500 mb-6">Project ID: <span id="project-id-display" class="font-mono"></span></p>
                    
                    <!-- Project Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-6">
                            <button id="manage-tab" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                                <i class="fas fa-sliders-h mr-2"></i>จัดการ
                            </button>
                            <button id="results-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-poll mr-2"></i>ผลลัพธ์
                            </button>
                            <button id="leaderboard-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trophy mr-2"></i>ตารางผู้นำ
                            </button>
                        </nav>
                    </div>

                    <!-- Manage Tab Content -->
                    <div id="manage-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Left Column: Settings & Students -->
                            <div class="space-y-6">
                                <!-- Quiz Settings -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">ตั้งค่าแบบทดสอบ (สำหรับสร้างใหม่)</h3>
                                    <div class="space-y-4 p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <label for="quiz-type-select" class="block text-sm font-medium text-gray-700">ประเภทคำถาม:</label>
                                            <select id="quiz-type-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <optgroup label="ทั่วไป">
                                                    <option value="multiple_choice">แบบเลือกตอบ (ก, ข, ค, ง)</option>
                                                    <option value="matching">แบบจับคู่ (แยกข้อ)</option>
                                                    <option value="true_false">แบบถูก/ผิด</option>
                                                </optgroup>
                                                <optgroup label="แบบเติมคำ">
                                                    <option value="fill_in_with_choices">เติมคำ (มีตัวเลือกให้)</option>
                                                    <option value="fill_in_no_choices">เติมคำ (พิมพ์ตอบเอง)</option>
                                                    <option value="mixed">แบบผสม (เลือกตอบและเติมคำ)</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label for="num-questions" class="block text-sm font-medium text-gray-700">จำนวนข้อ:</label>
                                                <input type="number" id="num-questions" value="5" min="1" max="20" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                            <div>
                                                <label for="passing-score-input" class="block text-sm font-medium text-gray-700">คะแนนที่ผ่าน:</label>
                                                <input type="number" id="passing-score-input" value="3" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                        </div>
                                        <div id="num-choices-container">
                                            <label for="num-choices" class="block text-sm font-medium text-gray-700">จำนวนตัวเลือก:</label>
                                            <input type="number" id="num-choices" value="4" min="2" max="6" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                        </div>
                                        <div>
                                            <label for="shuffle-setting-select" class="block text-sm font-medium text-gray-700">การสลับข้อ/ตัวเลือก:</label>
                                            <select id="shuffle-setting-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <option value="none">ไม่สลับ</option>
                                                <option value="questions_only">สลับเฉพาะข้อ</option>
                                                <option value="choices_only">สลับเฉพาะตัวเลือก</option>
                                                <option value="both">สลับทั้งข้อและตัวเลือก</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="results-display-select" class="block text-sm font-medium text-gray-700">การแสดงผลให้นักเรียน:</label>
                                            <select id="results-display-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <option value="show_results_and_answers">ทราบคะแนนและเฉลยทันที</option>
                                                <option value="show_results_only">ทราบเฉพาะคะแนน (ไม่เห็นเฉลย)</option>
                                                <option value="manual_release">รอผู้ดูแลแจ้งผล</option>
                                            </select>
                                        </div>
                                        <!-- Adaptive Quiz Checkbox -->
                                        <div class="flex items-center mt-2">
                                            <input id="adaptive-quiz-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                            <label for="adaptive-quiz-checkbox" class="ml-2 block text-sm font-medium text-gray-900">
                                                เปิดใช้งานแบบทดสอบปรับพื้นฐาน
                                            </label>
                                        </div>
                                        <div class="border-t pt-4 mt-2">
                                            <label for="timer-mode-select" class="block text-sm font-medium text-gray-700">ตั้งค่าการจับเวลา:</label>
                                            <select id="timer-mode-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                                <option value="none">ไม่มีการจับเวลา</option>
                                                <option value="whole_quiz">จับเวลาทั้งแบบทดสอบ (นาที)</option>
                                                <option value="per_question">จับเวลาทีละข้อ (วินาที)</option>
                                            </select>
                                            <div id="timer-duration-container" class="mt-2 hidden">
                                                <label for="timer-duration-input" id="timer-duration-label" class="block text-sm font-medium text-gray-700">ระยะเวลา:</label>
                                                <input type="number" id="timer-duration-input" value="10" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                                            </div>
                                        </div>
                                        <button id="save-settings-btn" class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-teal-700 transition-colors text-sm">
                                            <i class="fas fa-save mr-2"></i>บันทึกการตั้งค่า
                                        </button>
                                    </div>
                                </div>
                                <!-- Student Management -->
                                <div>
                                    <h3 class="text-xl font-semibold mb-3 border-b pb-2">จัดการรายชื่อนักเรียน</h3>
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <div class="flex flex-col gap-2 mb-3">
                                            <label for="student-name-input" class="text-sm font-medium text-gray-700">เพิ่มรายชื่อนักเรียน (หนึ่งชื่อต่อหนึ่งบรรทัด):</label>
                                            <textarea id="student-name-input" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="สมชาย ใจดี&#10;สมศรี มีสุข"></textarea>
                                            <button id="add-student-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 self-end"><i class="fas fa-user-plus mr-2"></i>เพิ่มรายชื่อ</button>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="font-semibold text-sm">รายชื่อปัจจุบัน:</h4>
                                            <button id="delete-all-students-btn" class="text-red-600 hover:text-red-800 text-xs font-semibold py-1 px-2 rounded-md bg-red-100 hover:bg-red-200 transition-colors hidden"><i class="fas fa-trash-alt mr-1"></i>ลบทั้งหมด</button>
                                        </div>
                                        <div id="student-list" class="max-h-40 overflow-y-auto space-y-1 text-sm p-2 bg-white border rounded-md">
                                            <!-- Student names will be here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Quiz Generation -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3 border-b pb-2">สร้างแบบทดสอบใหม่</h3>
                                <div id="quiz-generation-container" class="p-4 bg-gray-50 rounded-lg">
                                    <!-- Generation Tabs -->
                                    <div class="flex border-b mb-4 flex-wrap">
                                        <button id="topic-tab" class="generation-tab py-2 px-4 font-semibold active"><i class="fas fa-lightbulb mr-2"></i>จากหัวข้อ</button>
                                        <button id="text-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-file-alt mr-2"></i>จากเนื้อหา</button>
                                        <button id="file-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-file-upload mr-2"></i>จากไฟล์</button>
                                        <button id="link-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-link mr-2"></i>จากลิงก์</button>
                                        <button id="worksheet-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-print mr-2"></i>สร้างใบงาน</button>
                                        <button id="bank-tab" class="generation-tab py-2 px-4 font-semibold text-gray-500"><i class="fas fa-university mr-2"></i>จากคลังข้อสอบ</button>
                                    </div>

                                    <!-- Question Bank Input -->
<div id="bank-input-area" class="hidden space-y-4">
    <!-- เนื้อหาคลังข้อสอบจะถูกสร้างโดย JavaScript -->
</div>

                                    <!-- NEW: Checkbox for including images -->
                                    <div class="flex items-center my-4">
                                        <input id="include-images-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="include-images-checkbox" class="ml-3 block text-sm font-medium text-gray-800">
                                            สร้างคำถามพร้อมรูปภาพ (สำหรับเรขาคณิต, กราฟ, ฯลฯ)
                                        </label>
                                    </div>
                                    <!-- Topic Input -->
                                    <div id="topic-input-area" class="space-y-4">
                                        <input type="text" id="topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น ทฤษฎีบทพีทาโกรัส">
                                        <button id="generate-from-topic-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-cogs mr-2"></i>สร้างแบบทดสอบ</button>
                                    </div>
                                    <!-- Text Input -->
                                    <div id="text-input-area" class="hidden space-y-4">
                                        <textarea id="text-content-input" rows="6" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="วางเนื้อหาที่นี่..."></textarea>
                                        <button id="generate-from-text-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-cogs mr-2"></i>สร้างแบบทดสอบ</button>
                                    </div>
                                    <!-- File Input -->
                                    <div id="file-input-area" class="hidden space-y-4">
                                        <label for="file-upload-input" class="block text-sm font-medium text-gray-700">เลือกไฟล์ PDF หรือ Word (.docx):</label>
                                        <input type="file" id="file-upload-input" class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept=".pdf,.docx">
                                        <p class="text-xs text-gray-500">ไฟล์จะถูกประมวลผลในเบราว์เซอร์ของคุณ ไม่มีการอัปโหลดขึ้นเซิร์ฟเวอร์</p>
                                    </div>
                                    <!-- Link Input -->
                                    <div id="link-input-area" class="hidden space-y-4">
                                        <input type="url" id="link-url-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="วาง URL ของบทความที่นี่...">
                                        <input type="text" id="link-topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ระบุหัวข้อ (เพื่อความแม่นยำ)...">
                                        <button id="generate-from-link-btn" class="w-full bg-cyan-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-cyan-700 flex items-center justify-center">
                                            <i class="fas fa-cogs mr-2"></i>ดึงข้อมูลและสร้างแบบทดสอบ
                                        </button>
                                    </div>
                                    <!-- Worksheet Input -->
                                    <div id="worksheet-input-area" class="hidden space-y-4">
                                        <input type="text" id="worksheet-topic-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="หัวข้อสำหรับสร้างใบงาน เช่น การบวกเลขสองหลัก">
                                        <button id="generate-worksheet-btn" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-emerald-700 flex items-center justify-center"><i class="fas fa-file-alt mr-2"></i>สร้างใบงานสำหรับพิมพ์</button>
                                    </div>
                                </div>
                                <!-- Generation Result Area -->
                                <div id="quiz-generation-area" class="mt-6 hidden">
                                    <div id="loader" class="flex flex-col items-center justify-center hidden">
                                        <div class="loader"></div>
                                        <p id="loader-text" class="mt-3 text-gray-600">กำลังสร้าง...</p>
                                    </div>
                                    <div id="generated-quiz-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Tab Content -->
                    <div id="results-tab-content" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">แบบทดสอบในโปรเจคนี้</h3>
                             <input type="text" id="quiz-search-input" placeholder="ค้นหาแบบทดสอบ..." class="w-full md:w-auto p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div id="project-quizzes-list" class="space-y-3">
                            <p class="text-gray-500">กำลังโหลดรายการแบบทดสอบ...</p>
                        </div>
                    </div>

                    <!-- Leaderboard Tab Content -->
                    <div id="leaderboard-tab-content" class="hidden">
                        <h3 class="text-xl font-semibold mb-4">ตารางผู้นำโปรเจค (คะแนนรวม)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-center w-16">อันดับ</th>
                                        <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                                        <th class="py-2 px-4 border-b text-center">คะแนนรวม (Points)</th>
                                        <th class="py-2 px-4 border-b text-left">ป้ายรางวัลที่ได้รับ</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-table-body">
                                    <!-- Leaderboard rows will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Quiz Detail/Results View -->
                <div id="quiz-results-view" class="hidden">
<div class="flex items-center gap-4 mb-4">
        <button id="back-to-project-btn" class="text-indigo-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>กลับไปหน้ารายละเอียดโปรเจค</button>

        <!-- --- นี่คือปุ่มใหม่ที่เพิ่มเข้ามา --- -->
        <button id="back-to-dashboard-from-results-btn" class="text-gray-500 hover:underline text-sm"><i class="fas fa-th-large mr-2"></i>กลับไปหน้า Dashboard</button>
    </div>

    <h2 id="results-quiz-title" class="text-3xl font-bold text-indigo-700 mb-2"></h2>
    <p class="text-sm text-gray-500 mb-4">Quiz ID: <span id="results-quiz-id-display" class="font-mono"></span></p>

                    <h2 id="results-quiz-title" class="text-3xl font-bold text-indigo-700 mb-2"></h2>

                       <!-- Quiz Detail Tabs -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-6">
                            <button id="analytics-tab-btn" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                                <i class="fas fa-chart-line mr-2"></i>วิเคราะห์ผล
                            </button>
                            <button id="scores-tab-btn" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-users mr-2"></i>คะแนนนักเรียน
                            </button>
                            <!-- NEW: Quiz Leaderboard Tab Button -->
                            <button id="leaderboard-quiz-tab-btn" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500 hover:text-gray-700">
                                <i class="fas fa-trophy mr-2"></i>ตารางผู้นำ
                            </button>
                        </nav>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="analytics-tab-content">
                        <!-- Summary Cards -->
                        <div id="analytics-summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <!-- Cards will be injected here -->
                        </div>
                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2 text-center">สถานะการส่งงาน</h4>
                                <canvas id="submission-status-chart"></canvas>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-2 text-center">การกระจายคะแนน</h4>
                                <canvas id="score-distribution-chart"></canvas>
                            </div>
                        </div>

                        <!-- NEW: AI Strength/Weakness Analysis Section -->
                        <div class="mt-8">
                            <h3 class="text-xl font-semibold mb-3 border-b pb-2">AI วิเคราะห์ภาพรวม</h3>
                            <div class="flex justify-center">
                                <button id="analyze-strengths-btn" class="bg-indigo-600 text-white py-2 px-5 rounded-lg font-semibold hover:bg-indigo-700 transition-all duration-300 flex items-center gap-2">
                                    <i class="fas fa-magic"></i>วิเคราะห์จุดแข็ง-จุดอ่อนของห้อง
                                </button>
                            </div>
                            <div id="strength-weakness-analysis-container" class="mt-4">
                                <!-- Analysis results will be displayed here -->
                            </div>
                        </div>

                        <!-- Per-Question Analysis -->
                        <div class="mt-8">
                             <h3 class="text-xl font-semibold mb-3 border-b pb-2">สถิติรายข้อ</h3>
                             <div id="question-analytics-container" class="space-y-4">
                                 <!-- Accordions will be injected here -->
                             </div>
                        </div>
                    </div>

                    <!-- Scores Tab -->
                    <div id="scores-tab-content" class="hidden">
                        <!-- Export Buttons -->
                        <div class="mb-4 flex flex-wrap gap-2">
                            <span class="self-center font-semibold mr-2">Export ผลลัพธ์:</span>
                            <button id="export-image-btn" class="bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 text-sm flex items-center gap-2"><i class="fas fa-file-image"></i>Image</button>
                            <button id="export-pdf-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm flex items-center gap-2"><i class="fas fa-file-pdf"></i>PDF</button>
                            <button id="export-word-btn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm flex items-center gap-2"><i class="fas fa-file-word"></i>Word</button>
                            <button id="export-excel-btn" class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fas fa-file-excel"></i>Excel</button>
                        </div>
                        <div class="overflow-x-auto" id="results-table-container">
                            <table class="min-w-full bg-white border border-gray-200" id="results-table">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                                        <th class="py-2 px-4 border-b text-left">คะแนนดีที่สุด</th>
                                        <th class="py-2 px-4 border-b text-left">ผล</th>
                                        <th class="py-2 px-4 border-b text-left">ประเภท</th>
                                        <th class="py-2 px-4 border-b text-left">คะแนนครั้งแรก</th>
                                        <th class="py-2 px-4 border-b text-left">คะแนนล่าสุด</th>
                                        <th class="py-2 px-4 border-b text-left">Points</th>
                                        <th class="py-2 px-4 border-b text-left">สถานะ</th>
                                        <th class="py-2 px-4 border-b text-left">เวลาที่ส่งล่าสุด</th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-results-table-body">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- NEW: Quiz Leaderboard Tab Content -->
                    <div id="leaderboard-quiz-tab-content" class="hidden">
    <h3 class="text-xl font-semibold mb-4">ตารางผู้นำ (แบบทดสอบนี้)</h3>

    <div class="mb-4 flex flex-wrap gap-2">
        <span class="self-center font-semibold mr-2">Export ผลลัพธ์:</span>
        <button id="export-leaderboard-image-btn" class="bg-gray-600 text-white py-1 px-3 rounded-md hover:bg-gray-700 text-sm flex items-center gap-2"><i class="fas fa-file-image"></i>Image</button>
        <button id="export-leaderboard-pdf-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm flex items-center gap-2"><i class="fas fa-file-pdf"></i>PDF</button>
        <button id="export-leaderboard-word-btn" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm flex items-center gap-2"><i class="fas fa-file-word"></i>Word</button>
        <button id="export-leaderboard-excel-btn" class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm flex items-center gap-2"><i class="fas fa-file-excel"></i>Excel</button>
    </div>
    <div class="overflow-x-auto" id="quiz-leaderboard-table-container">
        <table class="min-w-full bg-white border border-gray-200" id="quiz-leaderboard-table">
            <thead class="bg-gray-100">
                <tr>
                    <th class="py-2 px-4 border-b text-center w-16">อันดับ</th>
                    <th class="py-2 px-4 border-b text-left">ชื่อนักเรียน</th>
                    <th class="py-2 px-4 border-b text-center">คะแนนดีที่สุด</th>
                    <th class="py-2 px-4 border-b text-center">ผล</th>
                    <th class="py-2 px-4 border-b text-center">Points (ครั้งล่าสุด)</th>
                    <th class="py-2 px-4 border-b text-center">จำนวนครั้งที่ทำ</th>
                    <th class="py-2 px-4 border-b text-left">เวลาที่ส่งล่าสุด</th>
                    <th class="py-2 px-4 border-b text-left">ป้ายรางวัล</th>
                </tr>
            </thead>
            <tbody id="quiz-leaderboard-table-body">
                </tbody>
        </table>
    </div>
</div>
                </div>
            </div>

            <!-- Student View -->
            <div id="student-view" class="fade-in">
                <div id="student-initial-view">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-700 text-center">ทำแบบทดสอบ</h2>
                    <div id="student-entry-area" class="space-y-4 max-w-md mx-auto">
                        <div>
                            <label for="quiz-id-input" class="block text-sm font-medium text-gray-700 mb-1">ป้อนรหัสแบบทดสอบ:</label>
                            <input type="text" id="quiz-id-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="วางรหัสที่ได้รับจากผู้ควบคุม">
                        </div>
                        <button id="load-quiz-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center">
                            <i class="fas fa-search mr-2"></i>ค้นหาแบบทดสอบ
                        </button>
                        <div class="relative flex py-3 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-500">หรือ</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>
                        <button id="join-live-game-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center">
                            <i class="fas fa-flag-checkered mr-2"></i>เข้าร่วมเกมสด
                        </button>
                    </div>
                </div>

                <!-- NEW: Student Join Live Game View -->
                <div id="student-join-game-view" class="hidden max-w-md mx-auto">
                     <h2 class="text-2xl font-bold mb-4 text-indigo-700 text-center">เข้าร่วมเกมสด</h2>
                     <div class="space-y-4">
                         <div>
                             <label for="game-pin-input" class="block text-sm font-medium text-gray-700 mb-1">รหัสเข้าร่วม (Game PIN):</label>
                             <input type="number" id="game-pin-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="12">
                         </div>
                         <div>
                             <label for="nickname-input" class="block text-sm font-medium text-gray-700 mb-1">ชื่อเล่น:</label>
                             <input type="text" id="nickname-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ใส่ชื่อของคุณ...">
                         </div>
                         <button id="confirm-join-game-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                             <i class="fas fa-sign-in-alt mr-2"></i>เข้าร่วม
                         </button>
                         <button id="back-to-student-initial-btn" class="w-full mt-2 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
                             กลับ
                         </button>
                     </div>
                </div>
                
                <div id="student-name-selection-view" class="hidden max-w-md mx-auto">
                    <h2 id="student-quiz-topic" class="text-2xl font-bold mb-4 text-indigo-700 text-center"></h2>
                    <label for="student-name-select" class="block text-sm font-medium text-gray-700 mb-1">กรุณาเลือกชื่อของคุณ:</label>
                    <select id="student-name-select" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                    <button id="start-quiz-btn" class="w-full mt-4 bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700">
                        <i class="fas fa-play-circle mr-2"></i>เริ่มทำแบบทดสอบ
                    </button>
                </div>
                <div id="student-quiz-area" class="mt-6 hidden"></div>
                <div id="student-result-area" class="mt-6 hidden"></div>
                <div id="student-reading-area" class="mt-6 hidden"></div>
            </div>

            <!-- NEW: Live Game View (Covers the whole main content area) -->
            <div id="live-game-view" class="hidden fade-in">
                <!-- Content will be injected by JS -->
            </div>

        </main>
        
        <div id="user-info" class="text-center mt-6 text-xs text-gray-400">
            User ID: <span id="user-id-display">กำลังโหลด...</span>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg mb-4"></p>
            <button id="modal-close-btn" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700">ตกลง</button>
        </div>
    </div>

    <div id="create-project-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">สร้างโปรเจคใหม่</h3>
            <label for="project-name-input" class="block text-sm font-medium text-gray-700 mb-1">ชื่อโปรเจค:</label>
            <input type="text" id="project-name-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น คณิตศาสตร์ ม.1 เทอม 2">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-create-project-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-create-project-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">สร้างโปรเจค</button>
            </div>
        </div>
    </div>

    <div id="admin-password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4 text-center">เข้าสู่โหมดผู้ควบคุม</h3>
            <p class="text-center text-gray-600 mb-4">กรุณาป้อนรหัสผ่านเพื่อเข้าถึง</p>
            <input type="password" id="admin-password-input" class="w-full p-3 border border-gray-300 rounded-lg text-center" placeholder="******">
            <p id="password-error-msg" class="text-red-500 text-sm text-center mt-2 hidden">รหัสผ่านไม่ถูกต้อง</p>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-admin-login-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-admin-login-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">ยืนยันการกระทำ</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="rename-quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">เปลี่ยนชื่อแบบทดสอบ</h3>
            <label for="rename-quiz-input" class="block text-sm font-medium text-gray-700 mb-1">ชื่อใหม่:</label>
            <input type="text" id="rename-quiz-input" class="w-full p-3 border border-gray-300 rounded-lg">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-rename-quiz-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-rename-quiz-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="move-quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">ย้ายแบบทดสอบไปโปรเจคอื่น</h3>
            <label for="move-quiz-project-select" class="block text-sm font-medium text-gray-700 mb-1">เลือกโปรเจคปลายทาง:</label>
            <select id="move-quiz-project-select" class="w-full p-3 border border-gray-300 rounded-lg">
                <!-- Project options will be populated here -->
            </select>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-move-quiz-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-move-quiz-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">ย้าย</button>
            </div>
        </div>
    </div>
	
	<div id="global-live-game-modal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-xl w-full">
    <h3 class="text-xl font-bold mb-4">เริ่ม Live Game (ทุกโปรเจค)</h3>

    <input id="global-quiz-search-input" type="text"
           class="w-full p-2 border border-gray-300 rounded-lg mb-3"
           placeholder="ค้นหาชื่อแบบทดสอบหรือชื่อโปรเจค...">

    <div id="global-quiz-list"
         class="max-h-72 overflow-y-auto border rounded-md">
      <!-- สร้างรายการด้วย JS -->
    </div>

    <div class="flex justify-end gap-3 mt-4">
      <button id="cancel-global-live-btn"
              class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300">
        ยกเลิก
      </button>
      <button id="confirm-global-live-btn"
              class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 disabled:opacity-50"
              disabled>
        เริ่ม
      </button>
    </div>
  </div>
</div>

    <div id="quiz-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4">ตั้งค่าแบบทดสอบ</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-shuffle-select" class="block text-sm font-medium text-gray-700">การสลับข้อ/ตัวเลือก:</label>
                    <select id="modal-shuffle-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        <option value="none">ไม่สลับ</option>
                        <option value="questions_only">สลับเฉพาะข้อ</option>
                        <option value="choices_only">สลับเฉพาะตัวเลือก</option>
                        <option value="both">สลับทั้งข้อและตัวเลือก</option>
                    </select>
                </div>
                 <div>
                    <label for="modal-results-display-select" class="block text-sm font-medium text-gray-700">การแสดงผลให้นักเรียน:</label>
                    <select id="modal-results-display-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        <option value="show_results_and_answers">ทราบคะแนนและเฉลยทันที</option>
                        <option value="show_results_only">ทราบเฉพาะคะแนน (ไม่เห็นเฉลย)</option>
                        <option value="manual_release">รอผู้ดูแลแจ้งผล</option>
                    </select>
                </div>
                 <div class="flex items-center mt-2">
    <input id="modal-adaptive-quiz-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
    <label for="modal-adaptive-quiz-checkbox" class="ml-2 block text-sm font-medium text-gray-900">
        เปิดใช้งานแบบทดสอบปรับพื้นฐาน
    </label>
</div>
                <div class="border-t pt-4">
                    <label for="modal-timer-mode-select" class="block text-sm font-medium text-gray-700">โหมดการจับเวลา:</label>
                    <select id="modal-timer-mode-select" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        <option value="none">ไม่มีการจับเวลา</option>
                        <option value="whole_quiz">จับเวลาทั้งแบบทดสอบ (นาที)</option>
                        <option value="per_question">จับเวลาทีละข้อ (วินาที)</option>
                    </select>
                </div>
                <div id="modal-timer-duration-container" class="hidden">
                    <label for="modal-timer-duration-input" id="modal-timer-duration-label" class="block text-sm font-medium text-gray-700">ระยะเวลา:</label>
                    <input type="number" id="modal-timer-duration-input" value="10" min="1" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <!-- NEW: Passing Score in Modal -->
                <div class="border-t pt-4">
                    <label for="modal-passing-score-input" class="block text-sm font-medium text-gray-700">คะแนนที่ผ่าน:</label>
                    <input type="number" id="modal-passing-score-input" value="5" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-quiz-settings-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-quiz-settings-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">บันทึก</button>
            </div>
        </div>
    </div>
    
    <div id="quiz-status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-xl font-bold mb-4">ตั้งค่าสถานะแบบทดสอบ</h3>
            <div class="space-y-4">
                <div class="space-y-2" id="quiz-status-options">
                    <!-- Radio buttons will be dynamically inserted here -->
                </div>
                <div id="quiz-schedule-end-container" class="hidden space-y-2 border-t pt-3">
                    <label for="quiz-end-time" class="block text-sm font-medium text-gray-700">เวลาปิด:</label>
                    <input type="datetime-local" id="quiz-end-time" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div id="quiz-schedule-start-container" class="hidden space-y-2 border-t pt-3">
                    <label for="quiz-start-time" class="block text-sm font-medium text-gray-700">เวลาเปิด:</label>
                    <input type="datetime-local" id="quiz-start-time" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-quiz-status-btn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400">ยกเลิก</button>
                <button id="confirm-quiz-status-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">บันทึก</button>
            </div>
        </div>
    </div>

<div id="quiz-editor-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold text-indigo-700">แก้ไขแบบทดสอบ</h3>
                <button id="cancel-quiz-edits-btn" class="text-gray-500 hover:text-red-600 text-3xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto pr-2">
                <div class="mb-4">
                    <label for="editor-quiz-topic" class="block text-sm font-medium text-gray-700 mb-1">หัวข้อแบบทดสอบ:</label>
                    <input type="text" id="editor-quiz-topic" class="w-full p-2 border border-gray-300 rounded-lg text-lg font-semibold">
                </div>
                <div id="quiz-editor-questions-container" class="space-y-6">
                    </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end gap-3">
                <button id="cancel-quiz-edits-btn-footer" class="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button id="save-quiz-edits-btn" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-save"></i> บันทึกการแก้ไข
                </button>
            </div>
        </div>
    </div>

    <!-- Presentation Mode Container -->
    <div id="presentation-modal" class="fixed inset-0 bg-gray-800 text-white flex-col items-center justify-center hidden z-50 p-4">
        <button id="close-presentation-btn" class="absolute top-4 right-6 text-4xl hover:text-gray-300">&times;</button>
        <div id="presentation-slide-container" class="w-full max-w-5xl h-full flex flex-col items-center justify-center">
            <!-- Slide content will be injected here -->
        </div>
        <div class="absolute bottom-4 w-full flex justify-between items-center px-8 max-w-5xl mx-auto left-0 right-0">
            <button id="prev-question-btn" class="bg-indigo-600 py-2 px-5 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed"><i class="fas fa-arrow-left mr-2"></i>ก่อนหน้า</button>
            <div id="slide-counter" class="text-lg font-semibold"></div>
            <button id="next-question-btn" class="bg-indigo-600 py-2 px-5 rounded-lg hover:bg-indigo-700 disabled:bg-gray-500 disabled:cursor-not-allowed">ถัดไป<i class="fas fa-arrow-right ml-2"></i></button>
        </div>
    </div>
    <!-- NEW: Student Rankings Modal -->
    <div id="student-rankings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-3xl w-full h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-indigo-700">ตารางผู้นำ</h3>
                <button id="close-student-rankings-btn" class="text-gray-500 hover:text-red-600 text-2xl">&times;</button>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6">
                    <button id="student-quiz-leaderboard-tab" class="main-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg">
                        <i class="fas fa-list-ol mr-2"></i>อันดับในข้อสอบนี้
                    </button>
                    <button id="student-project-leaderboard-tab" class="main-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-gray-500">
                        <i class="fas fa-trophy mr-2"></i>อันดับรวมของโปรเจค
                    </button>
                </nav>
            </div>
            <!-- Content -->
            <div class="flex-grow overflow-y-auto mt-4">
                <div id="student-quiz-leaderboard-content">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100 sticky top-0">
                            <!-- Header for Quiz Leaderboard -->
                        </thead>
                        <tbody id="student-quiz-leaderboard-table-body"></tbody>
                    </table>
                </div>
                <div id="student-project-leaderboard-content" class="hidden">
                     <table class="min-w-full bg-white">
                        <thead class="bg-gray-100 sticky top-0">
                           <!-- Header for Project Leaderboard -->
                        </thead>
                        <tbody id="student-project-leaderboard-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, writeBatch, runTransaction, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State & Config ---
        let db, auth, userId;
        let currentMode = 'student'; // 'student', 'admin', or 'admin-testing'
        let currentProjectId = null;
        let currentProjectData = null;
        let currentQuizData = null;
        let currentDisplayedQuiz = null; // Holds the potentially shuffled quiz for the student
        let currentStudentName = null;
        let currentStudentProjectData = null; 
        let currentPresentationSlide = 0;
        let allProjects = []; // Cache for projects
		let allQuizzesGlobal = [];        // แคชแบบทดสอบทุกโปรเจค (อ่านรวดเดียว)
		let selectedGlobalQuizId = null;  // id แบบทดสอบที่ผู้ใช้เลือกใน modal
        let allQuizzes = []; // Cache for quizzes in a project
		let starredQuizzes = []; // Cache for starred quizzes
        let chartInstances = {}; // To hold chart objects
        let unsubscribeProjectsListener = null;
        let unsubscribeStudentsListener = null;
        let unsubscribeQuizzesListener = null;
        let unsubscribeSubmissionsListener = null;
        let unsubscribeStudentProfilesListener = null; // For Leaderboard
        let confirmAction = null;
        let actionTargetId = null; // Used for rename/move/timer actions
        let draggedSvgElement = null; // สำหรับเก็บ element ที่กำลังถูกลาก
        let svgOffset = { x: 0, y: 0 }; // สำหรับเก็บระยะห่างระหว่างเมาส์/นิ้วกับมุมของ element
        // Timer-related state
        let quizTimerInterval = null;
        let perQuestionTimerInterval = null;
        let quizStartTime = null; // For calculating duration
        let currentQuestionIndex = 0;
        let studentAnswersPerQuestion = [];
        // Live Game State
        let currentLiveGameId = null;
        let currentLiveGamePin = null;
        let unsubscribeLiveGameListener = null;
		 let lastRenderedAdminQuestionIndex = -1; // <-- [ เพิ่มบรรทัดนี้ ]


        // Gamification Constants
        const BADGES = {
            PERFECT_SCORE: { id: 'perfect_score', name: 'คะแนนเต็ม', description: 'ตอบถูกทุกข้อในแบบทดสอบนี้', icon: 'fa-crown text-yellow-500' },
            QUICK_THINKER: { id: 'quick_thinker', name: 'เซียนสมองไว', description: 'ทำแบบทดสอบเสร็จเร็วกว่าครึ่งของเวลาที่กำหนด', icon: 'fa-bolt text-blue-500' },
            ON_FIRE: { id: 'on_fire', name: 'ท็อปฟอร์ม', description: 'ตอบถูก 3 ข้อติดต่อกัน', icon: 'fa-fire text-orange-500' },
            FIRST_TRY_ACE: { id: 'first_try_ace', name: 'ผ่านฉลุย', description: 'ทำคะแนนเต็มในการทำครั้งแรก', icon: 'fa-rocket text-purple-500' },
            COMEBACK_KING: { id: 'comeback_king', name: 'ราชาคัมแบ็ก', description: 'สอบตกในครั้งแรก แต่กลับมาสอบผ่านได้', icon: 'fa-shield-alt text-gray-600' },
            SPECIALIST: { id: 'specialist', name: 'ผู้เชี่ยวชาญ', description: 'ได้คะแนนเต็มในทุกแบบทดสอบของโปรเจค', icon: 'fa-user-astronaut text-blue-700' },
            PERSEVERANCE: { id: 'perseverance', name: 'ผู้ไม่ยอมแพ้', description: 'ทำแบบทดสอบเดียวกันครบ 5 ครั้ง', icon: 'fa-dumbbell text-gray-700' }
        };

        // Use the config provided by the environment, with a fallback for local development
       const firebaseConfig = {
    apiKey: "AIzaSyCQlVzy_LBImNp5TJNwRuepFzvxWm8AyZk",
    authDomain: "ai-quiz-app-aefee.firebaseapp.com",
    projectId: "ai-quiz-app-aefee",
    storageBucket: "ai-quiz-app-aefee.appspot.com",
    messagingSenderId: "274192258111",
    appId: "1:274192258111:web:4120c9118229b5644dd48a",
    measurementId: "G-V90KRM0L63"
};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ai-quiz-generator-v3';

        // --- DOM Elements ---
        const adminView = document.getElementById('admin-view');
        const studentView = document.getElementById('student-view');
        const projectDashboardView = document.getElementById('project-dashboard-view');
        const projectDetailView = document.getElementById('project-detail-view');
        const quizResultsView = document.getElementById('quiz-results-view');
        const projectList = document.getElementById('project-list');
        const noProjectsMsg = document.getElementById('no-projects-msg');
        const projectTitle = document.getElementById('project-title');
        const projectIdDisplay = document.getElementById('project-id-display');
        const studentList = document.getElementById('student-list');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const createProjectModal = document.getElementById('create-project-modal');
        const adminPasswordModal = document.getElementById('admin-password-modal');
        const confirmationModal = document.getElementById('confirmation-modal');
        const userIdDisplay = document.getElementById('user-id-display');
        const topicTab = document.getElementById('topic-tab');
        const textTab = document.getElementById('text-tab');
        const topicInputArea = document.getElementById('topic-input-area');
        const textInputArea = document.getElementById('text-input-area');
        const manageTab = document.getElementById('manage-tab');
        const resultsTab = document.getElementById('results-tab');
        const leaderboardTab = document.getElementById('leaderboard-tab');
        const manageTabContent = document.getElementById('manage-tab-content');
        const resultsTabContent = document.getElementById('results-tab-content');
        const leaderboardTabContent = document.getElementById('leaderboard-tab-content');
        const projectQuizzesList = document.getElementById('project-quizzes-list');
        const fileTab = document.getElementById('file-tab');
        const fileInputArea = document.getElementById('file-input-area');
        const fileUploadInput = document.getElementById('file-upload-input');
        const worksheetTab = document.getElementById('worksheet-tab');
        
        const worksheetInputArea = document.getElementById('worksheet-input-area');
        const generateWorksheetBtn = document.getElementById('generate-worksheet-btn');
        // Student view elements
        const studentInitialView = document.getElementById('student-initial-view');
        const studentNameSelectionView = document.getElementById('student-name-selection-view');
        const studentQuizArea = document.getElementById('student-quiz-area');
        const studentResultArea = document.getElementById('student-result-area');
        const studentReadingArea = document.getElementById('student-reading-area');
        const loadQuizBtn = document.getElementById('load-quiz-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const studentJoinGameView = document.getElementById('student-join-game-view');
        
        // Presentation Mode elements
        const presentationModal = document.getElementById('presentation-modal');

        // Modals
        const renameQuizModal = document.getElementById('rename-quiz-modal');
        const moveQuizModal = document.getElementById('move-quiz-modal');
        const quizSettingsModal = document.getElementById('quiz-settings-modal');
        const quizStatusModal = document.getElementById('quiz-status-modal');

        // Live Game View
        const liveGameView = document.getElementById('live-game-view');


        // --- Initial Setup ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
                setupEventListeners();
                showView('student'); // Default to student view
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้");
            }
        }
		
		/**
 * ฟังก์ชันสำหรับเปรียบเทียบคำตอบที่เป็นตัวเลขโดยเฉพาะ
 * @param {string} userAnswer คำตอบจากผู้ใช้
 * @param {string} idealAnswer คำตอบที่ถูกต้อง
 * @returns {boolean} คืนค่า true ถ้าตัวเลขเทียบเท่ากัน
 */
function compareNumericalAnswers(userAnswer, idealAnswer) {
    // แปลง comma เป็น period และตัดตัวอักษรที่ไม่ใช่ตัวเลขออก (ยกเว้นจุดทศนิยมและเครื่องหมายลบ)
    const cleanUserStr = String(userAnswer).replace(',', '.').replace(/[^\d.-]/g, '').trim();
    const cleanIdealStr = String(idealAnswer).replace(',', '.').replace(/[^\d.-]/g, '').trim();

    // ถ้าสตริงว่างเปล่าหลังจากการล้างค่า ให้ถือว่าไม่ใช่ตัวเลข
    if (cleanUserStr === '' || cleanIdealStr === '') {
        return false;
    }

    const userNum = parseFloat(cleanUserStr);
    const idealNum = parseFloat(cleanIdealStr);

    // ตรวจสอบว่าทั้งสองค่าเป็นตัวเลขที่ถูกต้องหรือไม่
    if (isNaN(userNum) || isNaN(idealNum)) {
        return false;
    }

    // เปรียบเทียบตัวเลขโดยยอมรับค่าคลาดเคลื่อนเล็กน้อย (Epsilon) สำหรับทศนิยม
    return Math.abs(userNum - idealNum) < 0.001;
}

/**
 * ฟังก์ชันตรวจคำตอบแบบสั้น/เติมคำแบบหลายชั้น
 * @param {string} userAnswer คำตอบจากผู้ใช้
 * @param {object} questionData ข้อมูลคำถามทั้งหมด ซึ่งมี idealAnswer
 * @returns {Promise<boolean>} คืนค่า Promise ที่ resolve เป็น true หากคำตอบถูกต้อง
 */
async function gradeShortAnswer(userAnswer, questionData) {
    const idealAnswer = questionData.idealAnswer;

    // --- ขั้นที่ 1: ตรวจสอบแบบตรงตัว (Case-Insensitive) ---
    // วิธีที่เร็วที่สุด
    if (String(userAnswer).trim().toLowerCase() === String(idealAnswer).trim().toLowerCase()) {
        return true;
    }

    // --- ขั้นที่ 2: ตรวจสอบเชิงตัวเลข (Numerical Check) ---
    // สำหรับคำตอบที่เป็นการคำนวณ
    if (compareNumericalAnswers(userAnswer, idealAnswer)) {
        return true;
    }

    // --- (ทางเลือก) ขั้นที่ 3: ตรวจสอบกับรายการคำตอบที่ยอมรับได้ ---
    // หากคุณต้องการให้ครูสามารถเพิ่มคำตอบอื่นๆ ที่ถูกต้องได้
    // if (questionData.acceptedAnswers && Array.isArray(questionData.acceptedAnswers)) {
    //     const normalizedUserAnswer = String(userAnswer).trim().toLowerCase();
    //     if (questionData.acceptedAnswers.some(ans => String(ans).trim().toLowerCase() === normalizedUserAnswer)) {
    //         return true;
    //     }
    // }

    // --- ขั้นที่ 4: ใช้ AI เป็นทางเลือกสุดท้าย ---
    // เมื่อการตรวจสอบเบื้องต้นทั้งหมดไม่สำเร็จ
    console.log("Programmatic checks failed. Deferring to AI for grading.");
    return await gradeShortAnswerWithAI(userAnswer, idealAnswer);
}
		
		async function revealAnswerForAdmin(index, total) {
            // ป้องกันการทำงานซ้ำซ้อน หากปุ่ม "ข้อต่อไป" ถูกสร้างไปแล้ว
            if (document.getElementById('next-live-question-btn')) return;

            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            await updateDoc(gameRef, { questionStatus: 'revealed' });

            const correctOption = liveGameView.querySelector('[data-is-correct="true"]');
            if (correctOption) {
                correctOption.classList.remove('bg-white/30');
                correctOption.classList.add('bg-green-300', 'text-green-900', 'font-bold', 'border-4', 'border-green-500');
                correctOption.innerHTML = `<i class="fas fa-check mr-3"></i>` + correctOption.innerHTML;
            }

            const actionButtonsContainer = document.getElementById('admin-action-buttons');
            if(actionButtonsContainer){
                actionButtonsContainer.innerHTML = `
                    <button id="next-live-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                        ${index + 1 === total ? 'ดูสรุปผล' : 'ข้อต่อไป'} <i class="fas fa-arrow-right"></i>
                    </button>
                `;

                document.getElementById('next-live-question-btn').addEventListener('click', async () => {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                    const gameSnap = await getDoc(gameRef);
                    if (!gameSnap.exists()) return;

                    const gameData = gameSnap.data();
                    const updateData = {};
                    
                    if (gameData.players) {
                        for (const playerName in gameData.players) {
                            updateData[`players.${playerName}.answeredCurrentQuestion`] = false;
                        }
                    }
                    
                    const nextIndex = index + 1;
                    if (nextIndex < total) {
                        updateData.currentQuestionIndex = nextIndex;
                        updateData.questionDisplayedAt = serverTimestamp();
                        updateData.questionStatus = 'answering';
                        await updateDoc(gameRef, updateData);
                    } else {
                        await updateDoc(gameRef, { status: 'podium' });
                    }
                });
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Set the actual user ID for this session
                    userId = user.uid; 
                    userIdDisplay.textContent = userId;

                    // Listen for projects from the shared location
                    if (unsubscribeProjectsListener) unsubscribeProjectsListener();
                    listenForProjects();
                    listenForStarredQuizzes();
                } else {
                    await authenticateUser();
                }
            });
        }

function showPodiumView(players) {
            const playersArray = Object.entries(players).map(([name, data]) => ({
                name: name,
                score: data.score || 0,
                badges: data.badges || []
            }));

            playersArray.sort((a, b) => {
                const scoreDiff = b.score - a.score;
                if (scoreDiff !== 0) {
                    return scoreDiff;
                }
                return (b.badges.length || 0) - (a.badges.length || 0);
            });

            const renderBadges = (badges) => {
                if (!badges || badges.length === 0) return '';
                const badgeIcons = {
                    quick_thinker: '⚡️',
                    on_fire: '🔥'
                };
                return `<div class="flex justify-center gap-2 my-1 text-2xl">${badges.map(b => badgeIcons[b] || '').join('')}</div>`;
            };

            // --- [ เริ่ม ] โค้ดที่เพิ่มเข้ามาสำหรับแสดงอันดับอื่นๆ ---
            const otherPlayers = playersArray.slice(3);
            const otherPlayersHtml = otherPlayers.length > 0 ? `
                <div class="mt-8 w-full max-w-lg bg-black/20 p-4 rounded-lg text-left">
                    <h3 class="text-xl font-bold mb-3 text-center">อันดับอื่นๆ</h3>
                    <div class="space-y-2 text-lg">
                        ${otherPlayers.map((player, index) => `
                            <div class="flex justify-between items-center bg-black/10 hover:bg-black/30 p-2 rounded-md transition-colors">
                                <div>
                                    <span class="font-semibold text-gray-300 w-8 inline-block">${index + 4}.</span>
                                    <i class="fas fa-user-circle mr-2 text-gray-300"></i>
                                    <span>${player.name}</span>
                                </div>
                                <span class="font-bold text-white">${player.score} คะแนน</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            // --- [ สิ้นสุด ] โค้ดที่เพิ่มเข้ามา ---

            const podiumHTML = `
                <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full items-center justify-center">
                    <h2 class="text-4xl font-bold mb-8">สรุปผลการแข่งขัน! <i class="fas fa-trophy text-yellow-300"></i></h2>

                    <div class="flex items-end justify-center gap-4 w-full max-w-2xl">
                        ${playersArray[1] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-user-circle text-6xl mb-2 text-gray-300"></i>
                            <p class="font-bold text-2xl">${playersArray[1].name}</p>
                            ${renderBadges(playersArray[1].badges)}
                            <p class="text-xl">${playersArray[1].score} คะแนน</p>
                            <div class="bg-gray-400 text-gray-900 font-bold p-4 rounded-t-lg mt-2 h-32 flex items-center justify-center text-5xl">2</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}

                        ${playersArray[0] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-crown text-6xl mb-2 text-yellow-400"></i>
                            <p class="font-bold text-3xl">${playersArray[0].name}</p>
                            ${renderBadges(playersArray[0].badges)}
                            <p class="text-2xl">${playersArray[0].score} คะแนน</p>
                            <div class="bg-yellow-500 text-yellow-900 font-bold p-4 rounded-t-lg mt-2 h-48 flex items-center justify-center text-6xl">1</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}

                        ${playersArray[2] ? `
                        <div class="podium-step text-center flex-1">
                            <i class="fas fa-user-circle text-6xl mb-2 text-amber-800"></i>
                            <p class="font-bold text-2xl">${playersArray[2].name}</p>
                            ${renderBadges(playersArray[2].badges)}
                            <p class="text-xl">${playersArray[2].score} คะแนน</p>
                            <div class="bg-amber-700 text-amber-100 font-bold p-4 rounded-t-lg mt-2 h-24 flex items-center justify-center text-4xl">3</div>
                        </div>
                        ` : '<div class="flex-1"></div>'}
                    </div>

                    ${otherPlayersHtml} 

                    ${currentMode === 'admin' ? `
                    <button id="close-game-final-btn" class="mt-8 bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700">
                        <i class="fas fa-times-circle mr-2"></i>จบเกมและกลับหน้าหลัก
                    </button>
                    ` : `
                    <p class="mt-8 text-lg">ขอบคุณที่ร่วมสนุก!</p>
                    `}
                </div>
            `;
            liveGameView.innerHTML = podiumHTML;

            if (currentMode === 'admin') {
                document.getElementById('close-game-final-btn').addEventListener('click', async () => {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                    await deleteDoc(gameRef);
                    showView('admin-dashboard');
                });
            }
        }

        // ===== Drop-in replacement =====
async function handleStartLiveRace(quizId) {
  // 1) หา quiz จากหน้าปัจจุบันก่อน (กรณีอยู่ในหน้าโปรเจค)
  let quiz = allQuizzes.find(q => q.id === quizId);

  // 2) ถ้าไม่เจอ (เช่น กดจาก Dashboard) ให้ดึงเอกสาร quiz ตรงๆ
  if (!quiz) {
    const qref = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
    const qsnap = await getDoc(qref);
    if (!qsnap.exists()) {
      showMessage("ไม่พบข้อมูลแบบทดสอบ");
      return;
    }
    quiz = { id: qsnap.id, ...qsnap.data() };
  }

  // ใช้ quiz ที่โหลดมา
  currentQuizData = getShuffledQuiz(quiz);

  // ใช้ projectId ของ quiz (ถ้ามี) เพื่อผูกข้อมูลให้ถูกโปรเจค
  const projectIdForGame = quiz.projectId || currentProjectId || null;

  // สร้างห้องเกม
  const gamePin = Math.floor(1000 + Math.random() * 9000).toString();
  currentLiveGamePin = gamePin;

  try {
    const gameRef = await addDoc(collection(db, `artifacts/${appId}/public/data/liveGames`), {
      quizId,
      projectId: projectIdForGame,
      status: "lobby",
      currentQuestionIndex: -1,
      players: {},
      gamePin,
      createdAt: serverTimestamp()
    });

    currentLiveGameId = gameRef.id;
    showAdminLobbyView(gamePin, quiz.topic);
    listenForLiveGameUpdates();
  } catch (err) {
    console.error("Error starting live race:", err);
    showMessage("เกิดข้อผิดพลาดในการสร้างห้องเกม");
  }
}

        async function handleShowStudentRankings() {
    // Insert table headers for student leaderboard views
    const quizTableHead = document.querySelector('#student-quiz-leaderboard-content thead');
    if (quizTableHead) {
      quizTableHead.innerHTML = `
        <tr>
          <th class="py-2 px-3 text-center w-16">อันดับ</th>
          <th class="py-2 px-3 text-left">ชื่อผู้ทำ</th>
          <th class="py-2 px-3 text-center">คะแนน</th>
          <th class="py-2 px-3 text-center">สถานะ (ผ่าน/ไม่ผ่าน)</th>
          <th class="py-2 px-3 text-center">คะแนน Points</th>
          <th class="py-2 px-3 text-left">ไอคอนรางวัล</th>
        </tr>
      `;
    }
    const projectTableHead = document.querySelector('#student-project-leaderboard-content thead');
    if (projectTableHead) {
      projectTableHead.innerHTML = `
        <tr>
          <th class="py-2 px-3 text-center w-16">อันดับ</th>
          <th class="py-2 px-3 text-left">ชื่อผู้เล่น</th>
          <th class="py-2 px-3 text-center">คะแนนรวม (Points)</th>
          <th class="py-2 px-3 text-left">ไอคอนรางวัลที่ได้รับ</th>
        </tr>
      `;
    }
    
            const modal = document.getElementById('student-rankings-modal');
            modal.classList.remove('hidden');

            // Setup close button
            document.getElementById('close-student-rankings-btn').onclick = () => modal.classList.add('hidden');

            // Setup tabs
            const quizTab = document.getElementById('student-quiz-leaderboard-tab');
            const projectTab = document.getElementById('student-project-leaderboard-tab');
            const quizContent = document.getElementById('student-quiz-leaderboard-content');
            const projectContent = document.getElementById('student-project-leaderboard-content');

            quizTab.onclick = () => {
                quizTab.classList.add('active');
                projectTab.classList.remove('active');
                quizContent.classList.remove('hidden');
                projectContent.classList.add('hidden');
            };
            projectTab.onclick = () => {
                projectTab.classList.add('active');
                quizTab.classList.remove('active');
                projectContent.classList.remove('hidden');
                quizContent.classList.add('hidden');
            };

            // Fetch and render data
            try {
                // 1. Fetch data for THIS quiz leaderboard
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${currentQuizData.id}/submissions`);
                const submissionsSnapshot = await getDocs(submissionsRef);
                const submissions = submissionsSnapshot.docs.map(doc => doc.data());
                renderQuizLeaderboard(submissions, currentQuizData, 'student-quiz-leaderboard-table-body');

                // 2. Fetch data for the OVERALL project leaderboard
                const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${currentQuizData.projectId}/studentProfiles`);
                const profilesSnapshot = await getDocs(profilesRef);
                const profiles = profilesSnapshot.docs.map(doc => doc.data());
                renderLeaderboard(profiles, 'student-project-leaderboard-table-body');

            } catch (error) {
                console.error("Error fetching student rankings:", error);
                showMessage("ไม่สามารถโหลดข้อมูลอันดับได้");
            }
        }

        async function handleSaveToBank(e) {
    const btn = e.currentTarget;
    const index = btn.dataset.index;
    const questionData = currentQuizData.questions[index];

    if (!userId) {
        showMessage("ไม่พบข้อมูลผู้ใช้");
        return;
    }

    try {
        // เพิ่มข้อมูลหัวข้อเดิมเข้าไปด้วย เพื่อให้ง่ายต่อการค้นหาในอนาคต
        const dataToSave = {
            ...questionData,
            originalTopic: currentQuizData.topic, 
            savedAt: serverTimestamp()
        };

        const bankCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/questionBank`);
        await addDoc(bankCollectionRef, dataToSave);

        // แสดงผลตอบรับให้ครูทราบ
        showMessage("บันทึกคำถามลงคลังข้อสอบส่วนตัวแล้ว");
        btn.classList.remove('text-purple-600');
        btn.classList.add('text-green-600'); // เปลี่ยนเป็นสีเขียว
        btn.disabled = true; // ปิดปุ่มหลังบันทึกแล้ว
    } catch (error) {
        console.error("Error saving to question bank:", error);
        showMessage("เกิดข้อผิดพลาดในการบันทึก");
    }
}

function listenForStarredQuizzes() {
            if (!userId) return;
            const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
            const q = query(quizzesRef, where("isStarred", "==", true));

            onSnapshot(q, (snapshot) => {
                // เก็บข้อมูลแบบทดสอบที่ติดดาวลงในตัวแปร global
                starredQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // เรียก renderProjects() เพื่อวาดหน้าจอใหม่ทั้งหมด ซึ่งจะรวมโปรเจค "ติดดาว" เข้าไปด้วย
                renderProjects();
            }, (error) => {
                console.error("Error listening for starred quizzes:", error);
            });
        }

async function handleToggleStarQuiz(quizId) {
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
            try {
                const quizDoc = await getDoc(quizRef);
                if (quizDoc.exists()) {
                    const currentStatus = quizDoc.data().isStarred || false;
                    await updateDoc(quizRef, {
                        isStarred: !currentStatus
                    });
                }
            } catch (error) {
                console.error("Error toggling star status:", error);
                showMessage("เกิดข้อผิดพลาดในการติดดาว");
            }
        }

async function displayQuestionBank() {
    const container = document.getElementById('bank-input-area');
    container.innerHTML = '<div class="loader mx-auto"></div>'; // แสดงสถานะกำลังโหลด

    try {
        const bankCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/questionBank`);
        const q = query(bankCollectionRef); // สามารถเพิ่ม orderBy ได้ในอนาคต
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            container.innerHTML = '<p class="text-center text-gray-500">คลังข้อสอบของคุณยังว่างอยู่</p>';
            return;
        }

        let questionsHTML = snapshot.docs.map(doc => {
            const question = doc.data();
            const questionId = doc.id;
            return `
                <div class="flex items-start gap-3 p-2 border-b">
                    <input type="checkbox" value='${JSON.stringify(question)}' class="mt-1 h-4 w-4">
                    <div>
                        <p class="font-semibold">${question.questionText || question.stem}</p>
                        <p class="text-xs text-gray-500">จากเรื่อง: ${question.originalTopic}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = `
            <div class="max-h-60 overflow-y-auto border rounded-lg p-2">${questionsHTML}</div>
            <button id="create-from-bank-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700">
                สร้างแบบทดสอบจากข้อที่เลือก
            </button>
        `;

        document.getElementById('create-from-bank-btn').addEventListener('click', createQuizFromBank);

    } catch (error) {
        console.error("Error displaying question bank:", error);
        container.innerHTML = '<p class="text-center text-red-500">ไม่สามารถโหลดคลังข้อสอบได้</p>';
    }
}

function showAdminLiveQuestionView(question, index, total) {
            const questionType = question.questionType || currentQuizData.quizType; //
            let optionsHTML = '';

            // --- CHANGE 1: สร้าง HTML ของตัวเลือกโดยยังไม่แสดงเฉลย ---
            // เราจะเพิ่ม data-attribute เพื่อให้รู้ว่าข้อไหนคือคำตอบที่ถูกต้อง
            if(questionType === 'multiple_choice' || questionType === 'true_false') {
                const options = questionType === 'true_false' ? ['ใช่', 'ไม่ใช่'] : question.options;
                const correctIndex = questionType === 'true_false' ? (question.correctAnswer ? 0 : 1) : question.correctAnswerIndex;

                optionsHTML = options.map((opt, i) => `
                    <div class="p-4 rounded-lg text-xl flex items-center justify-center text-center bg-white/30" data-is-correct="${i === correctIndex}">
                        ${opt}
                    </div>
                `).join('');
            } else if (questionType === 'matching_item') { // <-- เพิ่มส่วนนี้
                const options = question.allResponses || [];
                optionsHTML = options.map(opt => `
                    <div class="p-4 rounded-lg text-xl flex items-center justify-center text-center bg-white/30" data-is-correct="${opt === question.correctResponse}">
                        ${opt}
                    </div>
                `).join('');
            }

						const questionDisplayText = question.stem || question.questionText; // <-- เพิ่มบรรทัดนี้
            const adminQuestionHTML = `
                <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full">
                    <div class="flex justify-between items-center text-lg">
                        <span>ข้อที่ ${index + 1} / ${total}</span>
                        <span class="bg-white/20 px-3 py-1 rounded-full text-base">
                            ตอบแล้ว: <span id="answer-counter" class="font-bold">0/0</span>
                        </span>
                        <button id="end-game-btn" class="bg-red-600 text-white py-1 px-3 rounded-md hover:bg-red-700 text-sm">จบเกม</button>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center">
                        <h2 class="text-3xl font-bold mb-8 text-center">${questionDisplayText}</h2>
                        <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${optionsHTML}
                        </div>
                    </div>
                    <div id="admin-action-buttons" class="text-center mt-8">
                        <button id="reveal-answer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                            <i class="fas fa-eye"></i> เฉลย
                        </button>
                    </div>
                </div>
            `; //
            liveGameView.innerHTML = adminQuestionHTML; //
            
            if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise([liveGameView]); } //

            // --- CHANGE 3: เพิ่ม Event Listener ใหม่ทั้งหมด ---
            const actionButtonsContainer = document.getElementById('admin-action-buttons'); //

            // จัดการการคลิกปุ่ม "เฉลย"
            document.getElementById('reveal-answer-btn').addEventListener('click', async () => { // <-- [ เพิ่ม async ]
                // --- [ เพิ่มโค้ดส่วนนี้ ] ---
                // อัปเดตสถานะของเกมเพื่อบอกให้ Client รู้ว่าเฉลยแล้ว
                const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
                await updateDoc(gameRef, { questionStatus: 'revealed' });
                // --- [ สิ้นสุดโค้ดที่เพิ่ม ] ---

                // 1. ค้นหาตัวเลือกที่เป็นคำตอบที่ถูกต้อง
                const correctOption = liveGameView.querySelector('[data-is-correct="true"]'); //
                if (correctOption) {
                    // 2. เพิ่ม Style ให้กับคำตอบที่ถูกต้อง (พื้นหลังสีเขียว, ไอคอน)
                    correctOption.classList.remove('bg-white/30'); //
                    correctOption.classList.add('bg-green-300', 'text-green-900', 'font-bold', 'border-4', 'border-green-500'); //
                    correctOption.innerHTML = `<i class="fas fa-check mr-3"></i>` + correctOption.innerHTML; //
                }

                // 3. เปลี่ยนปุ่ม "เฉลย" ให้เป็นปุ่ม "ข้อต่อไป"
                actionButtonsContainer.innerHTML = `
                    <button id="next-live-question-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg text-2xl">
                        ${index + 1 === total ? 'ดูสรุปผล' : 'ข้อต่อไป'} <i class="fas fa-arrow-right"></i>
                    </button>
                `; //

                // 4. เพิ่ม Event Listener ให้กับปุ่ม "ข้อต่อไป" ที่เพิ่งสร้างขึ้นมาใหม่
                document.getElementById('next-live-question-btn').addEventListener('click', async () => { //
                    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId); //
                    const gameSnap = await getDoc(gameRef); //
                    if (!gameSnap.exists()) return;

                    const gameData = gameSnap.data(); //
                    const updateData = {};
                    
                    if (gameData.players) {
                        for (const playerName in gameData.players) {
                            updateData[`players.${playerName}.answeredCurrentQuestion`] = false;
                        }
                    }
                    
                    const nextIndex = index + 1; //
                    if (nextIndex < total) {
                        updateData.currentQuestionIndex = nextIndex; //
                        updateData.questionDisplayedAt = serverTimestamp(); //
                        updateData.questionStatus = 'answering'; // <-- [ เพิ่มบรรทัดนี้ ] รีเซ็ตสถานะสำหรับข้อใหม่
                        await updateDoc(gameRef, updateData); //
                    } else {
                        await updateDoc(gameRef, { status: 'podium' }); //
                    }
                });
            });

            // ปุ่มจบเกมยังทำงานเหมือนเดิม
            document.getElementById('end-game-btn').addEventListener('click', async () => { //
                const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId); //
                await deleteDoc(gameRef); //
                showView('admin-dashboard'); //
            });
        }

function showStudentLiveQuestionView(question, index, total) {
    const questionType = question.questionType || currentQuizData.quizType;
    let optionsHTML = '';

            if(questionType === 'multiple_choice' || questionType === 'true_false') {
                const options = questionType === 'true_false' ? ['ใช่', 'ไม่ใช่'] : question.options;
                optionsHTML = options.map((opt, i) => `
                    <button data-index="${i}" class="live-answer-btn p-4 rounded-lg text-xl text-center bg-white text-gray-800 hover:bg-indigo-100 transition-all transform hover:scale-105">
                        ${opt}
                    </button>
                `).join('');
            } else if (questionType === 'matching_item') { // <-- เพิ่มส่วนนี้
                const options = question.allResponses || [];
                optionsHTML = options.map((opt, i) => `
                    <button data-index="${i}" class="live-answer-btn p-4 rounded-lg text-xl text-center bg-white text-gray-800 hover:bg-indigo-100 transition-all transform hover:scale-105">
                        ${opt}
                    </button>
                `).join('');
				} else if (questionType === 'short_answer') { // <-- เพิ่มส่วนนี้
                optionsHTML = `
                    <div class="w-full md:col-span-2 flex flex-col items-center gap-4">
                        <textarea id="live-short-answer-input" class="w-full max-w-lg p-3 border rounded-lg text-gray-800 text-lg" rows="3" placeholder="พิมพ์คำตอบของคุณ..."></textarea>
                        <button id="live-submit-short-answer-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl">
                            <i class="fas fa-paper-plane mr-2"></i>ส่งคำตอบ
                        </button>
                    </div>
                `;
            }

				const questionDisplayText = question.stem || question.questionText; // <-- เพิ่มบรรทัดนี้
    const studentQuestionHTML = `
        <div class="live-game-bg text-white rounded-lg p-8 flex flex-col h-full">
            <p class="text-lg text-center">ข้อที่ ${index + 1} / ${total}</p>
            <div class="flex-grow flex flex-col items-center justify-center">
                <h2 class="text-3xl font-bold mb-8 text-center">${questionDisplayText}</h2>
                <div id="live-options-container" class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${optionsHTML}
                </div>
            </div>
        </div>
    `;
    liveGameView.innerHTML = studentQuestionHTML;

    
    // Typeset math after injecting student live question
    if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise([liveGameView]); }
	
	 // --- [ เริ่ม ] เพิ่มโค้ดส่วนนี้เข้าไป ---
    const submitShortAnswerBtn = document.getElementById('live-submit-short-answer-btn');
    if (submitShortAnswerBtn) {
        submitShortAnswerBtn.addEventListener('click', () => {
            const answerText = document.getElementById('live-short-answer-input').value;
            handleLiveAnswer(answerText, question); // ส่งข้อความที่พิมพ์ไปจัดการต่อ
        });
    }
    // --- [ สิ้นสุด ] เพิ่มโค้ดส่วนนี้เข้าไป ---
	
// Add event listener for student answers
    document.getElementById('live-options-container').addEventListener('click', (e) => {
        const btn = e.target.closest('.live-answer-btn');
        if (btn) {
            const answerIndex = parseInt(btn.dataset.index);
            handleLiveAnswer(answerIndex, question);
        }
    });
}

async function handleLiveAnswer(answerIndex, question) {
    // Disable all buttons after answering to prevent multiple submissions
    document.querySelectorAll('.live-answer-btn, #live-submit-short-answer-btn').forEach(b => b.disabled = true);

    const questionType = question.questionType || currentQuizData.quizType;
    let isCorrect = false;

    // Determine if the selected answer is correct
    if (questionType === 'short_answer') {
        // --- [ส่วนที่แก้ไข] ---
        // สำหรับเกมสด คำตอบที่พิมพ์จะถูกส่งมาในพารามิเตอร์ answerIndex
        const userAnswer = (answerIndex || '').toString(); 
        // เรียกใช้ฟังก์ชันตรวจคำตอบอัจฉริยะของเรา
        isCorrect = await gradeShortAnswer(userAnswer, question);
        // --- [สิ้นสุดส่วนที่แก้ไข] ---
    }
    else if (questionType === 'multiple_choice') {
        isCorrect = answerIndex === question.correctAnswerIndex;
    } else if (questionType === 'true_false') {
        const correctAnswerBool = question.correctAnswer;
        isCorrect = (answerIndex === 0 && correctAnswerBool) || (answerIndex === 1 && !correctAnswerBool);
    } else if (questionType === 'matching_item') {
        const selectedResponse = question.allResponses[answerIndex];
        isCorrect = selectedResponse === question.correctResponse;
    }

    const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
    const gameSnap = await getDoc(gameRef);

    if (!gameSnap.exists()) return;

    const gameData = gameSnap.data();
    const playerData = gameData.players[currentStudentName];
    
    // --- UPDATED LOGIC FOR DYNAMIC SCORING & BADGES ---
    let playerBadges = playerData.badges || [];
    let playerStreak = playerData.correctStreak || 0;
    const updatePayload = {};
    let calculatedPoints = 0;

    // 1. Calculate time taken
    if (gameData.questionDisplayedAt) {
        const questionStartTime = gameData.questionDisplayedAt.toDate();
        const timeTaken = new Date() - questionStartTime; // in milliseconds

        if (isCorrect) {
            // 2. Calculate dynamic points based on speed
            const maxPoints = 1000;
            const bonusPoints = 500; // Points decay over time
            const timeLimit = 20000; // 20 seconds

            let timeRatio = timeTaken / timeLimit;
            if (timeRatio > 1) timeRatio = 1;

            const pointsLost = Math.round(timeRatio * bonusPoints);
            calculatedPoints = maxPoints - pointsLost;

            // 3. Award "Quick Thinker" badge
            if (timeTaken <= 5000 && !playerBadges.includes('quick_thinker')) {
                playerBadges.push('quick_thinker');
            }
        }
    }
    
    // 4. Award "On Fire" badge
    if (isCorrect) {
        playerStreak++;
        if (playerStreak === 3 && !playerBadges.includes('on_fire')) {
            playerBadges.push('on_fire');
            playerStreak = 0;
        }
    } else {
        playerStreak = 0;
    }
    
    // 5. Prepare payload for Firestore update
    if (isCorrect) {
        updatePayload[`players.${currentStudentName}.score`] = increment(calculatedPoints);
    }
    updatePayload[`players.${currentStudentName}.badges`] = playerBadges;
    updatePayload[`players.${currentStudentName}.correctStreak`] = playerStreak;
    updatePayload[`players.${currentStudentName}.answeredCurrentQuestion`] = true;
    updatePayload[`players.${currentStudentName}.lastAnswerCorrect`] = isCorrect;
    updatePayload[`players.${currentStudentName}.pointsLastQuestion`] = calculatedPoints;


    // 6. Update Firestore
    await updateDoc(gameRef, updatePayload);
    // --- END OF UPDATED LOGIC ---

    // Show the waiting screen
    liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
        <h2 class="text-3xl font-bold">ส่งคำตอบแล้ว!</h2>
        <p class="mt-8">รอผู้เล่นคนอื่นสักครู่...</p>
        <div class="loader mt-4"></div>
    </div>`;
}

function createQuizFromBank() {
    const selectedCheckboxes = document.querySelectorAll('#bank-input-area input[type="checkbox"]:checked');
    if (selectedCheckboxes.length === 0) {
        showMessage("กรุณาเลือกข้อสอบอย่างน้อย 1 ข้อ");
        return;
    }

    const questions = [];
    selectedCheckboxes.forEach(box => {
        questions.push(JSON.parse(box.value));
    });

    const newQuizData = {
        topic: "แบบทดสอบจากคลังส่วนตัว",
        questions: questions
    };

    displayGeneratedQuiz(newQuizData);
}

        function showAdminLobbyView(gamePin, quizTopic) {
    showView('live-game'); // สลับไปที่ container ของ live game

    // สร้าง HTML สำหรับหน้า Lobby (ส่วนนี้เหมือนเดิม)
    const lobbyHTML = `
        <div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
            <h2 class="text-2xl font-bold mb-2">เริ่มเกม: ${quizTopic}</h2>
            <p class="text-lg mb-4">ให้นักเรียนเข้าร่วมด้วยรหัสนี้:</p>
            <div class="bg-white text-gray-800 rounded-lg p-4 mb-4">
                <p class="text-6xl font-bold tracking-widest">${gamePin}</p>
            </div>
            <div class="w-full max-w-md bg-white/20 p-4 rounded-lg">
                <h3 class="text-xl font-semibold mb-2">ผู้เล่นที่เข้าร่วม (<span id="player-count">0</span>)</h3>
                <div id="player-list-lobby" class="flex flex-wrap justify-center gap-2">
                    </div>
            </div>
            <button id="start-game-btn" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-2xl transition-transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                <i class="fas fa-play"></i> เริ่มการแข่งขัน
            </button>
        </div>
    `;
    liveGameView.innerHTML = lobbyHTML;

    // --- ส่วนของ Event Listener ที่มีการอัปเดต ---
    document.getElementById('start-game-btn').addEventListener('click', async () => {
        if (!currentQuizData || !currentQuizData.questions || currentQuizData.questions.length === 0) {
            showMessage("เกิดข้อผิดพลาด: ไม่พบข้อมูลคำถามสำหรับเกมนี้");
            return;
        }
        
        try {
            // 1. อัปเดตฐานข้อมูลสำหรับผู้เล่น (เหมือนเดิม)
            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            await updateDoc(gameRef, {
                status: 'question',
                currentQuestionIndex: 0,
                questionDisplayedAt: serverTimestamp()
            });

            // 2. สั่งให้หน้าจอ Admin แสดงคำถามข้อแรกทันที (ส่วนที่เพิ่มเข้ามา)
            const firstQuestion = currentQuizData.questions[0];
            const totalQuestions = currentQuizData.questions.length;
            showAdminLiveQuestionView(firstQuestion, 0, totalQuestions);

        } catch (error) {
            console.error("Error starting game:", error);
            showMessage("ไม่สามารถเริ่มเกมได้");
        }
    });
}

async function openGlobalLiveModal() {
  // อ่านแบบทดสอบทุกโปรเจค (ดึงครั้งแรกครั้งเดียว)
  if (allQuizzesGlobal.length === 0) {
    const qs = await getDocs(collection(db, `artifacts/${appId}/public/data/quizzes`));
    allQuizzesGlobal = qs.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  renderGlobalQuizList('');
  document.getElementById('global-live-game-modal').classList.remove('hidden');
}

function renderGlobalQuizList(filterText = '') {
  const listEl = document.getElementById('global-quiz-list');
  const term = filterText.toLowerCase().trim();

  // เติมชื่อโปรเจคให้แต่ละ quiz จาก allProjects ที่ listen ไว้แล้ว
  const rows = allQuizzesGlobal
    .map(q => ({
      ...q,
      projectName: (allProjects.find(p => p.id === q.projectId)?.projectName) || q.projectId
    }))
    .filter(q =>
      (q.topic || '').toLowerCase().includes(term) ||
      (q.projectName || '').toLowerCase().includes(term)
    );

  listEl.innerHTML = rows.length
    ? rows.map(q => `
        <button data-id="${q.id}"
                class="w-full text-left p-2 border-b hover:bg-gray-50 flex items-center justify-between">
          <div>
            <div class="font-semibold">
  ${q.topic || '(ไม่มีชื่อ)'}
  <span class="text-sm font-normal text-gray-500">(${(q.questions?.length || 0)} ข้อ)</span>
</div>
            <div class="text-xs text-gray-500">โปรเจค: ${q.projectName}</div>
          </div>
          <i class="fas fa-play text-purple-600"></i>
        </button>
      `).join('')
    : `<div class="p-3 text-gray-500">ไม่พบแบบทดสอบ</div>`;

  selectedGlobalQuizId = null;
  document.getElementById('confirm-global-live-btn').disabled = true;

  // เลือกรายการ
  listEl.querySelectorAll('button[data-id]').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedGlobalQuizId = btn.dataset.id;
      listEl.querySelectorAll('button').forEach(b => b.classList.remove('bg-purple-50','ring-2','ring-purple-400'));
      btn.classList.add('bg-purple-50','ring-2','ring-purple-400');
      document.getElementById('confirm-global-live-btn').disabled = false;
    });
  });
}

        function listenForLiveGameUpdates() {
            if (unsubscribeLiveGameListener) unsubscribeLiveGameListener(); 

            const gameRef = doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId);
            unsubscribeLiveGameListener = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showMessage("เกมสิ้นสุดลงแล้ว");
                    showView(currentMode); 
                    return;
                }

                const gameData = docSnap.data();

                if (!currentQuizData && gameData.quizId) {
                    (async () => {
                        try {
                            const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, gameData.quizId);
                            const quizDocSnap = await getDoc(quizDocRef);
                            if (quizDocSnap.exists()) {
                                currentQuizData = { id: quizDocSnap.id, ...quizDocSnap.data() };
                            }
                        } catch (e) { console.error('Failed to fetch quiz for admin:', e); }
                    })();
                }

                switch (gameData.status) {
                    case 'lobby':
                        if (currentMode === 'admin') {
                            const players = gameData.players ? Object.keys(gameData.players) : [];
                            document.getElementById('player-count').textContent = players.length;
                            document.getElementById('player-list-lobby').innerHTML = players.map(name => `<span class="bg-white/30 px-3 py-1 rounded-full text-sm">${name}</span>`).join('');
                            const startGameBtn = document.getElementById('start-game-btn');
							if (startGameBtn) {
								startGameBtn.disabled = players.length === 0;
							}
                        } else {
                            showView('live-game');
                            liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
                                <h2 class="text-3xl font-bold">คุณเข้าร่วมแล้ว!</h2>
                                <p class="text-xl mt-2">ชื่อของคุณคือ: <span class="font-bold">${currentStudentName}</span></p>
                                <p class="mt-8">รอผู้ควบคุมเริ่มเกมสักครู่...</p>
                                <div class="loader mt-4"></div>
                            </div>`;
                        }
                        break;

                    case 'question':
						const questionIndex = gameData.currentQuestionIndex;
						if (currentQuizData && currentQuizData.questions[questionIndex]) {
							const questionData = currentQuizData.questions[questionIndex];
							const totalQuestions = currentQuizData.questions.length;
							
							if (currentMode === 'admin') {
								// ตรวจสอบว่าคำถามข้อปัจจุบันถูกวาดไปแล้วหรือยัง โดยใช้ index
								if (lastRenderedAdminQuestionIndex !== questionIndex) {
									showAdminLiveQuestionView(questionData, questionIndex, totalQuestions);
									lastRenderedAdminQuestionIndex = questionIndex; // บันทึกว่าวาดข้อนี้ไปแล้ว
								}
								
								// อัปเดตเฉพาะตัวนับจำนวนผู้เล่น
								const answerCounterEl = document.getElementById('answer-counter');
								if (answerCounterEl && gameData.players) {
									const totalPlayers = Object.keys(gameData.players).length;
									const answeredPlayers = Object.values(gameData.players).filter(p => p.answeredCurrentQuestion === true).length;
									answerCounterEl.textContent = `${answeredPlayers}/${totalPlayers}`;

									// ตรวจสอบว่าผู้เล่นตอบครบทุกคนหรือยัง (Logic เฉลยอัตโนมัติ)
									if (totalPlayers > 0 && answeredPlayers === totalPlayers && gameData.questionStatus !== 'revealed') {
										revealAnswerForAdmin(questionIndex, totalQuestions);
									}
								}
							} else {
								// ... (โค้ดฝั่งนักเรียนเหมือนเดิม) ...
                                const playerData = gameData.players[currentStudentName];
								
								if (gameData.questionStatus === 'revealed') {
									if (playerData.answeredCurrentQuestion) {
										const wasCorrect = playerData.lastAnswerCorrect;
										const pointsEarned = playerData.pointsLastQuestion || 0;
										const resultText = wasCorrect 
											? `คำตอบถูกต้อง! +${pointsEarned} คะแนน` 
											: 'คำตอบผิด';
										liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
											<h2 class="text-3xl font-bold">${resultText}</h2>
											<p class="mt-8">รอผู้ควบคุมไปข้อต่อไป...</p>
											<div class="loader mt-4"></div>
										 </div>`;
									} else {
										liveGameView.innerHTML = `<div class="live-game-bg text-white rounded-lg p-8 text-center flex flex-col items-center justify-center h-full">
											<h2 class="text-3xl font-bold">หมดเวลา!</h2>
											<p class="mt-8">รอผู้ควบคุมเฉลยและไปข้อต่อไป...</p>
											<div class="loader mt-4"></div>
										 </div>`;
									}
								} else {
									if (!playerData.answeredCurrentQuestion) {
										showStudentLiveQuestionView(questionData, questionIndex, totalQuestions);
									}
								}
							}
						}
						break;
						
                    case 'podium':
                        showPodiumView(gameData.players);
                        break;       
                }
            });
        }

        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage("การยืนยันตัวตนล้มเหลว");
            }
        }

        // --- UI & Mode Switching ---
        function showView(view) {
            const allViews = ['admin-view', 'student-view', 'project-dashboard-view', 'project-detail-view', 'quiz-results-view', 'live-game-view'];
            allViews.forEach(v => document.getElementById(v)?.classList.add('hidden'));

            if (view === 'admin-dashboard') {
                adminView.classList.remove('hidden');
                projectDashboardView.classList.remove('hidden');
            } else if (view === 'student') {
                studentView.classList.remove('hidden');
                studentInitialView.classList.remove('hidden');
                studentNameSelectionView.classList.add('hidden');
                studentQuizArea.classList.add('hidden');
                studentResultArea.classList.add('hidden');
                studentReadingArea.classList.add('hidden');
                studentJoinGameView.classList.add('hidden');
            } else if (view === 'project-detail') {
                adminView.classList.remove('hidden');
                projectDetailView.classList.remove('hidden');
            } else if (view === 'quiz-results') {
                adminView.classList.remove('hidden');
                quizResultsView.classList.remove('hidden');
            } else if (view === 'live-game') {
                liveGameView.classList.remove('hidden');
            }
        }
        
        function showJoinGameView() {
            studentInitialView.classList.add('hidden');
            studentJoinGameView.classList.remove('hidden');
        }
        
        function setupEventListeners() {
            // New unified mode switcher
            document.getElementById('mode-switcher-btn').addEventListener('click', handleModeSwitch);

            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                currentProjectId = null;
                currentProjectData = null;
                if (unsubscribeStudentsListener) unsubscribeStudentsListener();
                if (unsubscribeQuizzesListener) unsubscribeQuizzesListener();
                if (unsubscribeStudentProfilesListener) unsubscribeStudentProfilesListener();
                showView('admin-dashboard');
            });
            document.getElementById('back-to-project-btn').addEventListener('click', () => {
                if (unsubscribeSubmissionsListener) unsubscribeSubmissionsListener();
                showView('project-detail');
            });

            document.getElementById('back-to-dashboard-from-results-btn').addEventListener('click', () => {
                showView('admin-dashboard');
            });
            
            // Modals
            document.getElementById('modal-close-btn').addEventListener('click', () => messageModal.classList.add('hidden'));
            document.getElementById('create-project-btn').addEventListener('click', () => createProjectModal.classList.remove('hidden'));
            document.getElementById('cancel-create-project-btn').addEventListener('click', () => createProjectModal.classList.add('hidden'));
            
            // Admin Password Modal
            document.getElementById('cancel-admin-login-btn').addEventListener('click', () => adminPasswordModal.classList.add('hidden'));
            document.getElementById('confirm-admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-password-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });

            // Confirmation Modal
            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
                confirmAction = null;
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                if (confirmAction) {
                    confirmAction();
                }
                confirmationModal.classList.add('hidden');
                confirmAction = null;
            });

            // Modal Listeners
            document.getElementById('cancel-rename-quiz-btn').addEventListener('click', () => renameQuizModal.classList.add('hidden'));
            document.getElementById('confirm-rename-quiz-btn').addEventListener('click', confirmRenameQuiz);
            document.getElementById('cancel-move-quiz-btn').addEventListener('click', () => moveQuizModal.classList.add('hidden'));
            document.getElementById('confirm-move-quiz-btn').addEventListener('click', confirmMoveQuiz);
            document.getElementById('cancel-quiz-settings-btn').addEventListener('click', () => quizSettingsModal.classList.add('hidden'));
            document.getElementById('confirm-quiz-settings-btn').addEventListener('click', confirmQuizSettings);
            document.getElementById('cancel-quiz-status-btn').addEventListener('click', () => quizStatusModal.classList.add('hidden'));
            document.getElementById('confirm-quiz-status-btn').addEventListener('click', confirmQuizStatus);
			// เปิด modal เลือกแบบทดสอบทุกโปรเจค
            document.getElementById('open-global-live-btn')
            .addEventListener('click', openGlobalLiveModal);

            // ปุ่มใน modal
            document.getElementById('cancel-global-live-btn')
            .addEventListener('click', () => {
                document.getElementById('global-live-game-modal').classList.add('hidden');
                selectedGlobalQuizId = null;
            });

            document.getElementById('global-quiz-search-input')
            .addEventListener('input', (e) => renderGlobalQuizList(e.target.value));

            document.getElementById('confirm-global-live-btn')
            .addEventListener('click', () => {
                const id = selectedGlobalQuizId;
                if (!id) return;
                document.getElementById('global-live-game-modal').classList.add('hidden');
                handleStartLiveRace(id); // ใช้ฟังก์ชันเดิมในการเริ่มเกม
            });  
            // Search and Sort Listeners
            document.getElementById('project-search-input').addEventListener('input', renderProjects);
            document.getElementById('project-sort-select').addEventListener('change', renderProjects);
            document.getElementById('quiz-search-input').addEventListener('input', renderQuizzes);


            // Project Detail Tabs
            manageTab.addEventListener('click', () => switchProjectTab('manage'));
            resultsTab.addEventListener('click', () => switchProjectTab('results'));
            leaderboardTab.addEventListener('click', () => switchProjectTab('leaderboard'));

            // Quiz Results Tabs
            document.getElementById('analytics-tab-btn').addEventListener('click', () => switchQuizDetailTab('analytics'));
            document.getElementById('scores-tab-btn').addEventListener('click', () => switchQuizDetailTab('scores'));
            document.getElementById('leaderboard-quiz-tab-btn').addEventListener('click', () => switchQuizDetailTab('leaderboard-quiz'));
            document.getElementById('analyze-strengths-btn').addEventListener('click', handleAnalyzeClass);
            generateWorksheetBtn.addEventListener('click', generateWorksheet);
            
            // --- START: โค้ดที่เพิ่มสำหรับฟีเจอร์ "สร้างจากลิงก์" ---
            const linkTab = document.getElementById('link-tab');
            const linkInputArea = document.getElementById('link-input-area');

            // Generation Tabs
            topicTab.addEventListener('click', () => {
                topicTab.classList.add('active');
                textTab.classList.remove('active');
                fileTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                topicInputArea.classList.remove('hidden');
                textInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
            });

            textTab.addEventListener('click', () => {
                textTab.classList.add('active');
                topicTab.classList.remove('active');
                fileTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                textInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
            });

            fileTab.addEventListener('click', () => {
                fileTab.classList.add('active');
                topicTab.classList.remove('active');
                textTab.classList.remove('active');
                worksheetTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                fileInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                textInputArea.classList.add('hidden');
                worksheetInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
            });
            
            worksheetTab.addEventListener('click', () => {
                worksheetTab.classList.add('active');
                topicTab.classList.remove('active');
                textTab.classList.remove('active');
                fileTab.classList.remove('active');
                if(linkTab) linkTab.classList.remove('active');
                worksheetInputArea.classList.remove('hidden');
                topicInputArea.classList.add('hidden');
                textInputArea.classList.add('hidden');
                fileInputArea.classList.add('hidden');
                if(linkInputArea) linkInputArea.classList.add('hidden');
            });

            const bankTab = document.getElementById('bank-tab');
            const bankInputArea = document.getElementById('bank-input-area');

            if(bankTab) {
                bankTab.addEventListener('click', () => {
                    // Deactivate other tabs
                    topicTab.classList.remove('active');
                    textTab.classList.remove('active');
                    fileTab.classList.remove('active');
                    worksheetTab.classList.remove('active');
                    if(linkTab) linkTab.classList.remove('active');
                    
                    // Activate this tab
                    bankTab.classList.add('active');

                    // Hide other input areas
                    topicInputArea.classList.add('hidden');
                    textInputArea.classList.add('hidden');
                    fileInputArea.classList.add('hidden');
                    worksheetInputArea.classList.add('hidden');
                    if(linkInputArea) linkInputArea.classList.add('hidden');

                    // Show this input area and load the questions
                    bankInputArea.classList.remove('hidden');
                    displayQuestionBank(); 
                });
            }

            if(linkTab) {
                linkTab.addEventListener('click', () => {
                    topicTab.classList.remove('active');
                    textTab.classList.remove('active');
                    fileTab.classList.remove('active');
                    worksheetTab.classList.remove('active');
                    linkTab.classList.add('active');
                    topicInputArea.classList.add('hidden');
                    textInputArea.classList.add('hidden');
                    fileInputArea.classList.add('hidden');
                    worksheetInputArea.classList.add('hidden');
                    linkInputArea.classList.remove('hidden');
                });
                document.getElementById('generate-from-link-btn').addEventListener('click', handleGenerateFromLink);
            }
            // --- END: โค้ดที่เพิ่มสำหรับฟีเจอร์ "สร้างจากลิงก์" ---

            // Student flow buttons
            loadQuizBtn.addEventListener('click', handleLoadQuiz);
            startQuizBtn.addEventListener('click', () => {
                const studentNameSelect = document.getElementById('student-name-select');
                currentStudentName = studentNameSelect.value;
                if (!currentStudentName) {
                    showMessage("กรุณาเลือกชื่อของคุณ");
                    return;
                }
                studentNameSelectionView.classList.add('hidden');
                quizStartTime = new Date(); // Record start time for speed bonus
                displayQuizForStudent(currentQuizData);
            });
            // NEW: Live Game Listeners
            document.getElementById('join-live-game-btn').addEventListener('click', showJoinGameView);
            document.getElementById('confirm-join-game-btn').addEventListener('click', handleJoinLiveGame);
            document.getElementById('back-to-student-initial-btn').addEventListener('click', () => showView('student'));


            // === START: อัปเดตส่วน Event Listeners ของปุ่ม Export ทั้งหมด ===
            
            // Helper function for Scores Table filename
            const getResultsFilename = () => {
                const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                return `results_${quizTitle || 'quiz'}`;
            };

            // Export buttons for Scores Table (CHANGED)
            document.getElementById('export-image-btn').addEventListener('click', () => exportTableAsImage('results-table-container', getResultsFilename()));
            document.getElementById('export-pdf-btn').addEventListener('click', () => exportTableAsPDF('results-table', getResultsFilename()));
            document.getElementById('export-word-btn').addEventListener('click', () => exportTableAsWord('results-table-container', getResultsFilename()));
            document.getElementById('export-excel-btn').addEventListener('click', () => exportTableAsExcel('results-table', getResultsFilename()));
            
            // Helper function for Leaderboard Table filename
            const getLeaderboardFilename = () => {
                const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                return `leaderboard_${quizTitle || 'quiz'}`;
            };
            
            // Export buttons for Leaderboard Table (NEW)
            document.getElementById('export-leaderboard-image-btn').addEventListener('click', () => exportTableAsImage('quiz-leaderboard-table-container', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-pdf-btn').addEventListener('click', () => exportTableAsPDF('quiz-leaderboard-table', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-word-btn').addEventListener('click', () => exportTableAsWord('quiz-leaderboard-table-container', getLeaderboardFilename()));
            document.getElementById('export-leaderboard-excel-btn').addEventListener('click', () => exportTableAsExcel('quiz-leaderboard-table', getLeaderboardFilename()));
            
            // === END: อัปเดตส่วน Event Listeners ของปุ่ม Export ทั้งหมด ===


            // Event delegation for project quizzes list
            projectQuizzesList.addEventListener('click', async (e) => {
                const starBtn = e.target.closest('.star-quiz-btn');
                const deleteBtn = e.target.closest('.delete-quiz-btn');
                const copyBtn = e.target.closest('.copy-quiz-id-list-btn');
                const presentBtn = e.target.closest('.start-presentation-list-btn');
                const tryQuizBtn = e.target.closest('.admin-try-quiz-list-btn');
                const renameBtn = e.target.closest('.rename-quiz-btn');
                const moveBtn = e.target.closest('.move-quiz-btn');
                const settingsBtn = e.target.closest('.quiz-settings-btn');
                const statusBtn = e.target.closest('.quiz-status-btn');
                const duplicateBtn = e.target.closest('.duplicate-quiz-btn');
                const liveRaceBtn = e.target.closest('.start-live-race-btn'); // NEW
				const editBtn = e.target.closest('.edit-quiz-btn'); // <-- เพิ่มบรรทัดนี้เข้ามา
				
				if (editBtn) {
    const quizId = editBtn.dataset.quizId;
    handleOpenQuizEditor(quizId);
                } else if (starBtn) {
                    const quizId = starBtn.dataset.quizId;
                    handleToggleStarQuiz(quizId);
                } else if (liveRaceBtn) {
                    const quizId = liveRaceBtn.dataset.quizId;
                    handleStartLiveRace(quizId);
                } else if (deleteBtn) {
                    const quizId = deleteBtn.dataset.quizId;
                    const quizTopic = deleteBtn.dataset.topic;
                      showConfirmation(
                        `คุณแน่ใจหรือไม่ว่าต้องการลบแบบทดสอบ "${quizTopic}"? ผลการส่งงานทั้งหมดของแบบทดสอบนี้จะถูกลบอย่างถาวร`,
                        () => handleDeleteQuiz(quizId)
                    );
                } else if (copyBtn) {
                    const quizId = copyBtn.dataset.quizId;
                    copyTextToClipboard(quizId, "คัดลอกรหัสแล้ว!");
                } else if (presentBtn) {
                    const quizId = presentBtn.dataset.quizId;
                    const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                    const quizDocSnap = await getDoc(quizDocRef);
                    if (quizDocSnap.exists()) {
                        const sanitizedData = sanitizeQuizData({ id: quizDocSnap.id, ...quizDocSnap.data() });
                        startPresentation(sanitizedData);
                    } else {
                        showMessage("ไม่พบข้อมูลแบบทดสอบ");
                    }
                } else if (tryQuizBtn) {
                    const quizId = tryQuizBtn.dataset.quizId;
                    const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                    const quizDocSnap = await getDoc(quizDocRef);
                    if (quizDocSnap.exists()) {
                        currentQuizData = sanitizeQuizData({id: quizDocSnap.id, ...quizDocSnap.data()}); // Set the global quiz data
                        startAdminTest();
                    } else {
                        showMessage("ไม่พบข้อมูลแบบทดสอบ");
                    }
                } else if (renameBtn) {
                    const quizId = renameBtn.dataset.quizId;
                    const topic = renameBtn.dataset.topic;
                    handleRenameQuiz(quizId, topic);
                } else if (moveBtn) {
                    const quizId = moveBtn.dataset.quizId;
                    handleMoveQuiz(quizId);
                } else if (settingsBtn) {
                    const quizId = settingsBtn.dataset.quizId;
                    handleQuizSettings(quizId);
                } else if (statusBtn) {
                    const quizId = statusBtn.dataset.quizId;
                    handleQuizStatus(quizId);
                } else if (duplicateBtn) {
                    const quizId = duplicateBtn.dataset.quizId;
                    handleDuplicateQuiz(quizId);
                }
            });

            // Presentation Mode Listeners
            document.getElementById('close-presentation-btn').addEventListener('click', closePresentation);
            document.getElementById('prev-question-btn').addEventListener('click', () => {
                if (currentPresentationSlide > 0) {
                    currentPresentationSlide--;
                    renderPresentationSlide(currentPresentationSlide);
                }
            });
            document.getElementById('next-question-btn').addEventListener('click', () => {
                if (currentQuizData.questions && currentPresentationSlide < currentQuizData.questions.length - 1) {
                    currentPresentationSlide++;
                    renderPresentationSlide(currentPresentationSlide);
                }
            });
            // Handle exiting fullscreen with ESC key
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    presentationModal.style.display = 'none';
                }
            });
            
            // Student Deletion Listeners
            document.getElementById('delete-all-students-btn').addEventListener('click', handleDeleteAllStudents);
            studentList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-student-btn');
                if (deleteBtn) {
                    const studentName = deleteBtn.dataset.studentName;
                    handleDeleteStudent(studentName);
                }
            });
            
            fileUploadInput.addEventListener('change', handleFileUpload);

            // Timer Settings Listener
            document.getElementById('timer-mode-select').addEventListener('change', (e) => {
                const durationContainer = document.getElementById('timer-duration-container');
                const durationLabel = document.getElementById('timer-duration-label');
                const durationInput = document.getElementById('timer-duration-input');
                if (e.target.value === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                    if (e.target.value === 'whole_quiz') {
                        durationLabel.textContent = 'ระยะเวลา (นาที):';
                        durationInput.value = '10';
                    } else { // per_question
                        durationLabel.textContent = 'ระยะเวลา (วินาที):';
                        durationInput.value = '30';
                    }
                }
            });
            
            // Quiz Type Selector Listener
            document.getElementById('quiz-type-select').addEventListener('change', (e) => {
                const numChoicesContainer = document.getElementById('num-choices-container');
                const type = e.target.value;
                const numQuestionsLabel = document.querySelector('label[for="num-questions"]');
                const passingScoreInput = document.getElementById('passing-score-input');
                const numQuestionsInput = document.getElementById('num-questions');

                if (type === 'matching') {
                    numQuestionsLabel.textContent = 'จำนวนคู่:';
                } else {
                    numQuestionsLabel.textContent = 'จำนวนข้อ:';
                }

                if (type === 'multiple_choice' || type === 'fill_in_with_choices' || type === 'mixed') {
                    numChoicesContainer.classList.remove('hidden');
                } else {
                    numChoicesContainer.classList.add('hidden');
                }
                
                // Update max for passing score
                passingScoreInput.max = numQuestionsInput.value;
            });

            document.getElementById('num-questions').addEventListener('input', (e) => {
                document.getElementById('passing-score-input').max = e.target.value;
            });


            // Modal Timer Settings Listener
            document.getElementById('modal-timer-mode-select').addEventListener('change', (e) => {
                const durationContainer = document.getElementById('modal-timer-duration-container');
                const durationLabel = document.getElementById('modal-timer-duration-label');
                const durationInput = document.getElementById('modal-timer-duration-input');
                if (e.target.value === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                    if (e.target.value === 'whole_quiz') {
                        durationLabel.textContent = 'ระยะเวลา (นาที):';
                    } else { // per_question
                        durationLabel.textContent = 'ระยะเวลา (วินาที):';
                    }
                }
            });
			
			// Event Listeners for Quiz Editor Modal
            document.getElementById('cancel-quiz-edits-btn').addEventListener('click', () => {
                document.getElementById('quiz-editor-modal').classList.add('hidden');
            });
            document.getElementById('cancel-quiz-edits-btn-footer').addEventListener('click', () => {
                document.getElementById('quiz-editor-modal').classList.add('hidden');
            });
            document.getElementById('save-quiz-edits-btn').addEventListener('click', () => {
                // เพิ่มบรรทัดนี้: สั่งให้หน้าต่างแก้ไขหายไปก่อน
                document.getElementById('quiz-editor-modal').classList.add('hidden');

                // จากนั้นค่อยเรียกหน้าต่างยืนยันตามปกติ
                showConfirmation(
                    'การแก้ไขแบบทดสอบจะทำให้ผลการสอบเก่าไม่สอดคล้องกับคำถามและเฉลยชุดใหม่ ซึ่งอาจทำให้การแสดงผลคะแนนเก่าเกิดความสับสนได้ คุณต้องการบันทึกการเปลี่ยนแปลงหรือไม่?',
                    handleSaveChanges
                )
            });
        }
        
        function handleModeSwitch() {
            const switcherBtn = document.getElementById('mode-switcher-btn');
            if (currentMode === 'student') {
                // If in student mode, try to switch to admin
                currentMode = 'admin';
switcherBtn.innerHTML = `<i class="fas fa-user-graduate fa-lg"></i>`;
switcherBtn.title = "สลับไปโหมดนักเรียน";
showView('admin-dashboard');
            } else {
                // If in admin mode, switch back to student
                currentMode = 'student';
                switcherBtn.innerHTML = `<i class="fas fa-user-shield fa-lg"></i>`;
                switcherBtn.title = "สลับไปโหมดผู้ควบคุม";
                showView('student');
            }
        }

        function handleAdminLogin() {
            const passInput = document.getElementById('admin-password-input');
            const errorMsg = document.getElementById('password-error-msg');
            // This is a simple, non-secure password. In a real app, use a proper auth system.
            if (passInput.value === '2741') {
                adminPasswordModal.classList.add('hidden');
                passInput.value = '';
                errorMsg.classList.add('hidden');
                
                // Update mode and button
                currentMode = 'admin';
                const switcherBtn = document.getElementById('mode-switcher-btn');
                switcherBtn.innerHTML = `<i class="fas fa-user-graduate fa-lg"></i>`;
                switcherBtn.title = "สลับไปโหมดนักเรียน";
                
                showView('admin-dashboard');
            } else {
                errorMsg.classList.remove('hidden');
                passInput.value = '';
            }
        }

        function switchProjectTab(tabName) {
            ['manage', 'results', 'leaderboard'].forEach(name => {
                document.getElementById(`${name}-tab`).classList.remove('active');
                document.getElementById(`${name}-tab-content`).classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
        }

        // NEW: Function to switch tabs in the Quiz Detail view
        function switchQuizDetailTab(tabName) {
            const tabs = {
                'analytics': { btn: 'analytics-tab-btn', content: 'analytics-tab-content' },
                'scores': { btn: 'scores-tab-btn', content: 'scores-tab-content' },
                'leaderboard-quiz': { btn: 'leaderboard-quiz-tab-btn', content: 'leaderboard-quiz-tab-content' }
            };

            for (const key in tabs) {
                document.getElementById(tabs[key].btn).classList.remove('active');
                document.getElementById(tabs[key].content).classList.add('hidden');
            }

            document.getElementById(tabs[tabName].btn).classList.add('active');
            document.getElementById(tabs[tabName].content).classList.remove('hidden');
        }

        // --- Messaging & Confirmation ---
        function showMessage(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-modal').querySelector('h3').textContent = 'ยืนยันการกระทำ';
            confirmAction = onConfirm;
            confirmationModal.classList.remove('hidden');
        }
        
        // --- Project Management (Shared/Public) ---
        function listenForProjects() {
            const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
            unsubscribeProjectsListener = onSnapshot(projectsRef, (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects();
            }, (error) => {
                console.error("Error listening for projects:", error);
                showMessage("เกิดข้อผิดพลาดในการโหลดโปรเจค");
            });
        }
        
 async function renderProjects() {
            const searchTerm = document.getElementById('project-search-input').value.toLowerCase();
            const sortBy = document.getElementById('project-sort-select').value;

            // 1. กรองและจัดเรียงโปรเจคจริง
            let filteredProjects = allProjects.filter(p => p.projectName.toLowerCase().includes(searchTerm));
            filteredProjects.sort((a, b) => {
                switch (sortBy) {
                    case 'name_asc': return a.projectName.localeCompare(b.projectName, 'th');
                    case 'name_desc': return b.projectName.localeCompare(a.projectName, 'th');
                    case 'date_asc': return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'date_desc': default: return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });

            // 2. นับจำนวนแบบทดสอบในแต่ละโปรเจคจริง
            const quizCounts = {};
            await Promise.all(
                filteredProjects.map(async (project) => {
                    const qref = query(collection(db, `artifacts/${appId}/public/data/quizzes`), where('projectId', '==', project.id));
                    const qsnap = await getDocs(qref);
                    quizCounts[project.id] = qsnap.size;
                })
            );

            let html = '';

            // 3. สร้างการ์ดสำหรับ "โปรเจคที่ติดดาว" หากมี
            if (starredQuizzes.length > 0) {
                html += `
                <div class="project-card-container bg-indigo-50 border-indigo-200 p-4 rounded-lg shadow hover:shadow-lg transition-all duration-300 flex flex-col justify-between">
                    <div class="project-card-content cursor-pointer" data-id="starred-project">
                    <h4 class="font-bold text-lg text-indigo-800 pointer-events-none">แบบทดสอบที่ติดดาว <i class="fas fa-star text-yellow-400"></i></h4>
                    <p class="text-sm text-gray-500 pointer-events-none">ทางลัดสำหรับแบบทดสอบที่ใช้บ่อย</p>
                    <p class="text-sm text-gray-700 mt-1 pointer-events-none"><i class="fas fa-file mr-1"></i> ${starredQuizzes.length} แบบทดสอบ</p>
                    </div>
                    <div class="text-right mt-2 h-6">
                    </div>
                </div>
                `;
            }

            // 4. สร้างการ์ดสำหรับโปรเจคจริง
            filteredProjects.forEach(project => {
                const count = quizCounts[project.id] ?? 0;
                html += `
                <div class="project-card-container bg-white p-4 rounded-lg shadow hover:shadow-lg transition-all duration-300 border border-gray-200 flex flex-col justify-between">
                    <div class="project-card-content cursor-pointer" data-id="${project.id}">
                    <h4 class="font-bold text-lg text-indigo-800 pointer-events-none">${project.projectName}</h4>
                    <p class="text-sm text-gray-500 pointer-events-none">สร้างเมื่อ: ${new Date(project.createdAt).toLocaleDateString('th-TH')}</p>
                    <p class="text-sm text-gray-700 mt-1 pointer-events-none"><i class="fas fa-file mr-1"></i> ${count} แบบทดสอบ</p>
                    </div>
                    <div class="text-right mt-2">
                    <button data-id="${project.id}" data-name="${project.projectName}" class="delete-project-btn text-red-500 hover:text-red-700 text-sm p-1">
                        <i class="fas fa-trash-alt"></i> ลบ
                    </button>
                    </div>
                </div>
                `;
            });

            // 5. แสดงผลลัพธ์
            projectList.innerHTML = html;
            noProjectsMsg.classList.toggle('hidden', html.length > 0);
        }

        document.getElementById('confirm-create-project-btn').addEventListener('click', async () => {
            const projectNameInput = document.getElementById('project-name-input');
            const projectName = projectNameInput.value.trim();
            if (!projectName) {
                showMessage("กรุณาใส่ชื่อโปรเจค");
                return;
            }
            try {
                const newProjectRef = doc(collection(db, `artifacts/${appId}/public/data/projects`));
                await setDoc(newProjectRef, {
                    projectName: projectName,
                    students: [],
                    settings: {
                        resultsDisplay: 'show_results_and_answers',
                        shuffleSetting: 'none',
                        defaultNumQuestions: 5,
                        defaultNumChoices: 4,
                        defaultPassingScore: 3, // Default passing score
                        timerMode: 'none',
                        timerDuration: 10,
                    },
                    createdBy: userId, // Keep track of who created it
                    createdAt: new Date().toISOString()
                });
                projectNameInput.value = '';
                createProjectModal.classList.add('hidden');
                showMessage("สร้างโปรเจคสำเร็จ!");
            } catch (error) {
                console.error("Error creating project:", error);
                showMessage("ไม่สามารถสร้างโปรเจคได้");
            }
        });

        projectList.addEventListener('click', async (e) => {
            const cardContent = e.target.closest('.project-card-content');
            const deleteBtn = e.target.closest('.delete-project-btn');

            if (cardContent) {
                const projectId = cardContent.dataset.id;
                if (projectId === 'starred-project') {
                    // ถ้าคลิกโปรเจคที่ติดดาว ให้เรียกฟังก์ชันพิเศษ
                    showStarredProjectView();
                } else {
                    // ถ้าเป็นโปรเจคปกติ ทำงานเหมือนเดิม
                    currentProjectId = projectId;
                    await loadProjectDetails(currentProjectId);
                    showView('project-detail');
                }
            } else if (deleteBtn) {
                const projectId = deleteBtn.dataset.id;
                const projectName = deleteBtn.dataset.name;
                showConfirmation(
                    `คุณแน่ใจหรือไม่ว่าต้องการลบโปรเจค "${projectName}"? ข้อมูลทั้งหมดในโปรเจคนี้ (รวมถึงแบบทดสอบและผลการส่งงาน) จะถูกลบอย่างถาวร`,
                    () => handleDeleteProject(projectId)
                );
            }
        });

function showStarredProjectView() {
            currentProjectId = 'starred'; // ตั้ง ID พิเศษ
            currentProjectData = null; // ไม่มีข้อมูลโปรเจคจริงๆ

            // ตั้งค่าหัวข้อและแสดง view
            projectTitle.textContent = 'แบบทดสอบที่ติดดาว';
            projectIdDisplay.textContent = 'pinned-items';
            showView('project-detail');

            // ซ่อนแท็บที่ไม่เกี่ยวข้อง
            manageTab.classList.add('hidden');
            leaderboardTab.classList.add('hidden');
            
            // บังคับให้ไปที่แท็บ "ผลลัพธ์" (ซึ่งก็คือรายการแบบทดสอบ)
            switchProjectTab('results');
			renderQuizzes(); // สั่งให้วาดรายการแบบทดสอบใหม่ด้วยข้อมูลที่ถูกต้อง
        }

        async function loadProjectDetails(projectId) {
            const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
            const docSnap = await getDoc(projectRef);
            if (docSnap.exists()) {
			                manageTab.classList.remove('hidden');
                leaderboardTab.classList.remove('hidden');
                currentProjectData = docSnap.data();
                projectTitle.textContent = currentProjectData.projectName;
                projectIdDisplay.textContent = projectId;
                
                // Load settings, providing defaults if they don't exist
                const settings = currentProjectData.settings || {};
                document.getElementById('num-questions').value = settings.defaultNumQuestions || 5;
                document.getElementById('num-choices').value = settings.defaultNumChoices || 4;
                document.getElementById('passing-score-input').value = settings.defaultPassingScore || Math.floor((settings.defaultNumQuestions || 5) / 2);
                document.getElementById('passing-score-input').max = settings.defaultNumQuestions || 5;
                document.getElementById('results-display-select').value = settings.resultsDisplay || 'show_results_and_answers';
                document.getElementById('shuffle-setting-select').value = settings.shuffleSetting || 'none';

                // Load timer settings
                const timerMode = settings.timerMode || 'none';
                const timerDuration = settings.timerDuration || 10;
                const timerModeSelect = document.getElementById('timer-mode-select');
                const durationContainer = document.getElementById('timer-duration-container');
                const durationInput = document.getElementById('timer-duration-input');
                
                timerModeSelect.value = timerMode;
                durationInput.value = timerDuration;

                if (timerMode === 'none') {
                    durationContainer.classList.add('hidden');
                } else {
                    durationContainer.classList.remove('hidden');
                }
                // Trigger change to set label correctly
                timerModeSelect.dispatchEvent(new Event('change'));


                if (unsubscribeStudentsListener) unsubscribeStudentsListener();
                if (unsubscribeQuizzesListener) unsubscribeQuizzesListener();
                if (unsubscribeStudentProfilesListener) unsubscribeStudentProfilesListener();
                listenForStudents(projectId);
                listenForProjectQuizzes(projectId);
                listenForStudentProfiles(projectId); // For Leaderboard
            } else {
                showMessage("ไม่พบโปรเจค");
                showView('admin-dashboard');
            }
        }

        async function handleDeleteProject(projectId) {
            try {
                const batch = writeBatch(db);
                // 1. Find all quizzes associated with the project
                const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
                const q = query(quizzesRef, where("projectId", "==", projectId));
                const quizSnapshot = await getDocs(q);

                // 2. For each quiz, find and delete its submissions, then the quiz itself
                for (const quizDoc of quizSnapshot.docs) {
                    // Delete submissions
                    const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${quizDoc.id}/submissions`);
                    const submissionsSnapshot = await getDocs(submissionsRef);
                    submissionsSnapshot.forEach(subDoc => {
                        batch.delete(subDoc.ref);
                    });
                    // Delete quiz
                    batch.delete(quizDoc.ref);
                }

                // 3. Delete student profiles subcollection
                const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`);
                const profilesSnapshot = await getDocs(profilesRef);
                profilesSnapshot.forEach(profDoc => {
                    batch.delete(profDoc.ref);
                });

                // 4. Delete the project document
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
                batch.delete(projectRef);
                
                await batch.commit();

                showMessage("ลบโปรเจคสำเร็จแล้ว");
                showView('admin-dashboard'); // Go back to dashboard after deletion
            } catch (error) {
                console.error("Error deleting project:", error);
                showMessage("เกิดข้อผิดพลาดในการลบโปรเจค");
            }
        }
        
        // --- Settings & Student Management in Project ---
        document.getElementById('save-settings-btn').addEventListener('click', async () => {
            if (!currentProjectId) return;
            const settings = {
                defaultNumQuestions: parseInt(document.getElementById('num-questions').value),
                defaultNumChoices: parseInt(document.getElementById('num-choices').value),
                defaultPassingScore: parseInt(document.getElementById('passing-score-input').value),
                resultsDisplay: document.getElementById('results-display-select').value,
                shuffleSetting: document.getElementById('shuffle-setting-select').value,
                timerMode: document.getElementById('timer-mode-select').value,
                timerDuration: parseInt(document.getElementById('timer-duration-input').value)
            };
            try {
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                await updateDoc(projectRef, { settings });
                showMessage("บันทึกการตั้งค่าแล้ว");
            } catch (error) {
                console.error("Error saving settings:", error);
                showMessage("ไม่สามารถบันทึกการตั้งค่าได้");
            }
        });

        function listenForStudents(projectId) {
            const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
            unsubscribeStudentsListener = onSnapshot(projectRef, (doc) => {
                if (doc.exists()) {
                    const projectData = doc.data();
                    currentProjectData = projectData; 
                    renderStudentList(projectData.students || []); 
                }
            });
        }

        function renderStudentList(students) {
            const deleteAllBtn = document.getElementById('delete-all-students-btn');
            if (students.length === 0) {
                studentList.innerHTML = `<p class="text-gray-400 text-center p-2">ยังไม่มีนักเรียนในโปรเจคนี้</p>`;
                deleteAllBtn.classList.add('hidden');
            } else {
                studentList.innerHTML = students.map(name => `
                    <div class="flex justify-between items-center p-1 hover:bg-gray-100 rounded">
                        <span>${name}</span>
                        <button data-student-name="${name}" class="delete-student-btn text-red-500 hover:text-red-700 p-1 text-xs">
                            <i class="fas fa-times-circle pointer-events-none"></i>
                        </button>
                    </div>
                `).join('');
                deleteAllBtn.classList.remove('hidden');
            }
        }

        document.getElementById('add-student-btn').addEventListener('click', async () => {
            if (!currentProjectId) return;
            const studentNameInput = document.getElementById('student-name-input');
            const studentNamesText = studentNameInput.value.trim();
            if (!studentNamesText) {
                showMessage("กรุณาใส่ชื่อนักเรียน");
                return;
            }
            
            const newStudents = studentNamesText.split('\n').map(name => name.trim()).filter(name => name);
            if (newStudents.length === 0) return;

            try {
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                const docSnap = await getDoc(projectRef);
                if (docSnap.exists()) {
                    const currentStudents = docSnap.data().students || [];
                    const updatedStudents = [...new Set([...currentStudents, ...newStudents])];
                    await updateDoc(projectRef, { students: updatedStudents });
                    studentNameInput.value = '';
                }
            } catch (error) {
                console.error("Error adding students:", error);
                showMessage("ไม่สามารถเพิ่มนักเรียนได้");
            }
        });

        function handleDeleteStudent(studentName) {
            showConfirmation(
                `คุณแน่ใจหรือไม่ว่าต้องการลบนักเรียนชื่อ "${studentName}"? ข้อมูลคะแนนและป้ายรางวัลของนักเรียนคนนี้จะถูกลบไปด้วย`,
                async () => {
                    if (!currentProjectId || !currentProjectData) return;
                    const updatedStudents = currentProjectData.students.filter(s => s !== studentName);
                    try {
                        const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                        const studentProfileRef = doc(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/studentProfiles`, studentName);
                        
                        const batch = writeBatch(db);
                        batch.update(projectRef, { students: updatedStudents });
                        batch.delete(studentProfileRef); // Also delete their profile for the leaderboard
                        await batch.commit();

                    } catch (error) {
                        console.error("Error deleting student:", error);
                        showMessage("เกิดข้อผิดพลาดในการลบนักเรียน");
                    }
                }
            );
        }

        function handleDeleteAllStudents() {
            showConfirmation(
                `คุณแน่ใจหรือไม่ว่าต้องการลบนักเรียนทั้งหมดในโปรเจคนี้? การกระทำนี้ไม่สามารถย้อนกลับได้`,
                async () => {
                    if (!currentProjectId) return;
                    try {
                        const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, currentProjectId);
                        const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${currentProjectId}/studentProfiles`);
                        const profilesSnapshot = await getDocs(profilesRef);

                        const batch = writeBatch(db);
                        batch.update(projectRef, { students: [] });
                        profilesSnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();

                    } catch (error) {
                        console.error("Error deleting all students:", error);
                        showMessage("เกิดข้อผิดพลาดในการลบนักเรียนทั้งหมด");
                    }
                }
            );
        }

        // --- File Handling ---
        async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // ตรวจสอบประเภทไฟล์ที่รองรับ
    if (file.type !== "application/pdf" && !file.name.endsWith('.docx')) {
        showMessage("รูปแบบไฟล์ไม่รองรับ กรุณาเลือก PDF หรือ .docx");
        event.target.value = ''; // รีเซ็ต input
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    
    // แสดงสถานะกำลังโหลด
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = 'กำลังอ่านและเตรียมไฟล์...';
    
    // ใช้ FileReader เพื่อแปลงไฟล์เป็น Base64
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
        try {
            const base64String = reader.result.split(',')[1]; // แยกเอาเฉพาะข้อมูล base64
            const mimeType = file.type;
            
            // ส่งข้อมูลไฟล์ไปให้ AI สร้างแบบทดสอบ
            await generateQuizFromFile(mimeType, base64String);

        } catch (error) {
            console.error("Error processing file for AI:", error);
            showMessage(`เกิดข้อผิดพลาดในการเตรียมไฟล์: ${error.message}`);
            loader.classList.add('hidden');
        } finally {
            // รีเซ็ต input เพื่อให้สามารถเลือกไฟล์เดิมซ้ำได้
            event.target.value = '';
        }
    };
    reader.onerror = (error) => {
        console.error("FileReader error:", error);
        showMessage("เกิดข้อผิดพลาดในการอ่านไฟล์");
        loader.classList.add('hidden');
    };
}

/**
 * ฟังก์ชันสำหรับตรวจสอบและแก้ไขสตริงคณิตศาสตร์ที่ AI สร้างขึ้น
 * จะค้นหานิพจน์ที่ควรจะเป็น LaTeX แต่ยังไม่มีเครื่องหมาย $ ครอบ
 * @param {string} text - ข้อความที่ต้องการตรวจสอบ
 * @returns {string} ข้อความที่ผ่านการแก้ไขแล้ว
 */
function autoFormatMath(text) {
    if (typeof text !== 'string' || !text) {
        return text;
    }

    // Regex นี้จะมองหานิพจน์ที่พบบ่อยๆ เช่น "ตัวเลข \times ตัวเลข", "ตัวเลข^ตัวเลข", หรือคำสั่ง LaTeX 
    // โดยจะทำงานเฉพาะกับส่วนที่ยังไม่ได้ถูกครอบด้วยเครื่องหมาย $ อยู่แล้ว
    const mathPattern = /((?<!\$)\b(\d+(\.\d+)?\s*(\\times|\\div)\s*\d+(\.\d+)?|(\d+\s*\^\s*\{?\d+\}?)|(\\frac|\\sqrt|\\pm|\\geq|\\leq|\\neq))\b(?!\$))/g;

    let formattedText = text.replace(mathPattern, (match) => {
        // ครอบนิพจน์ที่หาเจอด้วยเครื่องหมาย $
        return `$${match.trim()}$`;
    });

    return formattedText;
}

        // --- Math Sanitization ---
        function sanitizeQuizData(quizData) {
            if (!quizData || !quizData.questions) return quizData;

            const replacements = {
                'imes': '\\times',
                'div': '\\div',
            };

            const sanitizeText = (text) => {
    if (typeof text !== 'string') return text;
    let sanitizedText = text;
    for (const [wrong, correct] of Object.entries(replacements)) {
        // Use word boundaries to avoid replacing parts of words, e.g., 'div' in 'division'.
        const regex = new RegExp(`\\b${wrong}\\b`, 'g');
        sanitizedText = sanitizedText.replace(regex, correct);
    }

    // --- เพิ่มโค้ดบรรทัดนี้เข้าไป ---
    sanitizedText = autoFormatMath(sanitizedText);

    return sanitizedText;
};

            if (quizData.topic) {
                quizData.topic = sanitizeText(quizData.topic);
            }
            quizData.questions.forEach(q => {
                q.questionText = sanitizeText(q.questionText);
                if (q.options) {
                    q.options = q.options.map(sanitizeText);
                }
                if (q.explanation) {
                    q.explanation = sanitizeText(q.explanation);
                }
                // NEW: Sanitize matching question types
                if (q.stem) {
                    q.stem = sanitizeText(q.stem);
                }
                if (q.correctResponse) {
                    q.correctResponse = sanitizeText(q.correctResponse);
                }
                if (q.allResponses) {
                    q.allResponses = q.allResponses.map(sanitizeText);
                }
            });

            return quizData;
        }

        // --- Quiz Generation (Admin) ---
        const mathPromptInstruction = "กฎเหล็ก: นิพจน์ทางคณิตศาสตร์ทั้งหมดต้องอยู่ในรูปแบบ LaTeX ที่ถูกต้อง และต้องถูกห่อหุ้มด้วยเครื่องหมายดอลลาร์ ($) เพียงคู่เดียว ตัวอย่างเช่น 'ผลลัพธ์ของ $3^2 \\times 3^4$ คืออะไร' หรือ 'คำตอบคือ $3^{2+4} = 3^6$' กฎเพิ่มเติม: 1. ใช้ `\\times` สำหรับการคูณ และ `\\div` สำหรับการหารเสมอ ห้ามใช้คำอื่น 2. ตรวจสอบให้แน่ใจว่าวงเล็บปีกกา `{}` ทั้งหมดมีการเปิดและปิดที่ถูกต้อง 3. ห้ามใส่เครื่องหมายดอลลาร์ซ้อนกันหรือครอบแต่ละสัญลักษณ์เด็ดขาด ให้ครอบทั้งนิพจน์เท่านั้น 4. สิ่งสำคัญที่สุด: ก่อนจะจบการสร้างคำตอบ ให้ตรวจสอบทุกครั้งว่านิพจน์คณิตศาสตร์ทั้งหมดถูกครอบด้วยเครื่องหมาย $...$ เรียบร้อยแล้ว";

async function handleGenerateFromLink() {
    const urlInput = document.getElementById('link-url-input');
    const topicInput = document.getElementById('link-topic-input');
    const url = urlInput.value.trim();
    const topic = topicInput.value.trim();

    if (!url) {
        showMessage("กรุณาวาง URL ของบทความก่อน");
        return;
    }

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');
    const generateBtn = document.getElementById('generate-from-link-btn');

    // แสดงสถานะกำลังโหลด
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    genQuizContainer.innerHTML = '';
    loader.classList.remove('hidden');
    loaderText.textContent = 'กำลังดึงข้อมูลจากลิงก์...';
    generateBtn.disabled = true;

    try {
        // ใช้ CORS Proxy เพื่อดึงเนื้อหาจากเว็บไซต์
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
        const response = await fetch(proxyUrl);
        if (!response.ok) {
            throw new Error(`ไม่สามารถดึงข้อมูลจาก URL ได้ (Status: ${response.status})`);
        }
        const htmlContent = await response.text();
        
        // สกัดข้อความล้วนๆ ออกจาก HTML
        const textContent = extractTextFromHtml(htmlContent);

        if (!textContent || textContent.length < 100) {
             throw new Error("ไม่พบเนื้อหาที่เพียงพอในลิงก์ที่ให้มา");
        }

        // ส่งต่อข้อมูลที่ได้ไปให้ฟังก์ชันสร้างแบบทดสอบเดิม
        await generateQuiz(topic, textContent);

    } catch (error) {
        console.error("Error generating from link:", error);
        showMessage(`เกิดข้อผิดพลาด: ${error.message}`);
        genQuizContainer.innerHTML = `<p class="text-red-500 text-center">ขออภัย, ไม่สามารถสร้างแบบทดสอบจากลิงก์ได้</p>`;
    } finally {
        loader.classList.add('hidden');
        generateBtn.disabled = false;
    }
}

function extractTextFromHtml(htmlString) {
    const doc = new DOMParser().parseFromString(htmlString, 'text/html');
    
    // ลบแท็กที่ไม่ต้องการออกไปก่อน เช่น script, style, nav, footer
    doc.querySelectorAll('script, style, nav, footer, header, aside').forEach(el => el.remove());
    
    // ดึงข้อความจาก body
    return doc.body.textContent || "";
}

        document.getElementById('generate-from-topic-btn').addEventListener('click', () => {
            const topic = document.getElementById('topic-input').value.trim();
            if (!topic) { showMessage("กรุณาป้อนหัวข้อก่อน"); return; }
            generateQuiz(topic, null);
        });
        
        document.getElementById('generate-from-text-btn').addEventListener('click', () => {
            const textContent = document.getElementById('text-content-input').value.trim();
            if (!textContent) { showMessage("กรุณาวางเนื้อหาก่อน"); return; }
            generateQuiz(null, textContent);
        });

        async function generateQuiz(topic, textContent, singleQuestionIndex = null) {
            const includeImages = document.getElementById('include-images-checkbox').checked;
            const quizType = document.getElementById('quiz-type-select').value;
            const numQuestions = document.getElementById('num-questions').value;
            const numChoices = document.getElementById('num-choices').value;

            let prompt = "";
            let loadingMessage = "";
            let schema;

            // --- Logic ใหม่สำหรับสร้างคำสั่งเกี่ยวกับหัวข้อแบบไดนามิก ---
            let topicInstruction = `เกี่ยวกับหัวข้อ "${topic}"`;
            if (!topic && textContent) {
                topicInstruction = "โดยให้ AI วิเคราะห์หาหัวข้อหลักจากเนื้อหาที่ให้มาโดยอัตโนมัติ";
            } else if (!topic && !textContent) {
                topicInstruction = "เกี่ยวกับหัวข้อ 'ความรู้ทั่วไป'"; // กรณีฉุกเฉิน
            }
            
            // Define base schemas
            const mcqSchema = {
                type: "OBJECT",
                properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } },
                required: ["questionText", "options", "correctAnswerIndex", "explanation"]
            };
            const shortAnswerSchema = {
                type: "OBJECT",
                properties: { questionText: { type: "STRING" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } },
                required: ["questionText", "idealAnswer", "explanation"]
            };
            const mixedQuestionSchema = {
                type: "OBJECT",
                properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } },
                required: ["questionText", "questionType", "explanation"]
            };
            const trueFalseSchema = {
                type: "OBJECT",
                properties: { questionText: { type: "STRING" }, correctAnswer: { type: "BOOLEAN" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } },
                required: ["questionText", "correctAnswer", "explanation"]
            };
            const matchingItemSchema = {
                type: "OBJECT",
                properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, allResponses: { type: "ARRAY", items: { type: "STRING" } }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } },
                required: ["questionType", "stem", "correctResponse", "allResponses", "explanation"]
            };

            let finalSchema;

            if (singleQuestionIndex !== null) {
                // Logic for regenerating a single question (will use the existing topic)
                const originalQuestionType = currentQuizData.questions[singleQuestionIndex].questionType;
                const imageInstruction = includeImages ? `สำหรับคำถามนี้ หากจำเป็นต้องมีรูปภาพประกอบ (เช่น รูปเรขาคณิต) ให้สร้างโค้ด SVG ที่สมบูรณ์สำหรับรูปนั้นๆ แล้วใส่ไว้ใน property ชื่อ "imageCode".` : '';

                if(originalQuestionType === 'multiple_choice') {
                    prompt = `สร้างแบบทดสอบปรนัย 1 ข้อ ${topicInstruction}. ให้มี ${numChoices} ตัวเลือก, ระบุคำตอบที่ถูกต้อง, และเพิ่มคำอธิบายสั้นๆ. ${imageInstruction} ${mathPromptInstruction}`;
                    schema = mcqSchema;
                } else if (originalQuestionType === 'matching_item') {
                    prompt = `จากหัวข้อ ${topicInstruction} สร้างคำถามจับคู่ 1 ข้อ (1 คู่) ที่อยู่ในหมวดหมู่เดียวกันกับคำถามเดิม แต่ต้องแตกต่างออกไป. รูปแบบคือ: stem, correctResponse, และ explanation. ${imageInstruction} ${mathPromptInstruction}`;
                    schema = { type: "OBJECT", properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "stem", "correctResponse", "explanation"] };
                } else { // short_answer
                    prompt = `สร้างคำถามแบบเติมคำในช่องว่าง 1 ข้อ ${topicInstruction}. แต่ละข้อต้องมีคำถาม (questionText), คำตอบที่เหมาะสม (idealAnswer), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
                    schema = shortAnswerSchema;
                }
                finalSchema = schema;
            } else {
                const imageInstruction = includeImages ? `สำหรับแต่ละคำถาม หากจำเป็นต้องมีรูปภาพประกอบ (เช่น รูปเรขาคณิต, กราฟ) ให้สร้างโค้ด SVG ที่สมบูรณ์สำหรับรูปนั้นๆ แล้วใส่ไว้ใน property ชื่อ "imageCode". ถ้าไม่จำเป็น ไม่ต้องใส่ property นี้.` : '';

                switch (quizType) {
                    case 'multiple_choice':
                        prompt = `สร้างแบบทดสอบปรนัย ${numQuestions} ข้อ ${topicInstruction}. แต่ละข้อมี ${numChoices} ตัวเลือก, ระบุคำตอบที่ถูกต้อง, และเพิ่มคำอธิบายสั้นๆ. ${imageInstruction} ${mathPromptInstruction}`;
                        schema = mcqSchema;
                        break;
                    case 'fill_in_with_choices':
                        prompt = `สร้างคำถามแบบเติมคำในช่องว่าง ${numQuestions} ข้อ ${topicInstruction}. แต่ละข้อต้องมีประโยคคำถามที่มีช่องว่าง (questionText containing '.....'), ตัวเลือก ${numChoices} ตัว (options), ดัชนีคำตอบที่ถูกต้อง (correctAnswerIndex), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
                        schema = mcqSchema;
                        break;
                    case 'fill_in_no_choices':
                        prompt = `สร้างคำถามแบบเติมคำในช่องว่าง ${numQuestions} ข้อ ${topicInstruction}. แต่ละข้อต้องมีคำถาม (questionText containing '.....'), คำตอบที่เหมาะสม (idealAnswer), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
                        schema = shortAnswerSchema;
                        break;
                    case 'mixed':
                        prompt = `สร้างแบบทดสอบ ${numQuestions} ข้อ ${topicInstruction}, โดยให้มีทั้งคำถามแบบปรนัย (questionType: 'multiple_choice') และแบบเติมคำที่ให้พิมพ์ตอบเอง (questionType: 'short_answer') คละกันไป. สำหรับปรนัย ให้มี ${numChoices} ตัวเลือก. ${imageInstruction} ${mathPromptInstruction}. For each question, specify its 'questionType'. If 'questionType' is 'multiple_choice', provide 'options' and 'correctAnswerIndex'. If 'questionType' is 'short_answer', provide 'idealAnswer'.`;
                        schema = mixedQuestionSchema;
                        break;
                    case 'true_false':
                        prompt = `สร้างคำถามแบบใช่/ไม่ใช่ ${numQuestions} ข้อ ${topicInstruction}. แต่ละข้อต้องมีคำถาม (questionText), คำตอบที่ถูกต้อง (correctAnswer เป็น true หรือ false), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
                        schema = trueFalseSchema;
                        break;
                    case 'matching':
                        prompt = `สร้างชุดคำถามจับคู่ ${numQuestions} คู่ ${topicInstruction}. สำหรับแต่ละคู่ ให้สร้างเป็น JSON object แยกกัน โดยแต่ละ object ต้องมี: 'questionType' (ตั้งค่าเป็น 'matching_item'), 'stem' (คำถามฝั่งซ้าย), 'correctResponse' (คำตอบที่ถูกต้องฝั่งขวา), และ 'explanation'. นอกจากนี้ ให้สร้าง key ชื่อ 'allResponses' ซึ่งเป็น array ที่รวบรวม 'correctResponse' ทั้งหมด ${numQuestions} รายการ เพื่อใช้เป็นตัวเลือกใน dropdown. ${imageInstruction} ${mathPromptInstruction}`;
                        schema = matchingItemSchema;
                        break;
                }
                finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: schema } }, required: ["topic", "questions"] };
            }

            if (textContent) {
                prompt = `จากเนื้อหาต่อไปนี้: "${textContent}", ${prompt}`;
                loadingMessage = 'กำลังวิเคราะห์เนื้อหาและสร้างแบบทดสอบ...';
            } else {
                loadingMessage = 'กำลังสร้างแบบทดสอบจากหัวข้อ...';
            }
            
            return handleApiCall(prompt, loadingMessage, finalSchema, singleQuestionIndex);
        }

        async function generateQuizFromFile(mimeType, base64Data) {
    const quizType = document.getElementById('quiz-type-select').value;
    const numQuestions = document.getElementById('num-questions').value;
    const numChoices = document.getElementById('num-choices').value;
    const includeImages = document.getElementById('include-images-checkbox').checked;

    let prompt = "";
    let schema;

    // สร้าง Prompt และ Schema เหมือนกับฟังก์ชัน generateQuiz() เดิม
    const imageInstruction = includeImages ? `สำหรับแต่ละคำถาม หากจำเป็นต้องมีรูปภาพประกอบ (เช่น รูปเรขาคณิต, กราฟ) ให้สร้างโค้ด SVG ที่สมบูรณ์สำหรับรูปนั้นๆ แล้วใส่ไว้ใน property ชื่อ "imageCode". ถ้าไม่จำเป็น ไม่ต้องใส่ property นี้.` : '';

    // (โค้ดส่วน switch case เพื่อสร้าง prompt และ schema จะเหมือนกับใน generateQuiz() ทุกประการ)
    // ... (This part is identical to the switch-case block in your existing generateQuiz function) ...
    switch (quizType) {
        case 'multiple_choice':
            prompt = `สร้างแบบทดสอบปรนัย ${numQuestions} ข้อ. แต่ละข้อมี ${numChoices} ตัวเลือก, ระบุคำตอบที่ถูกต้อง, และเพิ่มคำอธิบายสั้นๆ. ${imageInstruction} ${mathPromptInstruction}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
            break;
        case 'fill_in_with_choices':
            prompt = `สร้างคำถามแบบเติมคำในช่องว่าง ${numQuestions} ข้อ. แต่ละข้อต้องมีประโยคคำถามที่มีช่องว่าง (questionText containing '.....'), ตัวเลือก ${numChoices} ตัว (options), ดัชนีคำตอบที่ถูกต้อง (correctAnswerIndex), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "options", "correctAnswerIndex", "explanation"] };
            break;
        case 'fill_in_no_choices':
            prompt = `สร้างคำถามแบบเติมคำในช่องว่าง ${numQuestions} ข้อ. แต่ละข้อต้องมีคำถาม (questionText containing '.....'), คำตอบที่เหมาะสม (idealAnswer), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "idealAnswer", "explanation"] };
            break;
        case 'mixed':
            prompt = `สร้างแบบทดสอบ ${numQuestions} ข้อ, โดยให้มีทั้งคำถามแบบปรนัย (questionType: 'multiple_choice') และแบบเติมคำที่ให้พิมพ์ตอบเอง (questionType: 'short_answer') คละกันไป. สำหรับปรนัย ให้มี ${numChoices} ตัวเลือก. ${imageInstruction} ${mathPromptInstruction}. For each question, specify its 'questionType'. If 'questionType' is 'multiple_choice', provide 'options' and 'correctAnswerIndex'. If 'questionType' is 'short_answer', provide 'idealAnswer'.`;
            schema = { type: "OBJECT", properties: { questionText: { "type": "STRING" }, questionType: { "type": "STRING", "enum": ["multiple_choice", "short_answer"] }, options: { type: "ARRAY", items: { type: "STRING" } }, correctAnswerIndex: { type: "NUMBER" }, idealAnswer: { type: "STRING" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "questionType", "explanation"] };
            break;
        case 'true_false':
            prompt = `สร้างคำถามแบบใช่/ไม่ใช่ ${numQuestions} ข้อ. แต่ละข้อต้องมีคำถาม (questionText), คำตอบที่ถูกต้อง (correctAnswer เป็น true หรือ false), และคำอธิบาย (explanation). ${imageInstruction} ${mathPromptInstruction}`;
            schema = { type: "OBJECT", properties: { questionText: { type: "STRING" }, correctAnswer: { type: "BOOLEAN" }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionText", "correctAnswer", "explanation"] };
            break;
        case 'matching':
            prompt = `สร้างชุดคำถามจับคู่ ${numQuestions} คู่. สำหรับแต่ละคู่ ให้สร้างเป็น JSON object แยกกัน โดยแต่ละ object ต้องมี: 'questionType' (ตั้งค่าเป็น 'matching_item'), 'stem' (คำถามฝั่งซ้าย), 'correctResponse' (คำตอบที่ถูกต้องฝั่งขวา), และ 'explanation'. นอกจากนี้ ให้สร้าง key ชื่อ 'allResponses' ซึ่งเป็น array ที่รวบรวม 'correctResponse' ทั้งหมด ${numQuestions} รายการ เพื่อใช้เป็นตัวเลือกใน dropdown. ${imageInstruction} ${mathPromptInstruction}`;
            schema = { type: "OBJECT", properties: { questionType: { type: "STRING", "enum": ["matching_item"] }, stem: { type: "STRING" }, correctResponse: { type: "STRING" }, allResponses: { type: "ARRAY", items: { type: "STRING" } }, explanation: { type: "STRING" }, imageCode: { type: "STRING" } }, required: ["questionType", "stem", "correctResponse", "allResponses", "explanation"] };
            break;
    }
    const finalSchema = { type: "OBJECT", properties: { topic: { type: "STRING" }, questions: { type: "ARRAY", items: schema } }, required: ["topic", "questions"] };

    // สร้าง Prompt สุดท้ายโดยบอกให้ AI วิเคราะห์จากไฟล์
    const finalPrompt = `จากไฟล์ที่แนบมานี้, ${prompt}`;

    // สร้าง Payload สำหรับ API ในรูปแบบ Multimodal
    const payload = {
        contents: [{
            parts: [
                { text: finalPrompt },
                {
                    inlineData: {
                        mimeType: mimeType,
                        data: base64Data
                    }
                }
            ]
        }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: finalSchema
        }
    };

    // เรียกใช้ handleApiCall กับ Payload ใหม่
    // เราต้องส่ง `payload.contents[0].parts` แทนที่จะเป็นแค่ string
    return handleApiCall(payload.contents[0].parts, 'AI กำลังวิเคราะห์ไฟล์และสร้างแบบทดสอบ...', finalSchema);
}

        async function handleApiCall(promptOrParts, loadingMessage, schema, singleQuestionIndex = null) {
    const quizGenArea = document.getElementById('quiz-generation-area');
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const genQuizContainer = document.getElementById('generated-quiz-container');

    quizGenArea.classList.remove('hidden');
    if (singleQuestionIndex === null) {
        genQuizContainer.innerHTML = '';
    }
    loader.classList.remove('hidden');
    loaderText.textContent = loadingMessage;

    // ปิดการใช้งานปุ่มสร้างทั้งหมด
    document.getElementById('generate-from-topic-btn').disabled = true;
    document.getElementById('generate-from-text-btn').disabled = true;
    document.getElementById('generate-from-link-btn').disabled = true;


    try {
        const generationConfig = {
            responseMimeType: "application/json",
            responseSchema: schema
        };
        
        // ตรวจสอบว่า prompt ที่รับมาเป็น string หรือ array of parts
        const parts = Array.isArray(promptOrParts) ? promptOrParts : [{ text: promptOrParts }];
        const payload = { contents: [{ role: "user", parts: parts }], generationConfig };

        const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // API key will be provided by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
        const result = await response.json();
        
        if (result.candidates?.[0]?.content?.parts?.[0]) {
            let jsonText = result.candidates[0].content.parts[0].text;
            let parsedData;
            try {
                // --- START: โค้ดส่วนที่เพิ่มเข้ามาเพื่อทำความสะอาด JSON ---
                // ตรวจสอบและลบ Markdown code fences (```json ... ```) ที่อาจติดมา
                if (jsonText.startsWith("```json")) {
                    jsonText = jsonText.substring(7, jsonText.length - 3).trim();
                } else if (jsonText.startsWith("```")) {
                     jsonText = jsonText.substring(3, jsonText.length - 3).trim();
                }
                // --- END: สิ้นสุดโค้ดส่วนที่เพิ่มเข้ามา ---

                parsedData = JSON.parse(jsonText);

            } catch(e) {
                console.error("Failed to parse JSON from AI", e, jsonText);
                throw new Error("Invalid response structure from AI.");
            }
            
            if (singleQuestionIndex !== null) {
                // Handle regenerating a single question
                if (parsedData.questionType === 'matching_item') {
                    // When regenerating a matching item, the AI only returns one item.
                    // We need to merge it back into the existing quiz structure.
                    const allResponses = currentQuizData.questions.map(q => q.correctResponse);
                    parsedData.allResponses = allResponses; // Keep the original full list of responses
                    // Replace the specific correctResponse in the list with the new one
                    const oldCorrectResponse = currentQuizData.questions[singleQuestionIndex].correctResponse;
                    const responseIndex = allResponses.indexOf(oldCorrectResponse);
                    if (responseIndex > -1) {
                        allResponses[responseIndex] = parsedData.correctResponse;
                    }
                    // Update all other matching questions with the new response list
                    currentQuizData.questions.forEach(q => {
                        if(q.questionType === 'matching_item') q.allResponses = allResponses;
                    });
                }
                currentQuizData.questions[singleQuestionIndex] = parsedData;
                displayGeneratedQuiz(currentQuizData);
            } else {
                // Handle generating a new quiz
                currentQuizData = sanitizeQuizData(parsedData);
                const quizTypeFromUI = document.getElementById('quiz-type-select').value;

                // Standardize the quizType and questionType properties
                currentQuizData.quizType = quizTypeFromUI; 

                // Assign questionType to each question based on the overall type, if not already present
                if(currentQuizData.questions) {
                    currentQuizData.questions.forEach(q => {
                        if (!q.questionType) {
                            if (quizTypeFromUI === 'fill_in_with_choices') {
                                q.questionType = 'multiple_choice';
                            } else if (quizTypeFromUI === 'fill_in_no_choices') {
                                q.questionType = 'short_answer';
                            } else {
                                q.questionType = quizTypeFromUI;
                            }
                        }
                    });
                }
                displayGeneratedQuiz(currentQuizData);
            }
        } else {
            console.error("Invalid response structure from AI:", JSON.stringify(result));
            throw new Error("Invalid response structure from AI.");
        }

    } catch (error) {
        console.error("Error generating quiz:", error);
        showMessage("เกิดข้อผิดพลาดในการสร้างแบบทดสอบ โปรดลองอีกครั้ง");
        if (singleQuestionIndex === null) {
            genQuizContainer.innerHTML = `<p class="text-red-500 text-center">ขออภัย, ไม่สามารถสร้างแบบทดสอบได้</p>`;
        }
    } finally {
        loader.classList.add('hidden');
        // เปิดการใช้งานปุ่มสร้างทั้งหมดอีกครั้ง
        document.getElementById('generate-from-topic-btn').disabled = false;
        document.getElementById('generate-from-text-btn').disabled = false;
        document.getElementById('generate-from-link-btn').disabled = false;
    }
}

        function displayGeneratedQuiz(quizData) {
            const container = document.getElementById('generated-quiz-container');
            let html = `<h3 class="text-xl font-bold mb-3" contenteditable="true" id="editable-quiz-topic">${quizData.topic}</h3>`;
            quizData.questions.forEach((q, index) => {
                const questionType = q.questionType || quizData.quizType;
                
                html += `
                    <div class="mb-4 p-4 border rounded-lg relative group">
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                             <button data-index="${index}" class="save-to-bank-btn text-purple-600 hover:text-purple-800 p-1" title="เก็บเข้าคลังข้อสอบส่วนตัว">
    <i class="fas fa-university"></i>
</button>
                             <button data-index="${index}" class="edit-question-btn text-blue-600 hover:text-blue-800 p-1" title="แก้ไขข้อนี้"><i class="fas fa-pen"></i></button>
                             <button data-index="${index}" class="regenerate-question-btn text-green-600 hover:text-green-800 p-1" title="สร้างข้อนี้ใหม่"><i class="fas fa-sync-alt"></i></button>
                        </div>
                `;

                // Render based on question type
                switch(questionType) {
                    case 'matching_item':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.stem}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 p-2 bg-green-100 text-sm"><strong class="text-gray-700">คำตอบที่ถูกต้อง:</strong> <span id="q-correct-${index}">${q.correctResponse}</span></div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">คำอธิบาย:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'short_answer':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 p-2 bg-gray-100 text-sm"><strong class="text-gray-700">คำตอบที่คาดหวัง:</strong> <span id="q-ideal-${index}">${q.idealAnswer}</span></div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">คำอธิบาย:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'true_false':
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<div class="mt-2 space-y-1 text-sm">
                                     <p class="${q.correctAnswer === true ? 'text-green-600 font-bold' : ''}">ใช่</p>
                                     <p class="${q.correctAnswer === false ? 'text-green-600 font-bold' : ''}">ไม่ใช่</p>
                                 </div>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">คำอธิบาย:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                    case 'fill_in_the_blank':
                    case 'multiple_choice':
                    default:
                        html += `<p class="font-semibold" id="q-text-${index}">${index + 1}. ${q.questionText}</p>`;
                        if (q.imageCode) {
                            html += `<div id="q-image-container-${index}" class="my-4 flex justify-center">${q.imageCode}</div>`;
                        }
                        html += `<ul class="list-disc list-inside mt-2 space-y-1 text-sm" id="q-options-${index}">
                                     ${q.options.map((opt, i) => `<li class="${i === q.correctAnswerIndex ? 'text-green-600 font-bold' : ''}">${opt}</li>`).join('')}
                                 </ul>`;
                        html += `<div class="mt-2 p-2 bg-blue-50 text-xs"><strong class="text-blue-700">คำอธิบาย:</strong> <span id="q-explanation-${index}">${q.explanation}</span></div>`;
                        break;
                }

                html += `</div>`;
            });
            html += `<div id="generated-quiz-actions" class="mt-4">
                          <button id="save-quiz-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700"><i class="fas fa-save mr-2"></i>บันทึกและสร้างรหัส</button>
                         </div>`;
            container.innerHTML = html;
            
            // Add event listeners for new buttons
            document.querySelectorAll('.edit-question-btn').forEach(btn => btn.addEventListener('click', handleEditQuestion));
            document.querySelectorAll('.regenerate-question-btn').forEach(btn => btn.addEventListener('click', handleRegenerateQuestion));
            document.querySelectorAll('.save-to-bank-btn').forEach(btn => btn.addEventListener('click', handleSaveToBank));
            document.getElementById('save-quiz-btn').addEventListener('click', saveQuiz);

            if (window.MathJax) window.MathJax.typesetPromise([container]);
        }
        
        function handleRegenerateQuestion(e) {
            const index = e.currentTarget.dataset.index;
            const topic = currentQuizData.topic;
            showMessage(`กำลังสร้างคำถามข้อ ${parseInt(index) + 1} ใหม่...`);
            generateQuiz(topic, null, parseInt(index));
        }

        // --- SVG Drag and Drop Functions (Mouse & Touch) ---
        function getPointerPosition(svg, evt) {
            const CTM = svg.getScreenCTM();
            let clientX, clientY;

            // Check for touch event
            if (evt.touches && evt.touches.length > 0) {
                clientX = evt.touches[0].clientX;
                clientY = evt.touches[0].clientY;
            } else {
                // Fallback to mouse event
                clientX = evt.clientX;
                clientY = evt.clientY;
            }

            return {
                x: (clientX - CTM.e) / CTM.a,
                y: (clientY - CTM.f) / CTM.d
            };
        }

        function startDrag(evt) {
            // Prevent default touch actions like scrolling
            if (evt.type === 'touchstart') {
                evt.preventDefault();
            }
            const target = evt.target.closest('.draggable-text');
            if (target) {
                draggedSvgElement = target;
                const svg = draggedSvgElement.ownerSVGElement;
                const pointerPos = getPointerPosition(svg, evt);

                svgOffset.x = pointerPos.x - parseFloat(draggedSvgElement.getAttributeNS(null, "x"));
                svgOffset.y = pointerPos.y - parseFloat(draggedSvgElement.getAttributeNS(null, "y"));
            }
        }

        function drag(evt) {
            if (draggedSvgElement) {
                evt.preventDefault();
                const svg = draggedSvgElement.ownerSVGElement;
                const pointerPos = getPointerPosition(svg, evt);
                const viewBox = svg.viewBox.baseVal;

                // Calculate proposed new coordinates
                let newX = pointerPos.x - svgOffset.x;
                let newY = pointerPos.y - svgOffset.y;

                // Get the bounding box of the text element itself to prevent it from going partially off-screen
                const textBBox = draggedSvgElement.getBBox();

                // Clamp coordinates within the SVG viewbox
                newX = Math.max(viewBox.x, Math.min(newX, viewBox.x + viewBox.width - textBBox.width));
                newY = Math.max(viewBox.y, Math.min(newY, viewBox.y + viewBox.height - textBBox.height));

                draggedSvgElement.setAttributeNS(null, "x", newX);
                draggedSvgElement.setAttributeNS(null, "y", newY);
            }
        }

        function endDrag(evt) {
            draggedSvgElement = null;
        }

        // --- SVG Edit Click Handler ---
        function handleSvgEditClick(e) {
            if (e.target.classList.contains('delete-svg-btn')) {
                const targetId = e.target.dataset.targetId;
                const svg = e.currentTarget;
                const textElementToDelete = svg.querySelector(`#${targetId}`);
                if (textElementToDelete) {
                    textElementToDelete.remove();
                }
                e.target.remove(); // Remove the delete button itself
            }
        }
        
        function handleEditQuestion(e) {
            const btn = e.currentTarget;
            const index = btn.dataset.index;
            const q = currentQuizData.questions[index];
            const qTextEl = document.getElementById(`q-text-${index}`);
            const qExplanationEl = document.getElementById(`q-explanation-${index}`);
            const imageContainer = document.getElementById(`q-image-container-${index}`);

            if (btn.innerHTML.includes('fa-pen')) { // --- Start edit mode ---
                btn.innerHTML = '<i class="fas fa-save"></i>';
                btn.title = "บันทึกการแก้ไข";

                if(qTextEl) qTextEl.contentEditable = true;
                if(qExplanationEl) qExplanationEl.contentEditable = true;

                if (imageContainer) {
                    const svgElement = imageContainer.querySelector('svg');
                    if (svgElement) {
                        const textElements = svgElement.querySelectorAll('text');
                        textElements.forEach((textEl, i) => {
                            const textId = `editable-text-${index}-${i}`;
                            textEl.id = textId;
                            textEl.classList.add('draggable-text');
                            textEl.style.cursor = 'move';

                            // Create and append delete button
                            const deleteBtn = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            const textBBox = textEl.getBBox();
                            deleteBtn.setAttribute('cx', String(textBBox.x + textBBox.width + 5));
                            deleteBtn.setAttribute('cy', String(textBBox.y + textBBox.height / 2 - 5));
                            deleteBtn.setAttribute('r', '5');
                            deleteBtn.setAttribute('fill', 'red');
                            deleteBtn.setAttribute('class', 'delete-svg-btn');
                            deleteBtn.dataset.targetId = textId;
                            textEl.after(deleteBtn);
                        });
                        
                        // Add event listeners for drag and delete
                        svgElement.addEventListener('mousedown', startDrag);
                        svgElement.addEventListener('mousemove', drag);
                        svgElement.addEventListener('mouseup', endDrag);
                        svgElement.addEventListener('mouseleave', endDrag);
                        svgElement.addEventListener('touchstart', startDrag, { passive: false });
                        svgElement.addEventListener('touchmove', drag, { passive: false });
                        svgElement.addEventListener('touchend', endDrag);
                        svgElement.addEventListener('touchcancel', endDrag);
                        svgElement.addEventListener('click', handleSvgEditClick);
                    }
                }
                if(qTextEl) qTextEl.focus();

            } else { // --- Save edits ---
                btn.innerHTML = '<i class="fas fa-pen"></i>';
                btn.title = "แก้ไขข้อนี้";

                if(qTextEl) {
                    qTextEl.contentEditable = false;
                    const questionType = q.questionType || currentQuizData.quizType;
                    if (questionType === 'matching_item') {
                         q.stem = qTextEl.innerText.substring(qTextEl.innerText.indexOf('.') + 2).trim();
                    } else {
                         q.questionText = qTextEl.innerText.substring(qTextEl.innerText.indexOf('.') + 2).trim();
                    }
                }
                if(qExplanationEl) {
                    qExplanationEl.contentEditable = false;
                    q.explanation = qExplanationEl.innerText;
                }

                if (imageContainer) {
                    const svgElement = imageContainer.querySelector('svg');
                    if (svgElement) {
                        // Clone the SVG to manipulate it without affecting the display
                        const svgClone = svgElement.cloneNode(true);
                        
                        // Remove delete buttons and other edit-mode artifacts from the clone
                        svgClone.querySelectorAll('.delete-svg-btn').forEach(btn => btn.remove());
                        svgClone.querySelectorAll('.draggable-text').forEach(el => {
                            el.classList.remove('draggable-text');
                            el.style.cursor = 'default';
                            el.removeAttribute('id');
                        });

                        // Save the cleaned HTML
                        q.imageCode = svgClone.outerHTML;

                        // Now, remove listeners and artifacts from the displayed SVG
                        svgElement.removeEventListener('mousedown', startDrag);
                        svgElement.removeEventListener('mousemove', drag);
                        svgElement.removeEventListener('mouseup', endDrag);
                        svgElement.removeEventListener('mouseleave', endDrag);
                        svgElement.removeEventListener('touchstart', startDrag);
                        svgElement.removeEventListener('touchmove', drag);
                        svgElement.removeEventListener('touchend', endDrag);
                        svgElement.removeEventListener('touchcancel', endDrag);
                        svgElement.removeEventListener('click', handleSvgEditClick);
                        
                        svgElement.querySelectorAll('.delete-svg-btn').forEach(btn => btn.remove());
                        svgElement.querySelectorAll('.draggable-text').forEach(el => {
                            el.classList.remove('draggable-text');
                            el.style.cursor = 'default';
                        });
                    }
                }
            }
        }

let currentEditingQuizData = null; // เพิ่มตัวแปร global นี้ไว้ด้านบนของ script

        // ฟังก์ชันที่ 1: เปิด Editor และดึงข้อมูล
        async function handleOpenQuizEditor(quizId) {
            const editorModal = document.getElementById('quiz-editor-modal');
            const questionsContainer = document.getElementById('quiz-editor-questions-container');
            
            questionsContainer.innerHTML = '<div class="loader mx-auto"></div>';
            editorModal.classList.remove('hidden');

            try {
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizSnap = await getDoc(quizRef);

                if (!quizSnap.exists()) {
                    throw new Error("ไม่พบแบบทดสอบ");
                }
                
                currentEditingQuizData = { id: quizId, ...quizSnap.data() };
                renderQuizEditor(currentEditingQuizData);

            } catch (error) {
                console.error("Error opening quiz editor:", error);
                showMessage("เกิดข้อผิดพลาดในการโหลดข้อมูลแบบทดสอบ");
                editorModal.classList.add('hidden');
            }
        }

        // ฟังก์ชันที่ 2: สร้างหน้าจอ Editor จากข้อมูลที่ดึงมา
        function renderQuizEditor(quizData) {
            document.getElementById('editor-quiz-topic').value = quizData.topic;
            const questionsContainer = document.getElementById('quiz-editor-questions-container');
            
            let html = quizData.questions.map((q, index) => {
                let questionContent = '';
                const questionType = q.questionType || quizData.quizType;
                
                switch(questionType) {
                    case 'multiple_choice':
                        const optionsHTML = (q.options || []).map((opt, optIndex) => `
                            <div class="flex items-center gap-2">
                                <input type="radio" name="correct-answer-${index}" value="${optIndex}" ${optIndex === q.correctAnswerIndex ? 'checked' : ''} class="accent-green-600">
                                <input type="text" value="${opt}" class="w-full p-1 border rounded-md">
                            </div>
                        `).join('');
                        questionContent = `
                            <label class="block text-sm font-medium text-gray-600">ตัวเลือกและเฉลย:</label>
                            <div class="space-y-2 mt-1">${optionsHTML}</div>
                        `;
                        break;
                    case 'short_answer':
                         questionContent = `
                            <label class="block text-sm font-medium text-gray-600">เฉลยที่ถูกต้อง:</label>
                            <input type="text" value="${q.idealAnswer || ''}" class="w-full p-1 border rounded-md ideal-answer-input">
                         `;
                        break;
                    case 'true_false':
                        questionContent = `
                            <label class="block text-sm font-medium text-gray-600">เฉลย:</label>
                            <div class="space-y-1 mt-1">
                                <div class="flex items-center gap-2"><input type="radio" name="correct-answer-${index}" value="true" ${q.correctAnswer === true ? 'checked' : ''} class="accent-green-600"> <span>ใช่ / ถูก</span></div>
                                <div class="flex items-center gap-2"><input type="radio" name="correct-answer-${index}" value="false" ${q.correctAnswer === false ? 'checked' : ''} class="accent-green-600"> <span>ไม่ใช่ / ผิด</span></div>
                            </div>
                        `;
                        break;
                    case 'matching_item':
                        questionContent = `
                             <label class="block text-sm font-medium text-gray-600">เฉลยที่ถูกต้อง (คู่ของคำถามนี้):</label>
                             <input type="text" value="${q.correctResponse || ''}" class="w-full p-1 border rounded-md correct-response-input">
                        `;
                        // สำหรับ Matching เราจะอนุญาตให้แก้แค่คำถาม (stem) และคำตอบที่คู่กันเท่านั้น
                        // ไม่ให้แก้ไขตัวเลือกทั้งหมดใน dropdown เพื่อป้องกันความซับซ้อน
                        break;
                }

                const questionText = q.questionText || q.stem || '';
                return `
                    <div class="p-4 border rounded-lg bg-gray-50 question-editor-item" data-q-type="${questionType}">
                        <label class="block text-sm font-medium text-gray-700 mb-1">คำถามข้อที่ ${index + 1} (${questionType}):</label>
                        <textarea class="w-full p-2 border border-gray-300 rounded-lg" rows="2">${questionText}</textarea>
                        <div class="mt-3">${questionContent}</div>
                    </div>
                `;
            }).join('');

            questionsContainer.innerHTML = html;
        }

        // ฟังก์ชันที่ 3: บันทึกการแก้ไข
        async function handleSaveChanges() {
            const saveBtn = document.getElementById('save-quiz-edits-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';

            try {
                const newTopic = document.getElementById('editor-quiz-topic').value;
                const questionElements = document.querySelectorAll('.question-editor-item');
                let allCorrectResponsesForMatching = [];

                // 1. รวบรวมข้อมูลใหม่จากฟอร์ม
                const newQuestions = Array.from(questionElements).map((el, index) => {
                    const questionType = el.dataset.qType;
                    const questionTextFromTextArea = el.querySelector('textarea').value;
                    let newQuestionData = { questionType: questionType };
                    const originalQuestion = currentEditingQuizData.questions[index];
                    
                    // ใช้ switch case เพื่อความชัดเจนและป้องกันข้อผิดพลาด
                    switch (questionType) {
                        case 'multiple_choice':
                            newQuestionData.questionText = questionTextFromTextArea;
                            const optionInputs = el.querySelectorAll('input[type="text"]');
                            newQuestionData.options = Array.from(optionInputs).map(input => input.value);
                            const checkedRadioMCQ = el.querySelector('input[type="radio"]:checked');
                            newQuestionData.correctAnswerIndex = checkedRadioMCQ ? parseInt(checkedRadioMCQ.value) : 0;
                            break;
                        case 'short_answer':
                            newQuestionData.questionText = questionTextFromTextArea;
                            newQuestionData.idealAnswer = el.querySelector('.ideal-answer-input').value;
                            break;
                        case 'true_false':
                            newQuestionData.questionText = questionTextFromTextArea;
                            const checkedRadioTF = el.querySelector('input[type="radio"]:checked');
                            newQuestionData.correctAnswer = checkedRadioTF ? checkedRadioTF.value === 'true' : true;
                            break;
                        case 'matching_item':
                            newQuestionData.stem = questionTextFromTextArea;
                            const correctResponseInput = el.querySelector('.correct-response-input');
                            newQuestionData.correctResponse = correctResponseInput ? correctResponseInput.value : '';
                            allCorrectResponsesForMatching.push(newQuestionData.correctResponse);
                            break;
                        default:
                            // กรณีเจอประเภทคำถามที่ไม่รู้จัก ให้บันทึกแค่ข้อความไปก่อน
                            newQuestionData.questionText = questionTextFromTextArea;
                            break;
                    }
                    
                    // นำข้อมูลเดิมที่ไม่มีในฟอร์มมารวมกับข้อมูลใหม่
                    return { ...originalQuestion, ...newQuestionData };
                });

                // 2. อัปเดต 'allResponses' สำหรับทุกข้อที่เป็น matching_item
                if (allCorrectResponsesForMatching.length > 0) {
                    newQuestions.forEach(q => {
                        if (q.questionType === 'matching_item') {
                            q.allResponses = allCorrectResponsesForMatching;
                        }
                    });
                }

                // 3. อัปเดตเอกสารใน Firestore
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, currentEditingQuizData.id);
                await updateDoc(quizRef, {
                    topic: newTopic,
                    questions: newQuestions
                });
                
                showMessage("บันทึกการแก้ไขสำเร็จ");
                document.getElementById('quiz-editor-modal').classList.add('hidden');
                
            } catch (error) {
                console.error("Error saving quiz edits:", error);
                showMessage("เกิดข้อผิดพลาดในการบันทึก");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกการแก้ไข'; // <-- แก้ไขเป็น class=
            }
        }

        async function saveQuiz() {
            if (!currentQuizData || !currentQuizData.questions || !userId || !currentProjectId) {
                showMessage("ข้อมูลไม่ครบถ้วน ไม่สามารถบันทึกได้");
                return;
            }
            const saveButton = document.getElementById('save-quiz-btn');
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';

            currentQuizData.topic = document.getElementById('editable-quiz-topic').innerText;

            try {
                const newQuizSettings = {
                    resultsDisplay: document.getElementById('results-display-select').value,
                    shuffle: document.getElementById('shuffle-setting-select').value,
                    timerMode: document.getElementById('timer-mode-select').value,
                    timerDuration: parseInt(document.getElementById('timer-duration-input').value) || 10,
                    passingScore: parseInt(document.getElementById('passing-score-input').value) || 0,
                passingScore: parseInt(document.getElementById('passing-score-input').value) || 0,
    isAdaptive: document.getElementById('adaptive-quiz-checkbox').checked // <-- เพิ่มบรรทัดนี้
};

                // FIX: Add fallbacks for potentially undefined properties to prevent Firestore errors.
                const cleanQuestions = (currentQuizData.questions || []).map(q => {
                    const quizTypeFromUI = document.getElementById('quiz-type-select').value;
                    // Start with a clean object and provide fallbacks for all required fields
                    const cleanQ = {
                        questionText: q.questionText || "",
                        explanation: q.explanation || "ไม่มีคำอธิบาย",
                        questionType: q.questionType || quizTypeFromUI,
                        imageCode: q.imageCode || null,
                    };
                    
                    // Conditionally add properties based on the question type
                    if (cleanQ.questionType === 'multiple_choice' || cleanQ.questionType === 'fill_in_with_choices' || (cleanQ.questionType === 'mixed' && q.options)) {
                        cleanQ.options = q.options || [];
                        cleanQ.correctAnswerIndex = q.correctAnswerIndex !== undefined ? q.correctAnswerIndex : 0;
                    }
                    if (cleanQ.questionType === 'short_answer' || cleanQ.questionType === 'fill_in_no_choices' || (cleanQ.questionType === 'mixed' && q.idealAnswer)) {
                        cleanQ.idealAnswer = q.idealAnswer || "";
                    }
                    if (cleanQ.questionType === 'true_false') {
                         // Ensure boolean value is not undefined
                        cleanQ.correctAnswer = q.correctAnswer === true;
                    }
                    if (cleanQ.questionType === 'matching_item') {
                        cleanQ.stem = q.stem || "";
                        cleanQ.correctResponse = q.correctResponse || "";
                        cleanQ.allResponses = q.allResponses || [];
                    }
                    return cleanQ;
                });

                const dataToSave = {
                    topic: currentQuizData.topic || "แบบทดสอบไม่มีชื่อ",
                    quizType: currentQuizData.quizType || "multiple_choice",
                    questions: cleanQuestions,
                    projectId: currentProjectId,
                    createdBy: userId,
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    settings: newQuizSettings
                };

                let quizId;
                // Generate a unique 4-digit numeric ID (1000-9999)
                while (true) {
                    quizId = Math.floor(1000 + Math.random() * 9000).toString();
                    const existing = await getDoc(doc(db, `artifacts/${appId}/public/data/quizzes`, quizId));
                    if (!existing.exists()) break;
                }
                await setDoc(doc(db, `artifacts/${appId}/public/data/quizzes`, quizId), dataToSave);


                // After saving, update currentQuizData with the newly saved settings so "Try Quiz" works immediately
                currentQuizData.settings = newQuizSettings;
                currentQuizData.id = quizId;

                const actionsContainer = document.getElementById('generated-quiz-actions');
                actionsContainer.innerHTML = `
                    <div class="p-4 bg-green-100 text-green-800 rounded-lg text-center">
                        <p class="font-semibold">สร้างแบบทดสอบสำเร็จ!</p>
                        <p>รหัสสำหรับทำแบบทดสอบ: <strong id="quiz-id" class="text-lg select-all">${quizId}</strong></p>
                        <button id="copy-quiz-id-btn" class="mt-2 bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 text-sm"><i class="fas fa-copy"></i> คัดลอก</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mt-4">
    <button id="start-live-race-generated-btn" class="w-full bg-orange-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-orange-600 flex items-center justify-center">
        <i class="fas fa-flag-checkered mr-2"></i>แข่งขันสด
    </button>
                        <button id="start-presentation-btn" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher mr-2"></i>เริ่มโหมดนำเสนอ
                        </button>
                        <button id="admin-try-quiz-btn" class="w-full bg-teal-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-teal-700 flex items-center justify-center">
                            <i class="fas fa-vial mr-2"></i>ทดลองทำข้อสอบ
                        </button>
                    </div>
                `;

                document.getElementById('copy-quiz-id-btn').addEventListener('click', () => copyTextToClipboard(quizId, "คัดลอกรหัสแล้ว!"));
                document.getElementById('start-live-race-generated-btn').addEventListener('click', () => handleStartLiveRace(quizId));
                document.getElementById('start-presentation-btn').addEventListener('click', () => startPresentation(currentQuizData));
                document.getElementById('admin-try-quiz-btn').addEventListener('click', startAdminTest);

                showMessage("บันทึกแบบทดสอบสำเร็จแล้ว!");

            } catch (error) {
                console.error("Error saving quiz:", error);
                showMessage("เกิดข้อผิดพลาดในการบันทึกแบบทดสอบ");
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกและสร้างรหัส';
            }
        }
        
        function copyTextToClipboard(text, successMessage) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                showMessage(successful ? successMessage : "คัดลอกไม่สำเร็จ");
            } catch (err) {
                showMessage("คัดลอกไม่สำเร็จ");
                console.error('Copy command failed', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Admin Results View ---
        function listenForProjectQuizzes(projectId) {
            const quizzesRef = collection(db, `artifacts/${appId}/public/data/quizzes`);
            const q = query(quizzesRef, where("projectId", "==", projectId));
            
            unsubscribeQuizzesListener = onSnapshot(q, async (snapshot) => {
                allQuizzes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderQuizzes();
            }, (error) => {
                console.error("Error fetching project quizzes:", error);
                document.getElementById('project-quizzes-list').innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดแบบทดสอบ</p>';
            });
        }
        
       async function renderQuizzes() {
            const quizzesListContainer = document.getElementById('project-quizzes-list');
            const searchTerm = document.getElementById('quiz-search-input').value.toLowerCase();

            // --- [ เพิ่มส่วนนี้ ] ---
            // ตรวจสอบก่อนว่ากำลังดูโปรเจคไหน เพื่อเลือกชุดข้อมูลที่ถูกต้อง
            let quizzesToRender;
            if (currentProjectId === 'starred') {
                quizzesToRender = starredQuizzes; // ถ้าเป็นโปรเจคติดดาว ให้ใช้ข้อมูลจาก starredQuizzes
            } else {
                quizzesToRender = allQuizzes; // ถ้าเป็นโปรเจคปกติ ให้ใช้ข้อมูลจาก allQuizzes
            }
            // --- [ สิ้นสุดส่วนที่เพิ่ม ] ---
            
            // --- [ แก้ไขส่วนนี้ ] ---
            // เปลี่ยนจาก allQuizzes เป็น quizzesToRender
            let filteredQuizzes = quizzesToRender.filter(q => q.topic.toLowerCase().includes(searchTerm));
            filteredQuizzes.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (filteredQuizzes.length === 0) {
                quizzesListContainer.innerHTML = '<p class="text-gray-500">ไม่พบแบบทดสอบที่ตรงกัน</p>';
                return;
            }
            
            // ส่วนที่เหลือของฟังก์ชันนี้เหมือนเดิม ไม่ต้องแก้ไข
            const submissionCounts = {};
            const submissionPromises = filteredQuizzes.map(async (quiz) => {
                const submissionsCol = collection(db, `artifacts/${appId}/public/data/quizzes/${quiz.id}/submissions`);
                const submissionSnapshot = await getDocs(submissionsCol);
                submissionCounts[quiz.id] = submissionSnapshot.size;
            });
            await Promise.all(submissionPromises);

            let html = '';
            filteredQuizzes.forEach(quiz => {
                const submissionCount = submissionCounts[quiz.id] || 0;
                const status = quiz.status || 'active';
                const timerMode = quiz.settings?.timerMode || 'none';

                let statusText = '';
                let statusColor = '';
                const now = new Date();
                let effectiveStatus = status;

                if (status === 'scheduled') {
                    const startTime = quiz.startTime ? new Date(quiz.startTime) : null;
                    const endTime = quiz.endTime ? new Date(quiz.endTime) : null;
                    if (endTime && now > endTime) {
                        effectiveStatus = 'inactive';
                    } else if (startTime && now < startTime) {
                        effectiveStatus = 'scheduled_pending';
                    } else {
                        effectiveStatus = 'active'; // It's within the scheduled time
                    }
                }

                switch(effectiveStatus) {
                    case 'inactive':
                        statusText = 'ปิดใช้งาน';
                        statusColor = 'text-red-700 bg-red-100';
                        break;
                    case 'scheduled_pending':
                        statusText = 'รอเปิด';
                        statusColor = 'text-blue-700 bg-blue-100';
                        break;
                    case 'active':
                        statusText = timerMode !== 'none' ? 'เปิด (จับเวลา)' : 'เปิดใช้งาน';
                        statusColor = 'text-green-700 bg-green-100';
                        break;
                    default: // for 'scheduled' but currently active
                        statusText = 'ตั้งเวลา (เปิด)';
                        statusColor = 'text-green-700 bg-green-100';
                }


                let scheduleInfo = '';
                const timeFormatOptions = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
                if (status === 'scheduled') {
                    if (quiz.startTime) {
                         scheduleInfo += `<p class="text-xs text-gray-500 mt-1">เปิด: ${new Date(quiz.startTime).toLocaleString('th-TH', timeFormatOptions)}</p>`;
                    }
                    if (quiz.endTime) {
                         scheduleInfo += `<p class="text-xs text-gray-500 mt-1">ปิด: ${new Date(quiz.endTime).toLocaleString('th-TH', timeFormatOptions)}</p>`;
                    }
                }

                html += `
                    <div class="p-4 border rounded-lg hover:bg-gray-50 flex flex-col">
                         <div class="flex justify-between items-start">
                             <div class="quiz-result-card cursor-pointer flex-grow" data-quiz-id="${quiz.id}">
                                 
                                 <p class="font-semibold text-indigo-700 pointer-events-none">${quiz.topic} <span class="text-xs text-gray-500 pointer-events-none ml-2">(${quiz.questions.length} ข้อ)</span></p>

                                 <p class="text-sm text-gray-500 pointer-events-none">สร้างเมื่อ: ${new Date(quiz.createdAt).toLocaleString('th-TH')}</p>
                                 <div class="mt-1">
                                     <span class="font-semibold text-sm">${submissionCount}</span>
                                     <span class="text-xs text-gray-600"> คนส่ง</span>
                                 </div>
                                 ${scheduleInfo}
                             </div>
                             <div class="flex flex-col items-end">
                                 <div class="flex items-center gap-2">
                                     <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                                     <button data-quiz-id="${quiz.id}" class="quiz-status-btn text-gray-600 hover:text-indigo-600 text-lg p-1" title="ตั้งค่าสถานะ"><i class="fas fa-power-off"></i></button>
                                 </div>
                             </div>
                         </div>
                         <div class="flex items-center justify-end flex-wrap gap-2 mt-3 pt-3 border-t">
                             <button data-quiz-id="${quiz.id}" class="star-quiz-btn text-gray-400 hover:text-yellow-500 text-lg p-1" title="ติดดาว">
    <i class="${quiz.isStarred ? 'fas fa-star text-yellow-500' : 'far fa-star'}"></i>
</button>
                             <button data-quiz-id="${quiz.id}" class="start-live-race-btn text-orange-800 bg-orange-100 hover:bg-orange-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-flag-checkered"></i> แข่งขันสด</button>
                             <button data-quiz-id="${quiz.id}" data-topic="${quiz.topic}" class="rename-quiz-btn text-yellow-800 bg-yellow-100 hover:bg-yellow-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-edit"></i> แก้ไขชื่อ</button>
							 <button data-quiz-id="${quiz.id}" class="edit-quiz-btn text-blue-800 bg-blue-100 hover:bg-blue-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-edit"></i> แก้ไข</button>
                             <button data-quiz-id="${quiz.id}" class="quiz-settings-btn text-cyan-800 bg-cyan-100 hover:bg-cyan-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-cog"></i> ตั้งค่า</button>
                             <button data-quiz-id="${quiz.id}" class="duplicate-quiz-btn text-gray-800 bg-gray-100 hover:bg-gray-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-copy"></i> คัดลอก</button>
                             <button data-quiz-id="${quiz.id}" class="move-quiz-btn text-purple-800 bg-purple-100 hover:bg-purple-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-project-diagram"></i> ย้าย</button>
                             <button data-quiz-id="${quiz.id}" class="copy-quiz-id-list-btn text-blue-800 bg-blue-100 hover:bg-blue-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-id-card"></i> คัดลอก ID</button>
                             <button data-quiz-id="${quiz.id}" class="start-presentation-list-btn text-indigo-800 bg-indigo-100 hover:bg-indigo-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-chalkboard-teacher"></i> นำเสนอ</button>
                             <button data-quiz-id="${quiz.id}" class="admin-try-quiz-list-btn text-teal-800 bg-teal-100 hover:bg-teal-200 text-xs font-semibold py-1 px-3 rounded-md flex items-center gap-1"><i class="fas fa-vial"></i> ทดลอง</button>
                             <button data-quiz-id="${quiz.id}" data-topic="${quiz.topic}" class="delete-quiz-btn text-red-500 hover:text-red-700 text-lg p-1 ml-auto" title="ลบแบบทดสอบ"><i class="fas fa-trash-alt"></i></button>
                         </div>
                    </div>
                `;
            });
            quizzesListContainer.innerHTML = html;
            
            document.querySelectorAll('.quiz-result-card').forEach(card => {
                card.addEventListener('click', () => {
                    const quizId = card.dataset.quizId;
                    showQuizDetailView(quizId);
                });
            });
        }
        
        async function handleDuplicateQuiz(quizId) {
            try {
                const originalQuizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const originalQuizSnap = await getDoc(originalQuizRef);

                if (originalQuizSnap.exists()) {
                    const originalData = originalQuizSnap.data();
                    const newData = {
                        ...originalData,
                        topic: `(คัดลอก) ${originalData.topic}`,
                        createdAt: new Date().toISOString(),
                        // Submissions are not copied
                    };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/quizzes`), newData);
                    showMessage("คัดลอกแบบทดสอบสำเร็จ");
                } else {
                    throw new Error("Original quiz not found");
                }
            } catch (error) {
                console.error("Error duplicating quiz:", error);
                showMessage("เกิดข้อผิดพลาดในการคัดลอกแบบทดสอบ");
            }
        }


        async function handleDeleteQuiz(quizId, showSuccessMessage = true) {
             try {
                const batch = writeBatch(db);
                // 1. Delete all submissions in the subcollection
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`);
                const submissionsSnapshot = await getDocs(submissionsRef);
                submissionsSnapshot.forEach(subDoc => {
                    batch.delete(doc(submissionsRef, subDoc.id));
                });

                // 2. Delete the quiz document itself
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                batch.delete(quizRef);

                await batch.commit();

                if (showSuccessMessage) {
                    showMessage("ลบแบบทดสอบสำเร็จแล้ว");
                }
            } catch (error) {
                console.error("Error deleting quiz:", error);
                if (showSuccessMessage) {
                    showMessage("เกิดข้อผิดพลาดในการลบแบบทดสอบ");
                }
            }
        }

        async function showQuizDetailView(quizId) {
            if (unsubscribeSubmissionsListener) unsubscribeSubmissionsListener();
            switchQuizDetailTab('analytics');

            try {
                // 1. ดึงข้อมูลของแบบทดสอบที่คลิก
                const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizDoc = await getDoc(quizRef);

                if (!quizDoc.exists()) {
                    showMessage("ไม่พบข้อมูลแบบทดสอบ");
                    return;
                }

                const quizData = { id: quizDoc.id, ...quizDoc.data() };
                currentQuizData = quizData;

                // --- [ ส่วนที่แก้ไขใหม่ทั้งหมด ] ---
                // 2. ดึงข้อมูลของโปรเจคแม่ของแบบทดสอบนั้นๆ เสมอ
                // เพื่อให้แน่ใจว่าเรามีข้อมูลนักเรียน (currentProjectData) พร้อมใช้งาน
                const projectRef = doc(db, `artifacts/${appId}/public/data/projects`, quizData.projectId);
                const projectDoc = await getDoc(projectRef);
                if (projectDoc.exists()) {
                    currentProjectData = projectDoc.data();
                    currentProjectId = quizData.projectId; // อัปเดต ID โปรเจคปัจจุบันให้ถูกต้องเสมอ
                } else {
                    // ในกรณีที่โปรเจคถูกลบไปแล้วแต่แบบทดสอบยังอยู่ (กรณีฉุกเฉิน)
                    // ให้ใช้ข้อมูลว่างๆ แทนเพื่อไม่ให้แอปพัง
                    currentProjectData = { students: [] };
                    currentProjectId = quizData.projectId;
                }
                // --- [ สิ้นสุดส่วนที่แก้ไข ] ---

                // 3. ตั้งค่าหัวข้อและ ID บนหน้าจอ
                document.getElementById('results-quiz-title').textContent = quizData.topic;
                document.getElementById('results-quiz-id-display').textContent = quizId;

                // 4. เริ่มฟังข้อมูลการส่งงาน และวาดผลลัพธ์
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes`, quizId, "submissions");
                unsubscribeSubmissionsListener = onSnapshot(submissionsRef, (snapshot) => {
                    const submissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // ตอนนี้ currentProjectData จะมีข้อมูลนักเรียนพร้อมเสมอ
                    renderAnalytics(quizData, submissions);
                    renderQuizResultsTable(currentProjectData.students, submissions, quizData);
                    renderQuizLeaderboard(submissions, quizData, 'quiz-leaderboard-table-body');
                });

                // 5. แสดง View
                showView('quiz-results');

            } catch (error) {
                console.error("Error showing quiz detail view:", error);
                showMessage("เกิดข้อผิดพลาดในการแสดงรายละเอียดแบบทดสอบ");
            }
        }

        function renderQuizResultsTable(students, submissions, quizData) {
    const submissionsByStudent = submissions.reduce((acc, sub) => {
        acc[sub.studentName] = sub;
        return acc;
    }, {});

    const tableBody = document.getElementById('quiz-results-table-body');
    if (!students || students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" class="text-center p-4 text-gray-500">ไม่มีรายชื่อนักเรียนในโปรเจคนี้</td></tr>';
        return;
    }
    
    // --- UPDATED: เพิ่มการตรวจสอบโหมดซ่อม ---
    const isRemedialQuiz = quizData.isRemedial === true;
    const passingScore = quizData.settings?.passingScore ?? -1; 

    let html = '';
    students.forEach(studentName => {
        const submission = submissionsByStudent[studentName];
        let resultHtml = '<td class="py-2 px-4 border-b">-</td>';
        let quizTypeHtml = `<td class="py-2 px-4 border-b"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${isRemedialQuiz ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'}">${isRemedialQuiz ? 'สอบซ่อม' : 'สอบปกติ'}</span></td>`;
        
        if (submission) {
            let isPass;
            if (isRemedialQuiz) {
                isPass = (submission.bestScore === submission.totalQuestions);
            } else {
                isPass = passingScore !== -1 && submission.bestScore >= passingScore;
            }

            if (isRemedialQuiz || passingScore !== -1) {
                const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const resultText = isPass ? 'ผ่าน' : 'ไม่ผ่าน';
                resultHtml = `<td class="py-2 px-4 border-b"><span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${resultClass}">${resultText}</span></td>`;
            }
            
            const statusCell = `<td class="py-2 px-4 border-b"><span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ส่งแล้ว (${submission.attempts?.length || 1} ครั้ง)</span></td>`;

            html += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">${studentName}</td>
                    <td class="py-2 px-4 border-b text-green-600 font-bold">${submission.bestScore} / ${submission.totalQuestions}</td>
                    ${resultHtml}
                    ${quizTypeHtml}
                    <td class="py-2 px-4 border-b font-semibold">${submission.firstScore} / ${submission.totalQuestions}</td>
                    <td class="py-2 px-4 border-b font-semibold">${submission.latestScore}</td>
                    <td class="py-2 px-4 border-b font-semibold text-blue-600">${submission.points || 0}</td>
                    ${statusCell}
                    <td class="py-2 px-4 border-b text-sm text-gray-600">${new Date(submission.latestSubmittedAt).toLocaleString('th-TH')}</td>
                </tr>
            `;
        } else {
            const statusCell = `<td class="py-2 px-4 border-b"><span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">ยังไม่ส่ง</span></td>`;
            html += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b">${studentName}</td>
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    ${quizTypeHtml}
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    <td class="py-2 px-4 border-b">-</td>
                    ${statusCell}
                    <td class="py-2 px-4 border-b">-</td>
                </tr>
            `;
        }
    });
    tableBody.innerHTML = html;
}
        
        // --- Quiz Action Functions (Rename, Move, Timer, Status) ---
        function handleRenameQuiz(quizId, currentTopic) {
            actionTargetId = quizId;
            document.getElementById('rename-quiz-input').value = currentTopic;
            renameQuizModal.classList.remove('hidden');
        }

        async function confirmRenameQuiz() {
            const newName = document.getElementById('rename-quiz-input').value.trim();
            if (!newName) {
                showMessage("กรุณาใส่ชื่อใหม่");
                return;
            }
            if (!actionTargetId) return;

            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            try {
                await updateDoc(quizRef, { topic: newName });
                showMessage("เปลี่ยนชื่อแบบทดสอบสำเร็จ");
                renameQuizModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error renaming quiz:", error);
                showMessage("เกิดข้อผิดพลาดในการเปลี่ยนชื่อ");
            }
        }
        
        async function handleMoveQuiz(quizId) {
            actionTargetId = quizId;
            const projectSelect = document.getElementById('move-quiz-project-select');
            projectSelect.innerHTML = '<option>กำลังโหลดโปรเจค...</option>';
            moveQuizModal.classList.remove('hidden');

            try {
                const projectsRef = collection(db, `artifacts/${appId}/public/data/projects`);
                const snapshot = await getDocs(projectsRef);
                const projects = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const otherProjects = projects.filter(p => p.id !== currentProjectId);

                if (otherProjects.length === 0) {
                    projectSelect.innerHTML = '<option value="">ไม่มีโปรเจคอื่นให้ย้ายไป</option>';
                    document.getElementById('confirm-move-quiz-btn').disabled = true;
                    return;
                }

                projectSelect.innerHTML = otherProjects
                    .map(p => `<option value="${p.id}">${p.projectName}</option>`)
                    .join('');
                document.getElementById('confirm-move-quiz-btn').disabled = false;

            } catch (error) {
                console.error("Error fetching projects for move:", error);
                showMessage("ไม่สามารถโหลดรายการโปรเจคได้");
                moveQuizModal.classList.add('hidden');
            }
        }

        async function confirmMoveQuiz() {
            const newProjectId = document.getElementById('move-quiz-project-select').value;
            if (!newProjectId) {
                showMessage("กรุณาเลือกโปรเจคปลายทาง");
                return;
            }
            if (!actionTargetId) return;

            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            try {
                await updateDoc(quizRef, { projectId: newProjectId });
                showMessage("ย้ายแบบทดสอบสำเร็จ");
                moveQuizModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error moving quiz:", error);
                showMessage("เกิดข้อผิดพลาดในการย้ายแบบทดสอบ");
            }
        }

        async function handleQuizSettings(quizId) {
    actionTargetId = quizId;
    const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
    try {
        const quizSnap = await getDoc(quizRef);
        if (quizSnap.exists()) {
            const quizData = quizSnap.data();
            const settings = quizData.settings || {};
            const totalQuestions = quizData.questions.length;
            
            document.getElementById('modal-shuffle-select').value = settings.shuffle || 'none';
            document.getElementById('modal-results-display-select').value = settings.resultsDisplay || 'show_results_and_answers';
            document.getElementById('modal-timer-mode-select').value = settings.timerMode || 'none';
            document.getElementById('modal-timer-duration-input').value = settings.timerDuration || 10;
            document.getElementById('modal-passing-score-input').value = settings.passingScore || Math.floor(totalQuestions / 2);
            document.getElementById('modal-passing-score-input').max = totalQuestions;
            
            // --- บรรทัดที่แก้ไขและอัปเดตล่าสุด ---
            document.getElementById('modal-adaptive-quiz-checkbox').checked = settings.isAdaptive || false;
            
            document.getElementById('modal-timer-mode-select').dispatchEvent(new Event('change'));

            quizSettingsModal.classList.remove('hidden');
        } else {
            showMessage("ไม่พบข้อมูลแบบทดสอบ");
        }
    } catch (error) {
        console.error("Error fetching quiz settings:", error);
        showMessage("เกิดข้อผิดพลาดในการโหลดการตั้งค่า");
    }
}

        async function confirmQuizSettings() {
            if (!actionTargetId) return;
            
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            
            const newSettings = {
                shuffle: document.getElementById('modal-shuffle-select').value,
                resultsDisplay: document.getElementById('modal-results-display-select').value,
                timerMode: document.getElementById('modal-timer-mode-select').value,
                timerDuration: parseInt(document.getElementById('modal-timer-duration-input').value) || 10,
                passingScore: parseInt(document.getElementById('modal-passing-score-input').value) || 0,
            passingScore: parseInt(document.getElementById('modal-passing-score-input').value) || 0,
    isAdaptive: document.getElementById('modal-adaptive-quiz-checkbox').checked // <-- เพิ่ม Checkbox ID ของ Modal
};

            try {
                await updateDoc(quizRef, {
                    settings: newSettings
                });
                showMessage("บันทึกการตั้งค่าสำเร็จ");
                quizSettingsModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                console.error("Error updating quiz settings:", error);
                showMessage("เกิดข้อผิดพลาดในการบันทึก");
            }
        }

                async function handleQuizStatus(quizId) {
            actionTargetId = quizId;
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
            try {
                const quizSnap = await getDoc(quizRef);
                if (quizSnap.exists()) {
                    const data = quizSnap.data();
                    const status = data.status || 'active';
                    const optionsContainer = document.getElementById('quiz-status-options');
                    const startContainer = document.getElementById('quiz-schedule-start-container');
                    const endContainer = document.getElementById('quiz-schedule-end-container');
                    
                    let optionsHtml = `
                        <div><input type="radio" name="status-option" value="active" id="status-active" ${status === 'active' ? 'checked' : ''}> <label for="status-active">เปิดใช้งาน (Active)</label></div>
                        <div><input type="radio" name="status-option" value="inactive" id="status-inactive" ${status === 'inactive' ? 'checked' : ''}> <label for="status-inactive">ปิดใช้งาน (Inactive)</label></div>
                        <div><input type="radio" name="status-option" value="schedule" id="status-schedule" ${status === 'scheduled' ? 'checked' : ''}> <label for="status-schedule">ตั้งเวลาเปิด/ปิด (Schedule)</label></div>
                    `;
                    
                    optionsContainer.innerHTML = optionsHtml;
                    
                    const showSchedule = status === 'scheduled';
                    startContainer.classList.toggle('hidden', !showSchedule);
                    endContainer.classList.toggle('hidden', !showSchedule);
                    document.getElementById('quiz-start-time').value = data.startTime ? data.startTime.substring(0, 16) : '';
                    document.getElementById('quiz-end-time').value = data.endTime ? data.endTime.substring(0, 16) : '';


                    optionsContainer.querySelectorAll('input[name="status-option"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            const show = e.target.value === 'schedule';
                            startContainer.classList.toggle('hidden', !show);
                            endContainer.classList.toggle('hidden', !show);
                        });
                    });

                    quizStatusModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching quiz status:", error);
                showMessage("เกิดข้อผิดพลาดในการโหลดสถานะ");
            }
        }

        async function confirmQuizStatus() {
            if (!actionTargetId) return;
            const quizRef = doc(db, `artifacts/${appId}/public/data/quizzes`, actionTargetId);
            const selectedOption = document.querySelector('input[name="status-option"]:checked');
            
            if (!selectedOption) {
                showMessage("กรุณาเลือกสถานะ");
                return;
            }

            const statusChoice = selectedOption.value;
            let dataToUpdate = {};

            if (statusChoice === 'active' || statusChoice === 'inactive') {
                dataToUpdate = { status: statusChoice, startTime: null, endTime: null };
            } else if (statusChoice === 'schedule') {
                const startTime = document.getElementById('quiz-start-time').value;
                const endTime = document.getElementById('quiz-end-time').value;
                if (!startTime && !endTime) {
                    showMessage("กรุณาเลือกเวลาเปิด หรือ เวลาปิด อย่างน้อยหนึ่งอย่าง");
                    return;
                }
                dataToUpdate = { 
                    status: 'scheduled', 
                    startTime: startTime ? new Date(startTime).toISOString() : null,
                    endTime: endTime ? new Date(endTime).toISOString() : null
                };
            }

            try {
                await updateDoc(quizRef, dataToUpdate);
                showMessage("อัปเดตสถานะสำเร็จ");
                quizStatusModal.classList.add('hidden');
                actionTargetId = null;
            } catch (error) {
                 console.error("Error updating quiz status:", error);
                 showMessage("เกิดข้อผิดพลาดในการอัปเดตสถานะ");
            }
        }

        // --- Leaderboard ---
        function listenForStudentProfiles(projectId) {
            const profilesRef = collection(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`);
            unsubscribeStudentProfilesListener = onSnapshot(profilesRef, (snapshot) => {
                const profiles = snapshot.docs.map(doc => doc.data());
                renderLeaderboard(profiles, 'leaderboard-table-body');
            }, (error) => {
                console.error("Error listening for student profiles:", error);
                document.getElementById('leaderboard-table-body').innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลผู้นำ</td></tr>';
            });
        }

        function renderLeaderboard(profiles, tableBodyId) {
            const tableBody = document.getElementById(tableBodyId);
            if (!profiles || profiles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">ยังไม่มีข้อมูลคะแนนสำหรับตารางผู้นำ</td></tr>';
                return;
            }

            // --- Advanced Ranking ---
            profiles.sort((a, b) => {
                // 1. Primary: Total Points
                const pointsDiff = (b.totalPoints || 0) - (a.totalPoints || 0);
                if (pointsDiff !== 0) return pointsDiff;

                // 2. Secondary: Number of Specialist (👩‍🚀) badges
                const specialistDiff = (b.badgesCount?.specialist || 0) - (a.badgesCount?.specialist || 0);
                if (specialistDiff !== 0) return specialistDiff;

                // 3. Tertiary: Number of First Try Ace (🚀) badges
                const firstTryAceDiff = (b.badgesCount?.first_try_ace || 0) - (a.badgesCount?.first_try_ace || 0);
                if (firstTryAceDiff !== 0) return firstTryAceDiff;

                // 4. Quaternary: Number of Perfect Score (👑) badges
                const perfectScoreDiff = (b.badgesCount?.perfect_score || 0) - (a.badgesCount?.perfect_score || 0);
                if (perfectScoreDiff !== 0) return perfectScoreDiff;
                
                // 5. Quinary: Number of Quick Thinker (⚡️) badges
                const quickThinkerDiff = (b.badgesCount?.quick_thinker || 0) - (a.badgesCount?.quick_thinker || 0);
                if (quickThinkerDiff !== 0) return quickThinkerDiff;

                // 6. Final: Alphabetical by name
                return a.studentName.localeCompare(b.studentName, 'th');
            });

            let html = '';
            profiles.forEach((profile, index) => {
                const rank = index + 1;
                const badgesCount = profile.badgesCount || {};

                let badgesHTML = '';
                const badgeOrder = ['specialist', 'perfect_score', 'first_try_ace', 'quick_thinker'];

                badgeOrder.forEach(badgeId => {
                    if (badgesCount[badgeId] > 0) {
                        const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                        if (badgeInfo) {
                            if (badgeId === 'specialist') {
                                // For specialist, just show the icon
                                badgesHTML += `
                                    <span class="inline-flex items-center mx-1" title="${badgeInfo.name}">
                                        <i class="fas ${badgeInfo.icon} text-lg"></i>
                                    </span>
                                `;
                            } else {
                                // For others, show icon and count
                                badgesHTML += `
                                    <span class="inline-flex items-center mx-1" title="${badgeInfo.name} (${badgesCount[badgeId]} ครั้ง)">
                                        <i class="fas ${badgeInfo.icon} text-lg"></i>
                                        <span class="ml-1 text-sm font-semibold">${badgesCount[badgeId]}</span>
                                    </span>
                                `;
                            }
                        }
                    }
                });

                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-center font-bold">${rank}</td>
                        <td class="py-2 px-4 border-b">${profile.studentName}</td>
                        <td class="py-2 px-4 border-b text-center font-semibold text-indigo-600">${profile.totalPoints || 0}</td>
                        <td class="py-2 px-4 border-b">${badgesHTML || '-'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }

        // NEW: Render Quiz-specific Leaderboard
        function renderQuizLeaderboard(submissions, quizData, tableBodyId) {
            const tableBody = document.getElementById(tableBodyId);
            const isStudentView = tableBodyId === 'student-quiz-leaderboard-table-body';
            const totalQuestions = quizData.questions.length;

            if (!submissions || submissions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${isStudentView ? 6 : 8}" class="text-center p-4 text-gray-500">ยังไม่มีนักเรียนส่งแบบทดสอบนี้</td></tr>`;
                return;
            }

            // Sort by best score descending, then by latest submission time ascending
            submissions.sort((a, b) => {
                if (b.bestScore !== a.bestScore) {
                    return b.bestScore - a.bestScore;
                }
                return new Date(a.latestSubmittedAt) - new Date(b.latestSubmittedAt);
            });

            // --- UPDATED: เพิ่มการตรวจสอบโหมดซ่อม ---
            const isRemedialQuiz = quizData.isRemedial === true;
            const passingScore = quizData.settings?.passingScore ?? -1;

            let html = '';
            submissions.forEach((sub, index) => {
                const rank = index + 1;
                
                let resultHtml = '<td class="py-2 px-4 border-b text-center">-</td>';
                if (isRemedialQuiz || passingScore !== -1) {
                    let isPass;
                    if (isRemedialQuiz) {
                        isPass = (sub.bestScore === totalQuestions);
                    } else {
                        isPass = sub.bestScore >= passingScore;
                    }
                    const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const resultText = isPass ? 'ผ่าน' : 'ไม่ผ่าน';
                    resultHtml = `<td class="py-2 px-4 border-b text-center"><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${resultClass}">${resultText}</span></td>`;
                }

                const latestAttempt = sub.attempts[sub.attempts.length - 1];
                const badgesHTML = (latestAttempt.badges || [])
                    .map(badgeId => {
                        const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                        return badgeInfo ? `<span title="${badgeInfo.name}"><i class="fas ${badgeInfo.icon} mx-1 text-lg"></i></span>` : '';
                    })
                    .join('');
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-2 px-4 border-b text-center font-bold">${rank}</td>
                        <td class="py-2 px-4 border-b">${sub.studentName}</td>
                        <td class="py-2 px-4 border-b text-center font-bold text-green-600">${sub.bestScore} / ${totalQuestions}</td>
                        ${resultHtml}
                        <td class="py-2 px-4 border-b text-center font-semibold text-blue-600">${sub.points || 0}</td>
                        ${isStudentView ? "" : `<td class="py-2 px-4 border-b text-center">${sub.attempts?.length || 1}</td>`}
                        ${isStudentView ? "" : `<td class="py-2 px-4 border-b text-sm text-gray-600">${new Date(sub.latestSubmittedAt).toLocaleString('th-TH')}</td>`}
                        <td class="py-2 px-4 border-b">${badgesHTML || '-'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }


        // --- Student Flow ---
        async function handleLoadQuiz() {
            const quizIdInput = document.getElementById('quiz-id-input');
            const quizId = quizIdInput.value.trim();
            if (!quizId) {
                showMessage("กรุณาป้อนรหัสแบบทดสอบ");
                return;
            }

            loadQuizBtn.disabled = true;
            loadQuizBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังโหลด...';

            try {
                const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
                const quizDocSnap = await getDoc(quizDocRef);

                if (!quizDocSnap.exists()) {
                    showMessage("ไม่พบแบบทดสอบสำหรับรหัสนี้");
                    return;
                }

                currentQuizData = sanitizeQuizData({ id: quizDocSnap.id, ...quizDocSnap.data() });

                // Check Quiz Status
                const status = currentQuizData.status || 'active';
                const now = new Date();
                if (status === 'inactive') {
                    showMessage("แบบทดสอบนี้ปิดใช้งานอยู่");
                    return;
                }
                if (status === 'scheduled') {
                    const startTime = currentQuizData.startTime ? new Date(currentQuizData.startTime) : null;
                    const endTime = currentQuizData.endTime ? new Date(currentQuizData.endTime) : null;
                    
                    if (startTime && now < startTime) {
                        showMessage(`แบบทดสอบนี้จะเปิดให้ทำในวันที่ ${startTime.toLocaleString('th-TH', { hour12: false })}`);
                        return;
                    }
                    if (endTime && now > endTime) {
                        showMessage("แบบทดสอบนี้หมดเวลาแล้ว");
                        return;
                    }
                }
                
                const projectId = currentQuizData.projectId;
				currentProjectId = projectId;   // <-- เพิ่มบรรทัดนี้
                const projectDocRef = doc(db, `artifacts/${appId}/public/data/projects`, projectId);
                const projectDocSnap = await getDoc(projectDocRef);

                if (!projectDocSnap.exists()) {
                    showMessage("เกิดข้อผิดพลาด: ไม่พบโปรเจคที่เกี่ยวข้องกับแบบทดสอบนี้");
                    return;
                }
                
                const projectData = projectDocSnap.data();
                currentStudentProjectData = projectData; 
                displayStudentNameSelector(projectData.students, currentQuizData.topic);

            } catch (error) {
                console.error("Error loading quiz for student:", error);
                showMessage("เกิดข้อผิดพลาดในการโหลดแบบทดสอบ");
            } finally {
                loadQuizBtn.disabled = false;
                loadQuizBtn.innerHTML = '<i class="fas fa-search mr-2"></i>ค้นหาแบบทดสอบ';
            }
        }

async function handleJoinLiveGame() {
    const pinInput = document.getElementById('game-pin-input');
    const nicknameInput = document.getElementById('nickname-input');
    const joinBtn = document.getElementById('confirm-join-game-btn');

    const gamePin = pinInput.value.trim();
    const nickname = nicknameInput.value.trim();

    if (!gamePin || !nickname) {
        showMessage("กรุณากรอกรหัสเข้าร่วมและชื่อเล่นให้ครบถ้วน");
        return;
    }

    joinBtn.disabled = true;
    joinBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังเข้าร่วม...';

    try {
        // 1. ค้นหาเกมด้วย PIN เพียงอย่างเดียว ไม่ต้องเช็ค status
        const gamesRef = collection(db, `artifacts/${appId}/public/data/liveGames`);
        const q = query(gamesRef, where("gamePin", "==", gamePin), where("status", "==", "lobby"));
        const gameSnapshot = await getDocs(q);

        if (gameSnapshot.empty) {
            showMessage("ไม่พบเกมด้วยรหัสนี้ กรุณาตรวจสอบอีกครั้ง");
            return;
        }

        const gameDoc = gameSnapshot.docs[0];
        const gameData = gameDoc.data();

        currentLiveGameId = gameDoc.id;
        
        // Pre-fetch the quiz data as soon as the student joins
        const quizId = gameData.quizId;
        const quizDocRef = doc(db, `artifacts/${appId}/public/data/quizzes`, quizId);
        const quizDocSnap = await getDoc(quizDocRef);
        if (!quizDocSnap.exists()) {
            showMessage("เกิดข้อผิดพลาด: ไม่พบข้อมูลแบบทดสอบของเกมนี้");
            return;
        }
        currentQuizData = sanitizeQuizData({ id: quizDocSnap.id, ...quizDocSnap.data() });

        // Check if nickname already exists
        if (gameData.players && gameData.players[nickname]) {
            showMessage("ชื่อเล่นนี้ถูกใช้ไปแล้ว กรุณาใช้ชื่ออื่น");
            return;
        }

        // Add player to the game
        const playerUpdate = {};
        playerUpdate[`players.${nickname}`] = {
            score: 0,
            answered: false,
            badges: [],
            correctStreak: 0
        };
        await updateDoc(doc(db, `artifacts/${appId}/public/data/liveGames`, currentLiveGameId), playerUpdate);

        // Switch to waiting/game view for the student
        currentStudentName = nickname;
        listenForLiveGameUpdates();

    } catch (error) {
        console.error("Error joining live game:", error);
        showMessage("เกิดข้อผิดพลาดในการเข้าร่วมเกม");
    } finally {
        joinBtn.disabled = false;
        joinBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>เข้าร่วม';
    }
}

        function displayStudentNameSelector(students, topic) {
            const studentNameSelect = document.getElementById('student-name-select');
            document.getElementById('student-quiz-topic').textContent = `แบบทดสอบ: ${topic}`;
            
            if (!students || students.length === 0) {
                studentNameSelect.innerHTML = `<option value="">ไม่พบรายชื่อนักเรียนในโปรเจคนี้</option>`;
                startQuizBtn.disabled = true;
            } else {
                studentNameSelect.innerHTML = '<option value="">-- กรุณาเลือกชื่อ --</option>';
                students.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    studentNameSelect.appendChild(option);
                });
                startQuizBtn.disabled = false;
            }

            studentInitialView.classList.add('hidden');
            studentNameSelectionView.classList.remove('hidden');
        }

        // Helper to shuffle arrays
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
		
		/**
         * สร้างสำเนาของแบบทดสอบและทำการสลับข้อ/ตัวเลือกตามการตั้งค่า
         * @param {object} originalQuizData - ข้อมูลแบบทดสอบต้นฉบับ
         * @returns {object} ข้อมูลแบบทดสอบชุดใหม่ที่ผ่านการสลับแล้ว
         */
        function getShuffledQuiz(originalQuizData) {
            // สร้างสำเนาข้อมูลทั้งหมดเพื่อไม่ให้กระทบต้นฉบับ
            let processedQuiz = JSON.parse(JSON.stringify(originalQuizData)); 
            const shuffleSetting = processedQuiz.settings?.shuffle || 'none';

            if (shuffleSetting === 'none') {
                return processedQuiz; // ถ้าไม่สลับ ก็ส่งข้อมูลเดิมกลับไปเลย
            }

            // 1. สลับลำดับคำถาม (ถ้าตั้งค่าไว้)
            if (shuffleSetting === 'questions_only' || shuffleSetting === 'both') {
                shuffleArray(processedQuiz.questions);
            }

            // 2. สลับลำดับตัวเลือกในแต่ละคำถาม (ถ้าตั้งค่าไว้)
            if (shuffleSetting === 'choices_only' || shuffleSetting === 'both') {
                processedQuiz.questions.forEach(q => {
                    const questionType = q.questionType || processedQuiz.quizType;
                    // สลับตัวเลือกสำหรับ Multiple Choice
                    if (q.options) { 
                        let optionsToShuffle = q.options.map((opt, index) => ({
                            text: opt,
                            isCorrect: index === q.correctAnswerIndex
                        }));
                        shuffleArray(optionsToShuffle);
                        // อัปเดต options และ correctAnswerIndex ใหม่ตามลำดับที่สลับแล้ว
                        q.options = optionsToShuffle.map(opt => opt.text);
                        q.correctAnswerIndex = optionsToShuffle.findIndex(opt => opt.isCorrect);
                    }
                    // สลับตัวเลือกสำหรับ Matching
                    if (questionType === 'matching_item' && q.allResponses) {
                        shuffleArray(q.allResponses);
                    }
                });
            }
            
            return processedQuiz;
        }

        function displayQuizForStudent(quizData) {
            studentQuizArea.classList.remove('hidden');
            
            // --- ใช้ฟังก์ชันใหม่ในการสลับข้อ/ตัวเลือก ---
            currentDisplayedQuiz = getShuffledQuiz(quizData);

            // *** NEW: Timer Logic ***
            const timerMode = currentDisplayedQuiz.settings?.timerMode || 'none';
            if (timerMode === 'whole_quiz') {
                renderFullQuizForm();
                startWholeQuizTimer(currentDisplayedQuiz.settings.timerDuration);
            } else if (timerMode === 'per_question') {
                currentQuestionIndex = 0;
                studentAnswersPerQuestion = [];
                renderPerQuestionView();
            } else {
                renderFullQuizForm();
            }
        }
        
        function renderFullQuizForm() {
            let html = `
                 <div id="timer-container" class="mb-4"></div>
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-bold">แบบทดสอบ: ${currentDisplayedQuiz.topic}</h3>
                     ${currentMode === 'admin-testing' ? '<button id="cancel-test-btn" class="text-sm text-gray-500 hover:text-red-600 font-semibold py-1 px-2 rounded-md hover:bg-red-50"><i class="fas fa-times-circle mr-1"></i> ยกเลิกการทดสอบ</button>' : ''}
                 </div>
                 <form id="quiz-form">
            `;
            currentDisplayedQuiz.questions.forEach((q, questionIndex) => {
                const questionType = q.questionType || currentDisplayedQuiz.quizType;
                html += `
                    <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <div class="font-semibold mb-3">
                `;

                // Adjust display for matching_item
                if (questionType === 'matching_item') {
                    // ... ภายในฟังก์ชัน renderFullQuizForm, ส่วนของ case 'matching_item'
html += `
    <div class="flex items-center gap-4">
        <div class="w-1/2">${questionIndex + 1}. ${q.stem}</div>
        <div class="w-1/2">
            <select name="question${questionIndex}" class="w-full p-2 border border-gray-300 rounded-lg" required>
                <option value="">-- เลือกคำตอบ --</option>
                ${q.allResponses.map(resp => `<option value="${resp}">${resp}</option>`).join('')}
            </select>
        </div>
    </div>
`;
                } else {
                    html += `<p>${questionIndex + 1}. ${q.instructions || q.questionText}</p>`;
                    if (q.imageCode) {
                        html += `<div class="my-4 flex justify-center">${q.imageCode}</div>`;
                    }
                }
                
                html += `</div><div class="space-y-2">`;
                
                switch(questionType) {
                    case 'short_answer':
                        html += `<textarea name="question${questionIndex}" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" required></textarea>`;
                        break;
                    case 'true_false':
                        html += `<div><input type="radio" id="q${questionIndex}_opt0" name="question${questionIndex}" value="true" class="mr-2 accent-indigo-600" required><label for="q${questionIndex}_opt0">ใช่</label></div>`;
                        html += `<div><input type="radio" id="q${questionIndex}_opt1" name="question${questionIndex}" value="false" class="mr-2 accent-indigo-600" required><label for="q${questionIndex}_opt1">ไม่ใช่</label></div>`;
                        break;
                    case 'matching_item':
                        // The HTML is already rendered above, so we do nothing here.
                        break;
                    case 'fill_in_the_blank':
                    case 'multiple_choice':
                    default:
                        // โค้ดที่แก้ไขแล้ว
html += q.options.map((opt, i) => `
    <div>
        <input type="radio" id="q${questionIndex}_opt${i}" name="question${questionIndex}" value="${i}" class="mr-2 accent-indigo-600" required>
        <label for="q${questionIndex}_opt${i}">${opt}</label>
    </div>
`).join('');
// หมายเหตุ: โค้ดที่ถูกต้องควรจะวนลูปจาก q.options และสร้าง input radio สำหรับแต่ละตัวเลือก
                        break;
                }

                html += `
                        </div>
                    </div>
                `;
            });
            html += `<button type="submit" class="w-full mt-4 bg-purple-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-purple-700">
                         <i class="fas fa-check-circle mr-2"></i>ส่งคำตอบ
                        </button>`;
            html += `</form>`;
            studentQuizArea.innerHTML = html;
            
            if (currentMode === 'admin-testing') {
                const cancelBtn = document.getElementById('cancel-test-btn');
                if(cancelBtn) cancelBtn.addEventListener('click', cancelAdminTest);
            }

            document.getElementById('quiz-form').addEventListener('submit', handleSubmitQuiz);
            if (window.MathJax) window.MathJax.typesetPromise([studentQuizArea]);
        }

        async function handleSubmitQuiz(event) {
            if(event) event.preventDefault();
            if(quizTimerInterval) clearInterval(quizTimerInterval); // Stop timer on manual submit
            
            const form = document.getElementById('quiz-form');
            if (!form) return; // Form might not exist if timer auto-submits
            
            const submitButton = form.querySelector('button[type="submit"]');
            const hasShortAnswer = currentDisplayedQuiz.questions.some(q => q.questionType === 'short_answer');

            if(submitButton) {
                submitButton.disabled = true;
                if(hasShortAnswer) {
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI กำลังตรวจคำตอบ...';
                } else {
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังส่งคำตอบ...';
                }
            }
            
            const formData = new FormData(form);
            
            const userAnswers = currentDisplayedQuiz.questions.map((q, questionIndex) => {
                const questionType = q.questionType || currentDisplayedQuiz.quizType;
                const answer = formData.get(`question${questionIndex}`);
                if (answer !== null && answer !== undefined) {
                    if (questionType === 'multiple_choice' || questionType === 'fill_in_the_blank') return parseInt(answer);
                    return answer;
                }
                return null; // No answer provided
            });
            
            // Get previous submissions to calculate new badges
            const quizId = currentQuizData.id;
            const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);
            const submissionSnap = await getDoc(submissionRef);
            const existingData = submissionSnap.exists() ? submissionSnap.data() : {};
            const previousAttempts = existingData.attempts || [];

            await processAndSubmitAnswers(userAnswers, previousAttempts);
        }
        
        async function gradeShortAnswerWithAI(userAnswer, idealAnswer) {
            if (!userAnswer || !idealAnswer) return false;
            try {
                const prompt = `Please evaluate if the user's answer is correct based on the ideal answer. The context is a simple quiz, so be lenient with phrasing but strict with the core concept. User Answer: "${userAnswer}". Ideal Answer: "${idealAnswer}". Respond with only "true" or "false".`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // API key will be provided by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('API call failed');
                
                const result = await response.json();
                const textResponse = result.candidates[0].content.parts[0].text.trim().toLowerCase();
                return textResponse === 'true';

            } catch (error) {
                console.error("AI grading failed:", error);
                return false; // Default to incorrect if AI fails
            }
        }


        async function processAndSubmitAnswers(userAnswers, previousAttempts) {
    let score = 0;
    let points = 0;
    let earnedBadges = [];
    const detailedAnswers = [];
    const totalQuestions = currentDisplayedQuiz.questions.length;

    // --- Gamification Logic ---
    let correctStreak = 0;

    const questions = currentDisplayedQuiz.questions;
    for (let i = 0; i < questions.length; i++) {
        const q = questions[i];
        const userAnswer = userAnswers[i];
        const questionType = q.questionType || currentDisplayedQuiz.quizType;
        let isCorrect = false;

        if (userAnswer !== null && userAnswer !== "") {
            switch (questionType) {
                case 'matching_item':
                    isCorrect = userAnswer === q.correctResponse;
                    break;
                case 'true_false':
                    // แปลงคำตอบผู้ใช้ให้เป็น boolean ก่อนเทียบ
                    const userBool = (userAnswer === true || userAnswer === 'true');
                    isCorrect = (userBool === q.correctAnswer);
                    break;

                case 'fill_in_the_blank':
                case 'multiple_choice':
                default:
                    // แปลงเป็นตัวเลขก่อนเทียบ เพื่อกันกรณี "1" vs 1
                    isCorrect = (Number(userAnswer) === q.correctAnswerIndex);
                    break;

                 case 'short_answer':
                    // เรียกใช้ฟังก์ชันตรวจคำตอบแบบหลายชั้นตัวใหม่
                    isCorrect = await gradeShortAnswer(userAnswer, q);
                    break;
            }
        }

        if (isCorrect) {
            score++;
            correctStreak++;
            if (correctStreak === 3) {
                earnedBadges.push(BADGES.ON_FIRE.id);
                correctStreak = 0;
            }
        } else {
            correctStreak = 0; // Reset streak on incorrect answer
        }
        
        // --- [การแก้ไขที่สำคัญ] ---
        // เพิ่ม originalQuestionText เพื่อให้สถิติถูกต้องเสมอ
        detailedAnswers.push({
            answer: userAnswer,
            isCorrect: isCorrect,
            originalQuestionText: q.stem || q.questionText
        });
    }

    points = score * 10; // Base points
    if (score === totalQuestions && totalQuestions > 0 && !currentDisplayedQuiz.isRemedial) {
        points += 50; // Perfect score bonus
        earnedBadges.push(BADGES.PERFECT_SCORE.id);
    }
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? Math.floor(totalQuestions / 2);
    // Check for speed bonus if it was a timed quiz
    const timerMode = currentDisplayedQuiz.settings?.timerMode;
    if (timerMode === 'whole_quiz' && quizStartTime) {
        const timeTaken = (new Date() - quizStartTime) / 1000; // in seconds
        const timeAllowed = currentDisplayedQuiz.settings.timerDuration * 60;
        if (score >= passingScore && timeTaken < timeAllowed / 2) {
            points += 20; // Speed bonus
            earnedBadges.push(BADGES.QUICK_THINKER.id);
        }
    }
    // --- Badge Logic for new badges ---

    // 1. First-Try Ace: Perfect score on the very first attempt.
    if (previousAttempts.length === 0 && score === totalQuestions && totalQuestions > 0) {
        earnedBadges.push(BADGES.FIRST_TRY_ACE.id);
    }

    // 2. Comeback King: Failed the first time, but passed this time.
    if (previousAttempts.length > 0) {
        const firstAttemptScore = previousAttempts[0].score;
        if (firstAttemptScore < passingScore && score >= passingScore) {
            // Check if they haven't earned this badge for this quiz before
            const hasComebackBadge = previousAttempts.some(attempt =>
                (attempt.badges || []).includes(BADGES.COMEBACK_KING.id)
            );
            if (!hasComebackBadge) {
                earnedBadges.push(BADGES.COMEBACK_KING.id);
            }
        }
    }
    // 3. Perseverance: Awarded on the 5th attempt
    if (previousAttempts.length === 4) { // This is the 5th attempt (0-indexed)
        earnedBadges.push(BADGES.PERSEVERANCE.id);
    }
    // In admin test mode, use the project's current settings for display
    const displaySetting = currentDisplayedQuiz.settings.resultsDisplay;

    if (currentMode === 'admin-testing') {
        handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions);
        return;
    }

    const quizId = currentQuizData.id;
    const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);

    try {
        const attempts = [...previousAttempts]; // Create a mutable copy
        const newAttempt = {
            score: score,
            points: points,
            badges: earnedBadges,
            submittedAt: new Date().toISOString(),
            answers: detailedAnswers
        };
        attempts.push(newAttempt);

        const firstScore = attempts[0].score;
        const bestScore = Math.max(...attempts.map(a => a.score));
        const latestScore = score;
        const latestSubmittedAt = newAttempt.submittedAt;

        await setDoc(submissionRef, {
            studentName: currentStudentName,
            totalQuestions: totalQuestions,
            attempts: attempts,
            firstScore: firstScore,
            bestScore: bestScore,
            latestScore: latestScore,
            points: points, // Store points from the latest attempt
            latestSubmittedAt: latestSubmittedAt
        });

        // Update the aggregated student profile for the leaderboard
        await updateStudentProfile(currentQuizData.projectId, currentStudentName);
        handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions);
    } catch (error) {
        console.error("Error saving submission:", error);
        showMessage("เกิดข้อผิดพลาดในการบันทึกคำตอบของคุณ");
    }
}
        
        async function updateStudentProfile(projectId, studentName) {
    const profileRef = doc(db, `artifacts/${appId}/public/data/projects/${projectId}/studentProfiles`, studentName);

    try {
        // 1. Get all quizzes in the project (outside the transaction is fine)
        const quizzesQuery = query(
            collection(db, `artifacts/${appId}/public/data/quizzes`),
            where("projectId", "==", projectId)
        );
        const quizzesSnapshot = await getDocs(quizzesQuery);
        // สร้าง Map ของข้อมูลแบบทดสอบทั้งหมดเพื่อให้เข้าถึงได้ง่ายใน transaction
        const quizzesDataMap = new Map(quizzesSnapshot.docs.map(doc => [doc.id, doc.data()]));
        const quizIds = Array.from(quizzesDataMap.keys());

        // 2. Start a transaction to read all submissions and write the new profile
        await runTransaction(db, async (transaction) => {
            let calculatedTotalPoints = 0;
            const finalBadgesCount = {};
            let allQuizzesPerfect = true;
            let mainQuizzesSubmittedCount = 0;
            let totalMainQuizzes = 0;

            // 3. Loop through each quiz to aggregate points and badges
            for (const quizId of quizIds) {
                const quizData = quizzesDataMap.get(quizId);
                const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, studentName);
                const submissionDoc = await transaction.get(submissionRef);

                // --- ส่วนคำนวณคะแนนรวม (Total Points) ---
                if (submissionDoc.exists()) {
                    const submissionData = submissionDoc.data();
                    const attempts = submissionData.attempts || [];
                    if (attempts.length > 0) {
                        // หาครั้งที่ได้คะแนนดีที่สุดเพื่อนำมาคำนวณ Points
                        const bestAttempt = attempts.reduce((best, current) => {
                            if (current.score > best.score) return current;
                            if (current.score === best.score) {
                                return (current.points || 0) > (best.points || 0) ? current : best;
                            }
                            return best;
                        }, { score: -1, points: -1 });

                        if (bestAttempt.score > -1) {
                            calculatedTotalPoints += bestAttempt.points || 0;
                            (bestAttempt.badges || []).forEach(badgeId => {
                                finalBadgesCount[badgeId] = (finalBadgesCount[badgeId] || 0) + 1;
                            });
                        }
                    }
                }

                // --- ส่วนตรวจสอบรางวัลผู้เชี่ยวชาญ (Specialist Badge) ---
                // เราจะตรวจสอบเฉพาะแบบทดสอบหลักเท่านั้น (ไม่ใช่ข้อสอบซ่อม)
                 if (quizData.topic !== "แบบทดสอบซ่อมเสริม") {
                    totalMainQuizzes++; // นับจำนวนแบบทดสอบหลักทั้งหมด
                    if (submissionDoc.exists()) {
                        mainQuizzesSubmittedCount++;
                        const submissionData = submissionDoc.data();
                        if (submissionData.bestScore !== submissionData.totalQuestions) {
                            allQuizzesPerfect = false; // ถ้ามีข้อสอบหลักแม้แต่ชุดเดียวที่ไม่ได้คะแนนเต็ม ก็จะไม่ได้รางวัลนี้
                        }
                    } else {
                        allQuizzesPerfect = false; // ถ้ายังทำข้อสอบหลักไม่ครบ ก็จะไม่ได้รางวัลนี้
                    }
                }
            }

            // ตรวจสอบเงื่อนไขสุดท้ายสำหรับรางวัลผู้เชี่ยวชาญ
            if (totalMainQuizzes > 0 && mainQuizzesSubmittedCount === totalMainQuizzes && allQuizzesPerfect) {
                finalBadgesCount['specialist'] = 1;
            } else {
                finalBadgesCount['specialist'] = 0;
            }
            
            // 4. Update the student's profile with the newly calculated totals
            transaction.set(profileRef, {
                studentName: studentName,
                totalPoints: calculatedTotalPoints,
                unlockedBadges: Object.keys(finalBadgesCount).filter(key => finalBadgesCount[key] > 0),
                badgesCount: finalBadgesCount
            }, { merge: true });
        });

    } catch (error) {
        console.error("Leaderboard update transaction failed: ", error);
        showMessage("เกิดข้อผิดพลาดในการอัปเดตตารางผู้นำ");
    }
}


        function startAdminTest() {
            if (!currentQuizData) {
                showMessage("ไม่พบข้อมูลแบบทดสอบสำหรับทดลอง");
                return;
            }

            // Create a temporary, deep copy of the quiz data for the test.
            // This copy already contains the correct settings from the quiz itself.
            let testQuizData = JSON.parse(JSON.stringify(currentQuizData));
            
            currentMode = 'admin-testing';
            currentStudentName = 'ผู้ควบคุม (ทดสอบ)';

            adminView.classList.add('hidden');
            studentView.classList.remove('hidden');
            studentInitialView.classList.add('hidden');
            studentNameSelectionView.classList.add('hidden');
            studentResultArea.classList.add('hidden');
            studentQuizArea.classList.remove('hidden');
            
            quizStartTime = new Date(); // Record start time for admin test
            // Pass the quiz data to the display function.
            displayQuizForStudent(testQuizData);
        }

        function handleResultDisplay(displaySetting, score, points, earnedBadges, detailedAnswers, totalQuestions) {
    // ดึงค่าการตั้งค่าจากแบบทดสอบที่กำลังแสดงผลอยู่
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? Math.floor(totalQuestions / 2);
    const isAdaptive = currentDisplayedQuiz.settings?.isAdaptive ?? false;

    // --- ทางเข้าสู่โหมดปรับพื้นฐานอัตโนมัติ ---
    // ตรวจสอบว่าโหมดนี้เปิดใช้งานอยู่ และนักเรียนสอบไม่ผ่านหรือไม่
    if (isAdaptive && score < passingScore) {
        startAdaptiveFlow(detailedAnswers, score, totalQuestions); // เรียกใช้กระบวนการสอนซ่อมเสริม
        return; // จบการทำงานของฟังก์ชันนี้ทันที เพื่อไม่ให้ไปแสดงผลคะแนนปกติ
    }

    // --- Logic การแสดงผลคะแนนแบบเดิม ---
    // ถ้าไม่ได้อยู่ในโหมดปรับพื้นฐาน หรือนักเรียนสอบผ่าน ก็จะแสดงผลตามปกติ
    switch(displaySetting) {
        case 'show_results_and_answers':
            displayResultsWithAnswers(score, points, earnedBadges, detailedAnswers, totalQuestions);
            break;
        case 'show_results_only':
            displayResultsScoreOnly(score, points, earnedBadges, totalQuestions);
            break;
        case 'manual_release':
        default:
            displaySubmissionConfirmation();
            break;
    }
}
/**
 * เริ่มกระบวนการปรับพื้นฐานอัตโนมัติ (Adaptive Quiz Flow)
 * ฟังก์ชันนี้จะทำงานเมื่อนักเรียนทำแบบทดสอบไม่ผ่านเกณฑ์ในโหมดปรับพื้นฐาน
 * @param {Array} detailedAnswers - อาร์เรย์ของคำตอบโดยละเอียดของนักเรียน
 * @param {number} score - คะแนนที่นักเรียนทำได้
 * @param {number} totalQuestions - จำนวนคำถามทั้งหมด
 */
async function startAdaptiveFlow(detailedAnswers, score, totalQuestions) {
    // 1. รวบรวม "จุดอ่อน" จากคำอธิบายของข้อที่ตอบผิด
    // เราจะสร้างสตริงที่รวบรวมคำอธิบายทั้งหมด เพื่อส่งให้ AI วิเคราะห์
    const weaknessExplanations = detailedAnswers
        .map((ans, index) => ({ ...ans, originalQuestion: currentDisplayedQuiz.questions[index] }))
        .filter(item => !item.isCorrect && item.originalQuestion.explanation) // กรองเฉพาะข้อที่ผิดและมีคำอธิบาย
        .map(item => `- ${item.originalQuestion.explanation}`)
        .join('\n');

    // หากไม่มีคำอธิบายสำหรับข้อที่ผิดเลย ให้แสดงผลคะแนนตามปกติเพื่อป้องกันข้อผิดพลาด
    if (!weaknessExplanations) {
        displayResultsScoreOnly(score, 0, [], totalQuestions);
        return;
    }

    // แสดงหน้าต่างรอขณะที่ AI กำลังทำงาน
    studentQuizArea.classList.add('hidden');
    studentReadingArea.classList.remove('hidden');
    studentReadingArea.innerHTML = `
        <div class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">AI กำลังวิเคราะห์จุดอ่อนและสร้างเนื้อหาทบทวนให้คุณโดยเฉพาะ...</p>
        </div>
    `;

    // 2. สร้าง Prompt เพื่อให้ AI สรุปเนื้อหาสำหรับสอนซ่อมเสริม
    const remedialPrompt = `
        นักเรียนคนหนึ่งทำแบบทดสอบเรื่อง "${currentDisplayedQuiz.topic}" ไม่ผ่าน
        นี่คือคำอธิบายจากข้อที่นักเรียนตอบผิด:
        ${weaknessExplanations}

        จากข้อมูลข้างต้น โปรดสรุปเนื้อหาสำคัญเพื่อสอนซ่อมเสริมนักเรียนคนนี้
        ให้อธิบายด้วยภาษาที่เข้าใจง่าย เป็นกันเอง เหมือนติวเตอร์ใจดี
        สรุปมาเป็นย่อหน้าเดียวหรือสองย่อหน้าสั้นๆ

        ให้ผลลัพธ์เป็น JSON object ที่มี key ชื่อ "remedialContent" เท่านั้น
    `;

    // 3. กำหนด Schema สำหรับการตอบกลับของ AI
    const remedialSchema = {
        type: "OBJECT",
        properties: {
            remedialContent: { type: "STRING" }
        },
        required: ["remedialContent"]
    };

    try {
        // 4. เรียก API เพื่อสร้างเนื้อหาสอนซ่อมเสริม
        const result = await callAnalysisApi(remedialPrompt, remedialSchema);
        const remedialContent = result.remedialContent;

        // 5. แสดงเนื้อหาและปุ่มสำหรับทำข้อสอบซ่อม
        studentReadingArea.innerHTML = `
            <div class="p-6 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                <h3 class="text-xl font-bold text-amber-800">ทบทวนก่อนไปต่อนะ!</h3>
                <p class="mt-2 text-gray-700">${remedialContent.replace(/\n/g, '<br>')}</p>
                <button id="start-remedial-quiz-btn" class="mt-4 bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700">
                    เข้าใจแล้ว ลองอีกครั้ง!
                </button>
            </div>
        `;
        // 6. เพิ่ม Event Listener ให้กับปุ่มใหม่
        document.getElementById('start-remedial-quiz-btn').addEventListener('click', () => generateRemedialQuiz(weaknessExplanations));

    } catch (error) {
        console.error("Adaptive flow failed:", error);
        showMessage("เกิดข้อผิดพลาดในการสร้างเนื้อหาทบทวน");
        // หากเกิดข้อผิดพลาด ให้กลับไปแสดงผลคะแนนแบบปกติ
        displayResultsScoreOnly(score, 0, [], totalQuestions);
    }
}
async function generateRemedialQuiz(weaknessExplanations) {
    // แสดงสถานะกำลังโหลดให้นักเรียนทราบ
    studentReadingArea.innerHTML = `
        <div class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">เยี่ยมเลย! AI กำลังสร้างแบบทดสอบชุดใหม่เพื่อทบทวนความเข้าใจ...</p>
        </div>
    `;

    // 1. สร้าง Prompt เพื่อให้ AI สร้างข้อสอบซ่อม
    const remedialQuizPrompt = `
        จากหัวข้อเหล่านี้ที่นักเรียนยังไม่เข้าใจ:
        ${weaknessExplanations}

        โปรดสร้างแบบทดสอบปรนัยชุดใหม่จำนวน 2 ข้อ เพื่อทดสอบความเข้าใจในหัวข้อเหล่านี้โดยเฉพาะ
        แต่ละข้อต้องมี 4 ตัวเลือก, คำตอบที่ถูกต้อง, และคำอธิบายสั้นๆ

        ให้ผลลัพธ์เป็น JSON object ที่มีโครงสร้างดังนี้:
        - topic: (string) ตั้งชื่อหัวข้อว่า "แบบทดสอบซ่อมเสริม"
        - questions: (array of objects) โดยแต่ละ object มี:
          - questionText: (string)
          - options: (array of 4 strings)
          - correctAnswerIndex: (number)
          - explanation: (string)
    `;

    // 2. กำหนด Schema สำหรับการสร้างข้อสอบ (ใช้ mcqSchema ที่มีอยู่แล้วได้)
    const mcqSchema = {
        type: "OBJECT",
        properties: {
            questionText: { type: "STRING" },
            options: { type: "ARRAY", items: { type: "STRING" } },
            correctAnswerIndex: { type: "NUMBER" },
            explanation: { type: "STRING" }
        },
        required: ["questionText", "options", "correctAnswerIndex", "explanation"]
    };

    const remedialQuizSchema = {
        type: "OBJECT",
        properties: {
            topic: { type: "STRING" },
            questions: { type: "ARRAY", items: mcqSchema }
        },
        required: ["topic", "questions"]
    };

    try {
        // 3. เรียก API เพื่อสร้างข้อสอบซ่อม
        // เราจะใช้ฟังก์ชัน handleApiCall ที่มีอยู่แล้ว แต่ส่ง Prompt และ Schema ใหม่เข้าไป
        // และเนื่องจากเราไม่ต้องการให้ผลลัพธ์ไปแสดงในส่วนของผู้ควบคุม (admin) เราจึงต้องจัดการเอง
        const remedialQuizData = await callAnalysisApi(remedialQuizPrompt, remedialQuizSchema);
        remedialQuizData.isRemedial = true;

        // 4. เมื่อได้ข้อสอบชุดใหม่มาแล้ว ให้แสดงผลให้นักเรียนทำ
        studentReadingArea.classList.add('hidden'); // ซ่อนส่วนของเนื้อหาทบทวน
        
        // เราต้องแน่ใจว่าข้อสอบซ่อมนี้มี settings ที่เหมาะสม
        // โดยอาจจะคัดลอก settings บางอย่างมาจากข้อสอบเดิม แต่ปิดโหมด adaptive เพื่อไม่ให้วนซ้ำ
        const newQuizSettings = {
            ...currentDisplayedQuiz.settings,
            isAdaptive: false, // ปิดโหมดปรับพื้นฐานสำหรับข้อสอบซ่อม
            resultsDisplay: 'show_results_and_answers' // บังคับให้แสดงเฉลยหลังทำเสร็จ
        };
        remedialQuizData.settings = newQuizSettings;
        
        // เริ่มทำข้อสอบซ่อม
        displayQuizForStudent(remedialQuizData);

    } catch (error) {
        console.error("Remedial quiz generation failed:", error);
        showMessage("เกิดข้อผิดพลาดในการสร้างแบบทดสอบซ่อมเสริม");
        // หากล้มเหลว ให้กลับไปหน้าแรก
        showView('student');
    }
}
        function cancelAdminTest() {
            if (quizTimerInterval) clearInterval(quizTimerInterval);
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
            
            currentMode = 'admin'; // Reset mode
            studentView.classList.add('hidden');
            adminView.classList.remove('hidden');
            showView('project-detail'); // Go back to where the admin was
        }

        function setupResultScreenBackButton() {
    const backButtonId = 'back-from-results-btn';
    const isTesting = currentMode === 'admin-testing';

    const buttonText = isTesting
        ? '<i class="fas fa-arrow-left mr-2"></i>กลับไปหน้าจัดการโปรเจค'
        : '<i class="fas fa-home mr-2"></i>กลับไปหน้าแรก';

    // --- NEW: สร้าง HTML สำหรับกลุ่มปุ่มใหม่ ---
    const buttonsHTML = `
        <div class="mt-6 pt-6 border-t flex flex-col sm:flex-row items-center justify-center gap-4 w-full max-w-md mx-auto">
            <button id="view-rankings-btn" class="w-full sm:w-auto flex-1 bg-yellow-500 text-white py-3 px-4 rounded-lg font-semibold hover:bg-yellow-600 flex items-center justify-center gap-2">
                <i class="fas fa-trophy"></i>ดูอันดับ
            </button>
            <button id="${backButtonId}" class="w-full sm:w-auto flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                ${buttonText}
            </button>
        </div>
    `;

    // --- NEW: นำปุ่มไปต่อท้ายเนื้อหาทั้งหมด ---
    studentResultArea.insertAdjacentHTML('beforeend', buttonsHTML);

    // เพิ่ม Event Listeners ให้กับปุ่ม
    studentResultArea.querySelector('#view-rankings-btn').addEventListener('click', handleShowStudentRankings);
    document.getElementById(backButtonId).addEventListener('click', () => {
        if (isTesting) {
            currentMode = 'admin';
            studentView.classList.add('hidden');
            adminView.classList.remove('hidden');
            showView('project-detail');
        } else {
            showView('student');
            document.getElementById('quiz-id-input').value = '';
        }
    });
}

        function displayResultsWithAnswers(score, points, earnedBadges, detailedAnswers, totalQuestions) {
    const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? -1;
    const isRemedialQuiz = currentDisplayedQuiz.isRemedial === true;
    let passFailHTML = '';

    if (isRemedialQuiz || passingScore !== -1) {
        let isPass = isRemedialQuiz ? (score === totalQuestions) : (score >= passingScore);
        const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const resultText = isPass ? 'ผ่าน' : 'ไม่ผ่าน';
        passFailHTML = `<p class="text-2xl font-bold mt-2 px-4 py-1 rounded-full inline-block ${resultClass}">${resultText}</p>`;
    }

    let resultHTML = `
        <div class="text-center p-6 bg-indigo-100 rounded-lg mb-6">
            <p class="text-gray-600 mb-2">ผู้เข้าสอบ: <span class="font-semibold text-indigo-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-purple-700 mb-2">ผลการทดสอบ</h3>
            <p class="text-4xl font-bold my-2">${score} <span class="text-xl font-normal text-gray-600">/ ${totalQuestions}</span></p>
            ${passFailHTML}
            <p class="text-lg font-semibold text-blue-600 mt-2">+${points} Points</p>
            <p class="text-md">คุณได้คะแนน ${percentage.toFixed(0)}%</p>
            <div id="earned-badges-container" class="mt-4 flex justify-center gap-4 flex-wrap"></div>
        </div>
        <h4 class="text-xl font-bold mb-4">ทบทวนคำตอบ</h4>
    `;

    currentDisplayedQuiz.questions.forEach((q, index) => {
        const detailedAnswer = detailedAnswers[index];
        const userAnswer = detailedAnswer.answer;
        const isCorrect = detailedAnswer.isCorrect;
        const questionType = q.questionType || currentDisplayedQuiz.quizType;

        resultHTML += `
            <div class="mb-4 p-4 border rounded-lg ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}">
                <p class="font-semibold">${index + 1}. ${q.stem || q.questionText}</p>
                <div class="mt-3 space-y-2 text-sm">
        `;
        
        switch(questionType) {
            case 'matching_item':
                const userResponseText = userAnswer || 'ไม่ได้ตอบ';
                const correctResponseText = q.correctResponse;
                resultHTML += `<p><strong>คำตอบของคุณ:</strong> <span class="${!isCorrect ? 'line-through text-red-700' : ''}">${userResponseText}</span></p>`;
                if (!isCorrect) {
                    resultHTML += `<p class="text-green-700"><strong>คำตอบที่ถูกต้อง:</strong> ${correctResponseText}</p>`;
                }
                break;
            case 'short_answer':
                resultHTML += `<p><strong>คำตอบของคุณ:</strong> ${userAnswer || 'ไม่ได้ตอบ'}</p>`;
                resultHTML += `<p class="text-green-700"><strong>คำตอบที่เหมาะสม:</strong> ${q.idealAnswer}</p>`;
                break;
            case 'true_false':
                resultHTML += `<p class="${q.correctAnswer === true ? 'font-bold text-green-700' : ''} ${userAnswer === 'true' && !isCorrect ? 'line-through text-red-700' : ''}">ใช่</p>`;
                resultHTML += `<p class="${q.correctAnswer === false ? 'font-bold text-green-700' : ''} ${userAnswer === 'false' && !isCorrect ? 'line-through text-red-700' : ''}">ไม่ใช่</p>`;
                break;
            case 'fill_in_the_blank':
            case 'multiple_choice':
            default:
                resultHTML += q.options.map((opt, i) => {
                    let style = '';
                    let icon = '';
                    if (i === q.correctAnswerIndex) {
                        style = 'font-bold text-green-700';
                        icon = '<i class="fas fa-check-circle mr-2 text-green-600"></i>';
                    } else if (i === userAnswer) {
                        style = 'font-bold text-red-700 line-through';
                        icon = '<i class="fas fa-times-circle mr-2 text-red-600"></i>';
                    }
                    return `<div class="${style}">${icon}${opt}</div>`;
                }).join('');
                break;
        }

        resultHTML += `
                </div>
                <div class="mt-3 p-3 bg-blue-50 border-l-4 border-blue-400 text-sm">
                    <strong class="text-blue-800">คำอธิบาย:</strong> ${q.explanation || 'ไม่มีคำอธิบาย'}
                </div>
            </div>
        `;
    });
    
    studentResultArea.innerHTML = resultHTML;
    renderEarnedBadges(earnedBadges, 'earned-badges-container');
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');
    
    setupResultScreenBackButton();

    if (window.MathJax) window.MathJax.typesetPromise([studentResultArea]);
}

function displayResultsScoreOnly(score, points, earnedBadges, totalQuestions) {
    const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;

    // --- ส่วนที่แก้ไขและอัปเดต ---
    const passingScore = currentDisplayedQuiz.settings?.passingScore ?? -1;
    const isRemedialQuiz = currentDisplayedQuiz.isRemedial === true;
    let passFailHTML = '';

    // ตรวจสอบว่าจะแสดงผล "ผ่าน/ไม่ผ่าน" หรือไม่
    if (isRemedialQuiz || passingScore !== -1) {
        let isPass;

        // ใช้ตรรกะพิเศษสำหรับข้อสอบซ่อม (ต้องได้คะแนนเต็มเท่านั้นจึงจะผ่าน)
        if (isRemedialQuiz) {
            isPass = (score === totalQuestions);
        } else {
            // ใช้ตรรกะปกติสำหรับข้อสอบทั่วไป
            isPass = score >= passingScore;
        }

        const resultClass = isPass ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        const resultText = isPass ? 'ผ่าน' : 'ไม่ผ่าน';
        
        passFailHTML = `<p class="text-2xl font-bold mt-2 px-4 py-1 rounded-full inline-block ${resultClass}">${resultText}</p>`;
    }
    // --- สิ้นสุดส่วนที่แก้ไข ---

    let resultHTML = `
        <div class="text-center p-8 bg-indigo-100 rounded-lg">
            <i class="fas fa-award text-5xl text-indigo-500 mb-4"></i>
            <p class="text-gray-600 mb-2">ผู้เข้าสอบ: <span class="font-semibold text-indigo-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-indigo-800 mb-2">ส่งคำตอบเรียบร้อยแล้ว</h3>
            <p class="text-gray-700 mb-2">นี่คือคะแนนของคุณ:</p>
            <p class="text-5xl font-bold my-2">${score} <span class="text-2xl font-normal text-gray-600">/ ${totalQuestions}</span></p>
            ${passFailHTML}
            <p class="text-lg font-semibold text-blue-600 mt-2">+${points} Points</p>
            <p class="text-xl">คิดเป็น ${percentage.toFixed(0)}%</p>
            <div id="earned-badges-container" class="mt-4 flex justify-center gap-4 flex-wrap"></div>
        </div>
    `;
    studentResultArea.innerHTML = resultHTML;
    renderEarnedBadges(earnedBadges, 'earned-badges-container');
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');
    
    setupResultScreenBackButton();
}

        function displaySubmissionConfirmation() {
    let resultHTML = `
        <div class="text-center p-8 bg-green-100 rounded-lg">
            <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <p class="text-gray-600 mb-2">ผู้เข้าสอบ: <span class="font-semibold text-green-800">${currentStudentName}</span></p>
            <h3 class="text-2xl font-bold text-green-800 mb-2">ส่งคำตอบเรียบร้อยแล้ว</h3>
            <p class="text-gray-600">ผู้ควบคุมจะแจ้งผลคะแนนให้ทราบภายหลัง</p>

            <div class="mt-6 pt-6 border-t flex justify-center">
                <button id="back-to-home-manual-release" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2">
                    <i class="fas fa-home mr-2"></i>กลับไปหน้าแรก
                </button>
            </div>
        </div>
    `;
    studentResultArea.innerHTML = resultHTML;
    studentResultArea.classList.remove('hidden');
    studentQuizArea.classList.add('hidden');

    // เพิ่ม Event Listener ให้กับปุ่มที่สร้างขึ้นใหม่
    document.getElementById('back-to-home-manual-release').addEventListener('click', () => {
        showView('student');
        document.getElementById('quiz-id-input').value = '';
    });
}

        function renderEarnedBadges(badgeIds, containerId) {
            const container = document.getElementById(containerId);
            if (!container || !badgeIds || badgeIds.length === 0) return;

            let badgesHTML = '';
            badgeIds.forEach((badgeId, index) => {
                const badgeInfo = Object.values(BADGES).find(b => b.id === badgeId);
                if (badgeInfo) {
                    badgesHTML += `
                        <div class="badge-icon text-center p-2 bg-white rounded-lg shadow" style="animation-delay: ${index * 0.2}s;" title="${badgeInfo.description}">
                            <i class="fas ${badgeInfo.icon} text-3xl"></i>
                            <p class="text-xs font-semibold mt-1">${badgeInfo.name}</p>
                        </div>
                    `;
                }
            });
            container.innerHTML = badgesHTML;
        }

        // --- Presentation Mode Functions ---
        function startPresentation(quizData) {
            currentQuizData = getShuffledQuiz(quizData); // แก้เป็น quizData
            currentPresentationSlide = 0;
            presentationModal.style.display = 'flex'; // Use style to show
            renderPresentationSlide(currentPresentationSlide);
        }

        function closePresentation() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            presentationModal.style.display = 'none';
        }

        function renderPresentationSlide(index) {
            const container = document.getElementById('presentation-slide-container');
            if (!currentQuizData || !currentQuizData.questions || !currentQuizData.questions[index]) {
                container.innerHTML = `<p class="text-2xl">เกิดข้อผิดพลาด: ไม่พบข้อมูลคำถาม</p>`;
                return;
            }
            const question = currentQuizData.questions[index];
            const questionType = question.questionType || currentQuizData.quizType;
            
            container.innerHTML = ''; // Clear previous slide

            let slideHTML = `
                <div class="bg-white text-gray-800 p-6 md:p-12 rounded-2xl shadow-2xl w-full h-full max-h-[90vh] overflow-y-auto fade-in flex flex-col justify-center">
                    ${question.imageCode ? `<div class="my-4 flex justify-center">${question.imageCode}</div>` : ''}
                    <p class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-6 md:mb-12 leading-relaxed text-center">${index + 1}. ${question.stem || question.questionText}</p>
                    <div id="presentation-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 items-stretch justify-center">
            `;

            switch(questionType) {
                case 'matching_item':
                    slideHTML += question.allResponses.map((resp) => `
                        <button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center">
                            ${resp}
                        </button>
                    `).join('');
                    break;
                case 'true_false':
                    slideHTML += `<button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-answer="true">ใช่</button>`;
                    slideHTML += `<button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-answer="false">ไม่ใช่</button>`;
                    break;
                case 'fill_in_no_choices':
                case 'short_answer':
                     slideHTML += `
                        <div class="w-full md:col-span-2">
                            <textarea id="presentation-short-answer-input" class="w-full p-4 text-2xl border-2 border-gray-300 rounded-lg bg-white text-gray-800" rows="2" placeholder="พิมพ์คำตอบที่นี่..."></textarea>
                            <button id="check-presentation-answer-btn" class="mt-4 bg-blue-600 text-white py-3 px-6 rounded-lg text-xl hover:bg-blue-700">
                                <i class="fas fa-check"></i> ตรวจคำตอบ
                            </button>
                            <div id="presentation-ai-result" class="hidden mt-4 text-2xl font-bold"></div>
                        </div>
                    `;
                    break;
                case 'fill_in_the_blank':
                case 'multiple_choice':
                default:
                    slideHTML += question.options.map((opt, i) => `
                        <button class="presentation-option p-4 md:p-6 rounded-lg text-lg md:text-2xl border-4 border-gray-300 hover:bg-indigo-100 transition-all leading-normal flex items-center justify-center text-center" data-index="${i}">
                            ${opt}
                        </button>
                    `).join('');
                    break;
            }

            slideHTML += `
                    </div>
                    <div id="presentation-explanation" class="hidden mt-8 p-4 bg-blue-50 text-blue-800 rounded-lg text-left text-lg md:text-xl max-w-4xl mx-auto leading-relaxed">
                        <strong class="font-bold">คำอธิบาย:</strong> ${question.explanation || 'ไม่มีคำอธิบาย'}
                    </div>
                </div>
            `;
            
            container.innerHTML = slideHTML;
            if (window.MathJax) window.MathJax.typesetPromise([container]);

            document.querySelectorAll('.presentation-option').forEach(btn => {
                btn.addEventListener('click', (e) => revealAnswerForPresentation(index, e.currentTarget));
            });
            
            const checkBtn = document.getElementById('check-presentation-answer-btn');
            if (checkBtn) {
                checkBtn.addEventListener('click', () => checkShortAnswerForPresentation(index));
            }

            document.getElementById('slide-counter').textContent = `ข้อที่ ${index + 1} / ${currentQuizData.questions.length}`;
            document.getElementById('prev-question-btn').disabled = index === 0;
            document.getElementById('next-question-btn').disabled = index === currentQuizData.questions.length - 1;
        }
        
        async function checkShortAnswerForPresentation(questionIndex) {
    const question = currentQuizData.questions[questionIndex];
    const input = document.getElementById('presentation-short-answer-input');
    const checkBtn = document.getElementById('check-presentation-answer-btn');
    const resultContainer = document.getElementById('presentation-ai-result');
    const explanationContainer = document.getElementById('presentation-explanation');

    if (!input || !checkBtn || !resultContainer || !explanationContainer) return;

    const userAnswer = input.value.trim();
    if (userAnswer === '') {
        return;
    }

    checkBtn.disabled = true;
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังตรวจ...';
    input.disabled = true;

    // --- นี่คือบรรทัดที่ถูกแก้ไข ---
    // เปลี่ยนมาใช้ฟังก์ชันตรวจคำตอบตัวใหม่ที่ฉลาดขึ้น
    const isCorrect = await gradeShortAnswer(userAnswer, question);
    // -------------------------

    if (isCorrect) {
        resultContainer.innerHTML = '<span class="text-green-500"><i class="fas fa-check-circle"></i> ถูกต้อง</span>';
    } else {
        resultContainer.innerHTML = `<span class="text-red-500"><i class="fas fa-times-circle"></i> ไม่ถูกต้อง</span> (คำตอบที่คาดหวัง: ${question.idealAnswer})`;
    }
    
    resultContainer.classList.remove('hidden');
    explanationContainer.classList.remove('hidden');
    checkBtn.classList.add('hidden'); // ซ่อนปุ่มตรวจหลังจากตรวจแล้ว
}

        function revealAnswerForPresentation(questionIndex, selectedButton) {
            const question = currentQuizData.questions[questionIndex];
            const questionType = question.questionType || currentQuizData.quizType;
            
            document.querySelectorAll('.presentation-option').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-indigo-100');
                
                let isCorrect = false;
                if(questionType === 'multiple_choice' || questionType === 'fill_in_the_blank') {
                    const optionIndex = parseInt(btn.dataset.index);
                    isCorrect = optionIndex === question.correctAnswerIndex;
                } else if (questionType === 'true_false') {
                    const optionAnswer = btn.dataset.answer === 'true';
                    isCorrect = optionAnswer === question.correctAnswer;
                } else if (questionType === 'matching_item') {
                    isCorrect = btn.textContent.trim() === question.correctResponse;
                }

                if (isCorrect) {
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-700');
                } else {
                    btn.classList.add('opacity-50');
                }
            });
            
            selectedButton.classList.remove('opacity-50');

            let wasSelectionCorrect = false;
            if (questionType === 'multiple_choice') {
                wasSelectionCorrect = parseInt(selectedButton.dataset.index) === question.correctAnswerIndex;
            } else if (questionType === 'true_false') {
                wasSelectionCorrect = (selectedButton.dataset.answer === 'true') === question.correctAnswer;
            } else if (questionType === 'matching_item') {
                wasSelectionCorrect = selectedButton.textContent.trim() === question.correctResponse;
            }

            if (!wasSelectionCorrect) {
                selectedButton.classList.add('bg-red-500', 'text-white', 'border-red-700');
            }


            document.getElementById('presentation-explanation').classList.remove('hidden');
        }

        // --- Timer Functions ---
        function startWholeQuizTimer(durationInMinutes) {
            const timerContainer = document.getElementById('timer-container');
            if (!timerContainer) return;

            const endTime = Date.now() + durationInMinutes * 60 * 1000;
            timerContainer.innerHTML = `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                    <span class="font-semibold text-indigo-700">เวลาที่เหลือ:</span>
                    <span id="countdown-display" class="font-bold text-lg text-red-600">--:--</span>
                </div>
            `;
            const countdownDisplay = document.getElementById('countdown-display');

            quizTimerInterval = setInterval(() => {
                const remaining = endTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(quizTimerInterval);
                    countdownDisplay.textContent = "00:00";
                    showMessage("หมดเวลา! กำลังส่งคำตอบ...");
                    handleSubmitQuiz(null); // Auto-submit
                } else {
                    const minutes = Math.floor((remaining / 1000 / 60) % 60).toString().padStart(2, '0');
                    const seconds = Math.floor((remaining / 1000) % 60).toString().padStart(2, '0');
                    countdownDisplay.textContent = `${minutes}:${seconds}`;
                }
            }, 1000);
        }

        function renderPerQuestionView() {
    if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);
    
    const q = currentDisplayedQuiz.questions[currentQuestionIndex];
    const questionType = q.questionType || currentDisplayedQuiz.quizType;

    let html = `
        <div class="flex justify-between items-center mb-2">
            <p class="text-sm text-gray-500">คำถามที่ ${currentQuestionIndex + 1} จาก ${currentDisplayedQuiz.questions.length}</p>
            ${currentMode === 'admin-testing' ? '<button id="cancel-test-btn" class="text-sm text-gray-500 hover:text-red-600 font-semibold py-1 px-2 rounded-md hover:bg-red-50"><i class="fas fa-times-circle mr-1"></i> ยกเลิกการทดสอบ</button>' : ''}
        </div>
        <h3 class="text-xl font-bold mb-2 text-center">แบบทดสอบ: ${currentDisplayedQuiz.topic}</h3>
        
        <div id="per-question-timer-container" class="mb-4"></div>

        <div class="mb-6 p-4 border rounded-lg bg-gray-50">
            <div class="font-semibold mb-3" id="per-question-text">
            </div>
            <div class="space-y-2" id="per-question-options">
            </div>
        </div>
        <button id="next-question-timed-btn" class="w-full mt-4 bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700">
            <i class="fas fa-arrow-right mr-2"></i>
            ${currentQuestionIndex === currentDisplayedQuiz.questions.length - 1 ? 'ส่งคำตอบ' : 'คำถามถัดไป'}
        </button>
    `;
    studentQuizArea.innerHTML = html;
    
    let questionTextHTML = '';
    let optionsHTML = '';

    switch (questionType) {
        case 'matching_item':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.stem}`;
            optionsHTML = `
               <select name="question_single" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    <option value="">-- เลือกคำตอบ --</option>
                    ${q.allResponses.map(resp => `<option value="${resp}">${resp}</option>`).join('')}
                </select>
            `;
            break;
        case 'true_false':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = `
                <div><input type="radio" id="q_opt_true" name="question_single" value="true" class="mr-2 accent-indigo-600" required><label for="q_opt_true">ใช่</label></div>
                <div><input type="radio" id="q_opt_false" name="question_single" value="false" class="mr-2 accent-indigo-600" required><label for="q_opt_false">ไม่ใช่</label></div>
            `;
            break;
        case 'short_answer':
        case 'fill_in_no_choices':
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = `<textarea id="per-q-textarea" name="question_single_text" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="พิมพ์คำตอบของคุณที่นี่..."></textarea>`;
            break;
        case 'multiple_choice':
        case 'fill_in_with_choices':
        default:
            questionTextHTML = `${currentQuestionIndex + 1}. ${q.questionText}`;
            optionsHTML = q.options.map((opt, optionIndex) => `
                <div>
                    <input type="radio" id="q_opt${optionIndex}" name="question_single" value="${optionIndex}" class="mr-2 accent-indigo-600" required>
                    <label for="q_opt${optionIndex}">${opt}</label>
                </div>
            `).join('');
            break;
    }
    
    if (q.imageCode) {
        questionTextHTML += `<div class="my-4 flex justify-center">${q.imageCode}</div>`;
    }
    document.getElementById('per-question-text').innerHTML = questionTextHTML;
    document.getElementById('per-question-options').innerHTML = optionsHTML;

    if (currentMode === 'admin-testing') {
        const cancelBtn = document.getElementById('cancel-test-btn');
        if(cancelBtn) cancelBtn.addEventListener('click', cancelAdminTest);
    }

    document.getElementById('next-question-timed-btn').addEventListener('click', () => handleNextQuestionInTimedMode(false));
    if (window.MathJax) window.MathJax.typesetPromise([studentQuizArea]);

    startPerQuestionTimer();
}

        function startPerQuestionTimer() {
            const durationInSeconds = currentDisplayedQuiz.settings.timerDuration;
            const timerContainer = document.getElementById('per-question-timer-container');
            if (!timerContainer) return;

            let remainingTime = durationInSeconds;
            timerContainer.innerHTML = `
                <div id="timer-bar-container" class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="timer-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-center text-sm text-gray-600 mt-1">เหลือเวลา <span id="per-q-countdown">${remainingTime}</span> วินาที</p>
            `;
            const timerBar = document.getElementById('timer-bar');
            const countdownDisplay = document.getElementById('per-q-countdown');

            perQuestionTimerInterval = setInterval(() => {
                remainingTime--;
                const percentage = (remainingTime / durationInSeconds) * 100;
                timerBar.style.width = `${percentage}%`;
                countdownDisplay.textContent = remainingTime;

                if (remainingTime <= 0) {
                    clearInterval(perQuestionTimerInterval);
                    showMessage("หมดเวลาสำหรับข้อนี้!");
                    handleNextQuestionInTimedMode(true); // Auto-advance, true means skipped
                }
            }, 1000);
        }
        
        function handleNextQuestionInTimedMode(wasSkipped = false) {
            if (perQuestionTimerInterval) clearInterval(perQuestionTimerInterval);

            let selectedAnswer = null;
            if (!wasSkipped) {
                const currentQuestion = currentDisplayedQuiz.questions[currentQuestionIndex];
                const questionType = currentQuestion.questionType || currentDisplayedQuiz.quizType;

                if (questionType === 'short_answer' || questionType === 'fill_in_no_choices') {
                    const textArea = document.querySelector('#per-question-options textarea');
                    selectedAnswer = textArea ? textArea.value.trim() : "";
                } else if (questionType === 'matching_item') {
                    const select = document.querySelector('#per-question-options select');
                    selectedAnswer = select ? select.value : "";
                }
                else {
                    const checkedRadio = document.querySelector('input[name="question_single"]:checked');
                    if (checkedRadio) {
                        const value = checkedRadio.value;
                        selectedAnswer = !isNaN(parseInt(value, 10)) && value.trim() !== '' ? parseInt(value, 10) : value;
                    }
                }
            }
            
            studentAnswersPerQuestion.push(selectedAnswer);

            currentQuestionIndex++;

            if (currentQuestionIndex >= currentDisplayedQuiz.questions.length) {
                // Quiz finished
                finalizePerQuestionQuiz();
            } else {
                // Next question
                renderPerQuestionView();
            }
        }

        async function finalizePerQuestionQuiz() {
            const hasShortAnswer = currentDisplayedQuiz.questions.some(q => q.questionType === 'short_answer');
            if (hasShortAnswer) {
                showMessage("สิ้นสุดการทำแบบทดสอบ AI กำลังตรวจคำตอบอัตนัย...");
            } else {
                showMessage("สิ้นสุดการทำแบบทดสอบ กำลังส่งคำตอบ...");
            }
            // --- เพิ่มโค้ดส่วนนี้เข้าไป ---
const quizId = currentQuizData.id;
const submissionRef = doc(db, `artifacts/${appId}/public/data/quizzes/${quizId}/submissions`, currentStudentName);
const submissionSnap = await getDoc(submissionRef);
const existingData = submissionSnap.exists() ? submissionSnap.data() : {};
const previousAttempts = existingData.attempts || [];

// --- แก้ไขบรรทัดเดิมให้เป็นแบบนี้ ---
await processAndSubmitAnswers(studentAnswersPerQuestion, previousAttempts);
        }

        // --- Export Functions ---
        function getResultsFilename() {
            const quizTitle = document.getElementById('results-quiz-title').textContent.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            return `results_${quizTitle || 'quiz'}`;
        }

        function exportResultsAsImage() {
            const resultsTable = document.getElementById('results-table-container');
            showMessage("กำลังสร้างรูปภาพ...");
            html2canvas(resultsTable).then(canvas => {
                const link = document.createElement('a');
                link.download = `${getResultsFilename()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                messageModal.classList.add('hidden');
            });
        }

        function exportResultsAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Note: jsPDF has limited support for non-latin characters without custom fonts.
            // This will work for basic text but might not render Thai characters correctly.
            // For full Thai support, a font like 'Sarabun' would need to be embedded.
            doc.setFont('helvetica', 'normal'); 
            doc.autoTable({ html: '#results-table' });
            doc.save(`${getResultsFilename()}.pdf`);
        }

        function exportResultsAsWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.getElementById("results-table-container").innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `${getResultsFilename()}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        function exportResultsAsExcel() {
            const table = document.getElementById('results-table');
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    // Escape double quotes and wrap in double quotes
                    row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv.join('\n')], {type: 'text/csv;charset=utf-8;'}); // Add BOM for Excel
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvFile);
            link.download = `${getResultsFilename()}.csv`;
            link.click();
        }
		
		// --- Export Functions ---
        // OLD FUNCTION: function getResultsFilename() { ... }
        // เราจะไม่ใช้ฟังก์ชันนี้แล้ว สามารถลบทิ้งหรือคอมเมนต์เก็บไว้ได้

        // REFACTORED exportResultsAsImage to exportTableAsImage
        function exportTableAsImage(containerId, filename) {
            const element = document.getElementById(containerId);
            if (!element) {
                showMessage("ไม่พบตารางสำหรับ Export");
                return;
            }
            showMessage("กำลังสร้างรูปภาพ...");
            html2canvas(element).then(canvas => {
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                messageModal.classList.add('hidden');
            });
        }

        // REFACTORED exportResultsAsPDF to exportTableAsPDF
        function exportTableAsPDF(tableId, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('helvetica', 'normal'); 
            doc.autoTable({ html: `#${tableId}` });
            doc.save(`${filename}.pdf`);
        }

        // REFACTORED exportResultsAsWord to exportTableAsWord
        function exportTableAsWord(containerId, filename) {
            const element = document.getElementById(containerId);
            if (!element) {
                showMessage("ไม่พบตารางสำหรับ Export");
                return;
            }
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + element.innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = `${filename}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        // REFACTORED exportResultsAsExcel to exportTableAsExcel
        function exportTableAsExcel(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) {
                showMessage("ไม่พบตารางสำหรับ Export");
                return;
            }
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
                let row = [], cols = table.rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvFile);
            link.download = `${filename}.csv`;
            link.click();
        }

        // --- Analytics Rendering ---
        function renderAnalytics(quizData, submissions) {
            const totalStudents = currentProjectData.students.length;
            const submittedCount = submissions.length;
            const notSubmittedCount = totalStudents - submittedCount;
            const submissionRate = totalStudents > 0 ? (submittedCount / totalStudents) * 100 : 0;
            
            const scores = submissions.map(s => s.latestScore);
            const averageScore = scores.length > 0 ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
            const totalQuestions = quizData.questions.length;
            const averagePercentage = totalQuestions > 0 ? (averageScore / totalQuestions) * 100 : 0;

            // Render summary cards
            const summaryContainer = document.getElementById('analytics-summary-cards');
            summaryContainer.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-blue-700 font-semibold">อัตราการส่ง</p>
                    <p class="text-2xl font-bold text-blue-900">${submissionRate.toFixed(0)}%</p>
                    <p class="text-xs text-blue-600">(${submittedCount}/${totalStudents} คน)</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-green-700 font-semibold">คะแนนเฉลี่ย</p>
                    <p class="text-2xl font-bold text-green-900">${averageScore.toFixed(2)}</p>
                    <p class="text-xs text-green-600">(${averagePercentage.toFixed(0)}%)</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-yellow-700 font-semibold">คะแนนสูงสุด</p>
                    <p class="text-2xl font-bold text-yellow-900">${scores.length > 0 ? Math.max(...scores) : 'N/A'}</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <p class="text-sm text-red-700 font-semibold">คะแนนต่ำสุด</p>
                    <p class="text-2xl font-bold text-red-900">${scores.length > 0 ? Math.min(...scores) : 'N/A'}</p>
                </div>
            `;

            // Render charts
            const students = currentProjectData.students || [];
            renderSubmissionChart(submittedCount, notSubmittedCount, submissions, students);
            renderScoreDistributionChart(submissions, totalQuestions);
            renderQuestionAnalytics(quizData, submissions, students);
        }

        function renderSubmissionChart(submittedCount, notSubmittedCount, submissions, students) {
            const ctx = document.getElementById('submission-status-chart').getContext('2d');
            const submittedNames = submissions.map(s => s.studentName);
            const notSubmittedNames = students.filter(name => !submittedNames.includes(name));

            if (chartInstances.submission) {
                chartInstances.submission.destroy();
            }
            chartInstances.submission = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ส่งแล้ว', 'ยังไม่ส่ง'],
                    datasets: [{
                        data: [submittedCount, notSubmittedCount],
                        backgroundColor: ['#10B981', '#F59E0B'],
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                },
                                afterLabel: function(context) {
                                    let names;
                                    if (context.dataIndex === 0) { // Submitted
                                        names = submittedNames;
                                    } else { // Not Submitted
                                        names = notSubmittedNames;
                                    }
                                    return names.length > 0 ? names.join('\n') : 'ไม่มี';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderScoreDistributionChart(submissions, totalQuestions) {
            const ctx = document.getElementById('score-distribution-chart').getContext('2d');
            const scoreCounts = {};
            for (let i = 0; i <= totalQuestions; i++) {
                scoreCounts[i] = 0;
            }
            submissions.forEach(sub => {
                if (scoreCounts[sub.latestScore] !== undefined) {
                    scoreCounts[sub.latestScore]++;
                }
            });

            if (chartInstances.score) {
                chartInstances.score.destroy();
            }
            chartInstances.score = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(scoreCounts),
                    datasets: [{
                        label: 'จำนวนนักเรียน',
                        data: Object.values(scoreCounts),
                         backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            title: { display: true, text: 'คะแนน' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const score = context.label;
                                    const studentsWithScore = submissions
                                        .filter(s => s.latestScore == score)
                                        .map(s => s.studentName);
                                    return studentsWithScore.length > 0 ? studentsWithScore.join('\n') : '';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderQuestionAnalytics(quizData, submissions, students) {
    const container = document.getElementById('question-analytics-container');
    if (students.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">ยังไม่มีนักเรียนในโปรเจคเพื่อวิเคราะห์รายข้อ</p>';
        return;
    }

    let html = '';
    const submittedNames = submissions.map(s => s.studentName);

    quizData.questions.forEach((q, index) => {
        let correctCount = 0;
        const correctStudents = [];
        const incorrectStudents = [];
        const questionDisplayText = q.stem || q.questionText || q.instructions;

        submissions.forEach(sub => {
            // Use the latest attempt for analytics
            const latestAttempt = sub.attempts[sub.attempts.length - 1];
            if (latestAttempt && latestAttempt.answers) {
                
                // --- [การแก้ไขที่สำคัญ] ---
                // ค้นหาคำตอบจากข้อความของคำถาม แทนที่จะใช้ลำดับที่ (index)
                const studentAnswerForThisQuestion = latestAttempt.answers.find(ans =>
                    ans.originalQuestionText === questionDisplayText
                );

                if (studentAnswerForThisQuestion) {
                    if (studentAnswerForThisQuestion.isCorrect) {
                        correctCount++;
                        correctStudents.push(sub.studentName);
                    } else {
                        incorrectStudents.push(sub.studentName);
                    }
                }
            }
        });

        const unsubmittedStudents = students.filter(name => !submittedNames.includes(name));
        const correctRate = submissions.length > 0 ? (correctCount / submissions.length) * 100 : 0;

        html += `
            <details class="bg-gray-50 p-3 rounded-lg">
                <summary class="flex justify-between items-center cursor-pointer font-semibold">
                    <span class="w-3/4 truncate">ข้อ ${index + 1}: ${questionDisplayText}</span>
                     <div class="flex items-center gap-4">
                       <span class="text-sm font-normal px-2 py-1 rounded ${correctRate >= 70 ? 'bg-green-200 text-green-800' : correctRate >= 40 ? 'bg-yellow-200 text-yellow-800' : 'bg-red-200 text-red-800'}">
                           ตอบถูก ${correctRate.toFixed(0)}%
                       </span>
                       <i class="fas fa-chevron-right details-marker"></i>
                    </div>
                </summary>
                <div class="mt-3 pt-3 border-t text-sm space-y-2">
                    <p><strong>คำถาม:</strong> ${questionDisplayText}</p>
                    <p><strong>สถิติ:</strong> นักเรียน ${correctCount} จาก ${submissions.length} คนที่ส่ง ตอบถูก</p>
                    <div class="mt-2">
                        <p class="font-semibold text-green-700">ตอบถูก (${correctStudents.length} คน):</p>
                        <p class="text-xs text-gray-600 pl-2">${correctStudents.length > 0 ? correctStudents.join(', ') : 'ไม่มี'}</p>
                    </div>
                    <div class="mt-2">
                        <p class="font-semibold text-red-700">ตอบผิด (${incorrectStudents.length} คน):</p>
                        <p class="text-xs text-gray-600 pl-2">${incorrectStudents.length > 0 ? incorrectStudents.join(', ') : 'ไม่มี'}</p>
                    </div>
                    <div class="mt-2">
                        <p class="font-semibold text-gray-500">ยังไม่ส่ง (${unsubmittedStudents.length} คน):</p>
                        <p class="text-xs text-gray-600 pl-2">${unsubmittedStudents.length > 0 ? unsubmittedStudents.join(', ') : 'ไม่มี'}</p>
                    </div>
                </div>
            </details>
        `;
    });
    container.innerHTML = html;
    // Re-render MathJax for dynamically injected analytics content
    try {
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise([container]);
        }
    } catch (e) {
        console.error('MathJax typeset error (analytics):', e);
    }
}

        async function handleAnalyzeClass() {
    // ตรวจสอบว่ามีข้อมูลแบบทดสอบที่กำลังดูอยู่หรือไม่
    if (!currentQuizData || !currentQuizData.id) {
        showMessage("เกิดข้อผิดพลาด: ไม่พบข้อมูลแบบทดสอบปัจจุบัน");
        return;
    }

    const submissionsRef = collection(db, `artifacts/${appId}/public/data/quizzes/${currentQuizData.id}/submissions`);
    const submissionsSnapshot = await getDocs(submissionsRef);
    const submissions = submissionsSnapshot.docs.map(doc => doc.data());

    if (submissions.length < 2) {
        showMessage("ต้องมีนักเรียนส่งงานอย่างน้อย 2 คนขึ้นไป จึงจะสามารถวิเคราะห์ภาพรวมได้");
        return;
    }

    const analysisContainer = document.getElementById('strength-weakness-analysis-container');
    analysisContainer.innerHTML = `
        <div class="text-center py-8">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">AI กำลังวิเคราะห์ภาพรวม... อาจใช้เวลาสักครู่</p>
        </div>
    `;
    document.getElementById('analyze-strengths-btn').disabled = true;

    // สรุปข้อมูลคำตอบของนักเรียนทุกคนเพื่อส่งให้ AI
    const studentDataSummary = submissions.map((sub, index) => {
        const latestAttempt = sub.attempts[sub.attempts.length - 1];
        if (!latestAttempt) return ''; // ข้ามกรณีที่ไม่มีข้อมูลการทำข้อสอบ
        return `
            นักเรียนคนที่ ${index + 1} (${sub.studentName}):
            คะแนน: ${latestAttempt.score}/${sub.totalQuestions}
            คำตอบรายข้อ: ${JSON.stringify(latestAttempt.answers)}
        `;
    }).join('\n---\n');

    const analysisPrompt = `
        คุณคือนักวิเคราะห์การศึกษาผู้เชี่ยวชาญ ภารกิจของคุณคือการวิเคราะห์ภาพรวมของห้องเรียนจากข้อมูลการทำแบบทดสอบ

        แบบทดสอบเรื่อง: "${currentQuizData.topic}"
        ข้อมูลคำถามทั้งหมด: ${JSON.stringify(currentQuizData.questions)}

        นี่คือข้อมูลสรุปของนักเรียนในห้อง:
        ${studentDataSummary}

        จากข้อมูลทั้งหมด โปรดวิเคราะห์และสรุปผลออกมาเป็น JSON object ที่มีโครงสร้างดังนี้เท่านั้น:
        - classStrengths: จุดแข็งโดยรวมของห้องเรียนนี้ หรือคอนเซ็ปต์ที่นักเรียนส่วนใหญ่เข้าใจตรงกัน (array ของ string)
        - classWeaknesses: จุดอ่อนโดยรวม หรือความเข้าใจผิดที่พบบ่อยที่สุด (array ของ string)
        - teacherSuggestions: ข้อเสนอแนะเชิงปฏิบัติ 2-3 ข้อสำหรับครู เพื่อนำไปพัฒนาการสอนในครั้งต่อไป (array ของ string)

        ตอบเป็นภาษาไทยทั้งหมด
    `;

    const analysisSchema = {
        type: "OBJECT",
        properties: {
            classStrengths: { type: "ARRAY", items: { type: "STRING" } },
            classWeaknesses: { type: "ARRAY", items: { type: "STRING" } },
            teacherSuggestions: { type: "ARRAY", items: { type: "STRING" } }
        },
        required: ["classStrengths", "classWeaknesses", "teacherSuggestions"]
    };

    try {
        const analysisResult = await callAnalysisApi(analysisPrompt, analysisSchema);
        displayClassAnalysis(analysisResult);
    } catch (error) {
        console.error("Error during class analysis:", error);
        analysisContainer.innerHTML = `<div class="text-red-500 text-center"><p>ขออภัย, การวิเคราะห์ล้มเหลว: ${error.message}</p></div>`;
    } finally {
        document.getElementById('analyze-strengths-btn').disabled = false;
    }
}
function displayClassAnalysis(data) {
    const analysisContainer = document.getElementById('strength-weakness-analysis-container');
    if (!data) {
        analysisContainer.innerHTML = '<p class="text-center text-red-500">ไม่ได้รับข้อมูลการวิเคราะห์จาก AI</p>';
        return;
    }
    analysisContainer.innerHTML = `
        <div class="fade-in space-y-4 mt-4 border-t pt-4">
            <div>
                <h4 class="text-lg font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>จุดแข็งของห้องเรียน</h4>
                <ul class="list-disc list-inside space-y-1 bg-green-50 p-3 rounded-lg text-green-800">
                    ${data.classStrengths.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>จุดอ่อน / ความเข้าใจผิดที่พบบ่อย</h4>
                <ul class="list-disc list-inside space-y-1 bg-red-50 p-3 rounded-lg text-red-800">
                    ${data.classWeaknesses.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
             <div>
                <h4 class="text-lg font-semibold text-blue-700 mb-2"><i class="fas fa-chalkboard-teacher mr-2"></i>ข้อเสนอแนะสำหรับครู</h4>
                <ul class="list-disc list-inside space-y-1 bg-blue-50 p-3 rounded-lg text-blue-800">
                   ${data.teacherSuggestions.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
}
function formatAndPrintWorksheet(quizData, worksheetWindow) { 
    const worksheetHtml = `
        <!DOCTYPE html>
        <html lang="th">
        <head>
            <meta charset="UTF-8">
            <title>ใบงาน: ${quizData.topic}</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Sarabun', sans-serif; }
                @media print {
                    body { -webkit-print-color-adjust: exact; }
                    .no-print { display: none; }
                }
                .question-item { page-break-inside: avoid; }
                .answer-line {
                    border-bottom: 1px dotted black;
                    display: inline-block;
                    width: 80%;
                    margin-left: 1rem;
                }
            </style>
        </head>
        <body class="p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold">ใบงานเรื่อง: ${quizData.topic}</h1>
            </div>
            <div class="flex justify-between mb-8 text-lg">
                <p>ชื่อ: ....................................................................</p>
                <p>วันที่: ......./......./.........</p>
                <p>คะแนน: .................</p>
            </div>
            <div class="space-y-6">
                ${quizData.questions.map((q, index) => `
                    <div class="question-item">
                        <p class="text-lg font-semibold mb-2">${index + 1}. ${q.questionText}</p>
                        ${q.imageCode ? `<div class="my-2 flex justify-center">${q.imageCode}</div>` : ''}
                        <div class="mt-4">
                            <p><strong>ตอบ:</strong> <span class="answer-line"></span></p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </body>
        </html>
    `;
    worksheetWindow.document.write(worksheetHtml);
    worksheetWindow.document.close();
    worksheetWindow.onload = function() {
        worksheetWindow.print();
    };
}
async function generateWorksheet() {
    const topic = document.getElementById('worksheet-topic-input').value.trim();
    if (!topic) {
        showMessage("กรุณาป้อนหัวข้อสำหรับใบงาน");
        return;
    }

const worksheetWindow = window.open('', '_blank');
    worksheetWindow.document.write('<h1></h1>');
    
    const numQuestions = parseInt(document.getElementById('num-questions').value);
    const includeImages = document.getElementById('include-images-checkbox').checked;
    const imageInstruction = includeImages ? `สำหรับบางข้อ หากจำเป็น ให้สร้างโค้ด SVG ที่เกี่ยวข้องกับโจทย์ด้วย` : '';

    const prompt = `
        สร้างชุดคำถามสำหรับใบงานที่พิมพ์ได้ จำนวน ${numQuestions} ข้อ เกี่ยวกับหัวข้อ "${topic}". 
        คำถามควรเป็นแบบปลายเปิด, เติมคำ, หรือคำนวณ ที่นักเรียนสามารถเขียนคำตอบได้ 
        ${imageInstruction}

        ให้ผลลัพธ์เป็น JSON object ที่มีโครงสร้างดังนี้:
        - topic: ชื่อหัวข้อของใบงาน
        - questions: array ของ object คำถาม โดยแต่ละ object มี:
          - questionText: (string) ตัวคำถาม
          - imageCode: (string, optional) โค้ด SVG ถ้ามี
    `;

    const schema = {
        type: "OBJECT",
        properties: {
            topic: { type: "STRING" },
            questions: {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        questionText: { type: "STRING" },
                        imageCode: { type: "STRING" }
                    },
                    required: ["questionText"]
                }
            }
        },
        required: ["topic", "questions"]
    };

    document.getElementById('loader-text').textContent = 'AI กำลังสร้างใบงาน...';
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('quiz-generation-area').classList.remove('hidden');
    generateWorksheetBtn.disabled = true;

    try {
        const worksheetData = await callAnalysisApi(prompt, schema);
        formatAndPrintWorksheet(worksheetData, worksheetWindow);
    } catch (error) {
        console.error("Error generating worksheet:", error);
        if (worksheetWindow) worksheetWindow.close();
        showMessage("เกิดข้อผิดพลาดในการสร้างใบงาน");
    } finally {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('quiz-generation-area').classList.add('hidden');
        generateWorksheetBtn.disabled = false;
    }
}
async function callAnalysisApi(prompt, schema) {
    const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: schema
        }
    };
    const apiKey = "AIzaSyBgBJ28OshxBTnqUzCKsv7nve2Xj899fwA"; // Provided by environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) {
        throw new Error(`API call failed with status: ${response.status}`);
    }
    const result = await response.json();
    
    if (result.candidates?.[0]?.content?.parts?.[0]) {
        return JSON.parse(result.candidates[0].content.parts[0].text);
    } else {
        // --- ส่วนที่แก้ไข ---
        // ตรวจสอบสาเหตุที่ AI ไม่ส่งคำตอบกลับมา เพื่อให้แสดง Error ที่ชัดเจนขึ้น
        let detailedError = "Invalid response structure from AI.";
        
        // กรณีที่ Prompt ถูกบล็อกทั้งหมดก่อนการประมวลผล
        if (result.promptFeedback?.blockReason) {
            detailedError = `AI request was blocked. Reason: ${result.promptFeedback.blockReason}.`;
        
        // กรณีที่การสร้างคำตอบถูกหยุดกลางคัน (เช่น พบเนื้อหาไม่เหมาะสม)
        } else if (result.candidates?.[0]?.finishReason && result.candidates[0].finishReason !== "STOP") {
            detailedError = `AI generation finished with an issue. Reason: ${result.candidates[0].finishReason}.`;
        }
        
        console.error(detailedError, JSON.stringify(result));
        throw new Error(detailedError);
        // --- สิ้นสุดส่วนที่แก้ไข ---
    }
}
        // --- Init ---
        initialize();

    </script>
</body>
</html>
